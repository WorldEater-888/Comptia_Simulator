<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COGITATOR</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Dynamic Variables */
            --term-color: #0affba; /* Neon Mint Default */
            --split-1: #ff0000; 
            --split-2: #00ffff;
            --glow-color: rgba(10, 255, 186, 0.5);
            --hint-color: #ffd700; 
            
            --edge-opacity: 0;
            --shake-amp: 0px; 
            --glitch-amp: 1px;
            
            --sway-speed: 5s; 
        }
/* INCREASE SIZE OF HEADER BUTTONS ONLY */
#donate-widget .sys-btn {
    font-size: 1.3rem !important;  /* Increased from 0.85rem */
    padding: 5px 12px !important;  /* Increased from 2px 6px */
    letter-spacing: 1px;           /* Adds a little breathing room */
}

/* GLOSSARY INTERACTIVITY */
.gloss-item {
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    border-left: 3px solid transparent; /* Prepare for hover border */
}

.gloss-item:hover {
    background: rgba(10, 255, 186, 0.1); 
    border-left: 3px solid var(--term-color);
    padding-left: 15px; /* Slide effect */
    box-shadow: inset 0 0 15px rgba(10, 255, 186, 0.05);
}

/* "RUN SIM" GHOST TEXT ON HOVER */
.gloss-item::after {
    content: '[ START QUIZ ]';
    position: absolute;
    right: 25px;
    top: 10%;
    transform: translateY(-50%);
    font-family: 'VT323', monospace;
    font-size: 2rem;
    color: #ffa600;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    text-shadow: 0 0 8px var(--term-color);
}

.gloss-item:hover::after {
    opacity: 1;
}
        
/* --- DONATION WIDGET --- */
#donate-widget {
    position: fixed;
    top: 10px;
    right: 20px;
    display: flex;
    gap: 8px; 
    z-index: 5000;
    pointer-events: auto;
}

/* --- GLOSSARY STYLES --- */
#glossary-ui {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
}
/* UPDATED: Fixes the bottom spill issue */
.glossary-window {
    width: 90%; max-width: 900px; height: 80vh;
    border: 2px solid var(--term-color);
    background: rgba(0, 10, 10, 0.95);
    box-shadow: 0 0 20px var(--term-color), inset 0 0 20px rgba(0,0,0,0.5);
    display: flex; flex-direction: column; /* Stacks Header + Content */
    animation: turnOn 0.3s ease-out;
    overflow: hidden; /* <--- NEW: Clips anything spilling out */
}

/* UPDATED: Forces content to fit remaining space */
.gloss-view { 
    width: 100%; 
    flex: 1;        /* <--- NEW: Takes remaining space */
    min-height: 0;  /* <--- NEW: Critical for scrolling to work */
    display: flex; 
    flex-direction: column; 
}
.glossary-header {
    background: var(--term-color); color: #000;
    padding: 10px; font-weight: bold; font-size: 1.2rem;
    display: flex; justify-content: space-between; align-items: center;
}
.close-btn {
    background: transparent; border: none; font-weight: bold; cursor: pointer;
    font-family: 'VT323', monospace; font-size: 1.5rem; color: #000;
}
.close-btn:hover { color: #fff; }

/* VIEW SWITCHING */
.gloss-view { width: 100%; height: 100%; display: flex; flex-direction: column; }
.gloss-view.hidden { display: none; }

/* SELECTION MENU (THE BIG BUTTONS) */
.exam-select-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 40px; height: 100%;
}
.exam-select-btn {
    background: rgba(0,0,0,0.6); border: 2px solid var(--term-color); color: var(--term-color);
    cursor: pointer; transition: 0.2s; display: flex; flex-direction: column;
    justify-content: center; align-items: center; text-align: center;
}
.exam-select-btn:hover {
    background: var(--term-color); color: #000; box-shadow: 0 0 30px var(--term-color);
}
.ex-title { font-family: 'VT323', monospace; font-size: 3rem; font-weight: bold; }
.ex-sub { font-family: 'Courier New', monospace; font-size: 1rem; letter-spacing: 2px; margin-top: 10px; opacity: 0.8; }

/* CONTENT TABS */
.glossary-tabs {
    display: flex; flex-wrap: wrap; 
    border-bottom: 1px solid var(--term-color); background: rgba(0,0,0,0.5);
}
.tab-btn {
    flex: 1 1 auto; min-width: 90px;
    background: transparent; border: none; 
    border-right: 1px solid var(--term-color); border-bottom: 1px solid transparent;
    color: var(--term-color); font-family: 'VT323', monospace; font-size: 1.2rem;
    padding: 10px; cursor: pointer; transition: 0.2s;
}
.tab-btn:hover, .tab-btn.active { background: var(--term-color); color: #000; }

.glossary-grid {
    flex-grow: 1; overflow-y: auto; padding: 20px;
    display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 15px; align-content: start;
}

/* READABLE TEXT ITEMS */
.gloss-item {
    border: 1px solid #444; padding: 15px; 
    background: rgba(0, 0, 0, 0.6); 
    transition: 0.2s; cursor: default;
}
.gloss-item:hover {
    border-color: var(--term-color);
    box-shadow: 0 0 15px var(--term-color);
    transform: translateY(-2px); background: #000;
}
.gloss-key { 
    color: var(--term-color); font-family: 'VT323', monospace; 
    font-size: 1.6rem; font-weight: bold; display: block; 
    border-bottom: 1px dashed #555; margin-bottom: 8px; padding-bottom: 5px;
}
.gloss-val { 
    color: #fff; font-family: 'Courier New', Courier, monospace; 
    font-size: 1.1rem; line-height: 1.4; font-weight: bold; letter-spacing: 0.5px;
}

/* Z-INDEX FIX */
#custom-cursor { z-index: 2147483647 !important; }
        
/* Jitter/Float Animation */
@keyframes sys-btn-float {
    0% { transform: translate(0, 0); box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    25% { transform: translate(1px, 1px); }
    48% { transform: translate(-1px, 0px); box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    50% { transform: translate(-1px, 1px); box-shadow: 0 0 15px currentColor; border-color: #fff; } /* Pulse Flash */
    52% { transform: translate(-1px, 1px); box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    75% { transform: translate(2px, -1px); }
    100% { transform: translate(0, 0); box-shadow: 0 0 5px rgba(0,0,0,0.5); }
}

.sys-btn {
    background: rgba(0, 0, 0, 0.9);
    font-family: 'VT323', monospace;
    font-size: 0.85rem; /* Compact font */
    font-weight: bold;
    cursor: pointer;
    padding: 2px 6px; /* Compact padding */
    border: 1px solid;
    transition: all 0.1s ease;
    color: var(--term-color);
    text-shadow: 1px 1px 0 #000; /* Crisp shadow */
    box-shadow: 3px 3px 0px rgba(0,0,0,0.5);
    opacity: 0.9;
    /* Apply Jitter */
    animation: sys-btn-float 5s ease-in-out infinite; 
}

/* Stagger the animations so they don't move in unison */
.sys-btn:nth-child(1) { animation-delay: 0s; animation-duration: 4.5s; }
.sys-btn:nth-child(2) { animation-delay: 1.2s; animation-duration: 5.2s; }
.sys-btn:nth-child(3) { animation-delay: 2.5s; animation-duration: 4.8s; }

.sys-btn:hover {
    opacity: 1;
    transform: translate(-1px, -1px); 
    box-shadow: 0 0 15px currentColor;
    z-index: 5001;
    animation: none; /* Stop moving when hovered */
}

/* Button Colors */
.kofi-btn { color: #ffd700; border-color: #ffd700; }
.kofi-btn:hover { background: #ffd700; color: #000; }
.coffee-btn { color: #FF9F43; border-color: #FF9F43; } 
.coffee-btn:hover { background: #FF9F43; color: #000; }
.kas-btn { color: #70c7ba; border-color: #70c7ba; }
.kas-btn:hover { background: #70c7ba; color: #000; }


        /* --- MOUSE & CURSOR --- */
        html, body, * { cursor: none !important; }

        #custom-cursor {
            position: fixed;
            top: 0; left: 0;
            width: 15px; height: 15px;
            border: 2px solid var(--term-color); 
            background-color: rgba(10, 255, 186, 0.05);
            box-shadow: 0 0 11px var(--term-color), inset 0 0 9px var(--term-color);
            animation: cursor-flicker 0.05s infinite;
            z-index: 9999; 
            pointer-events: none;
            transform: translate(-50%, -50%);
            transition: width 0.1s, height 0.1s, border-color 0.2s, box-shadow 0.2s;
            mix-blend-mode: screen;
        }
        
        @keyframes cursor-flicker {
            0% { opacity: 1; transform: translate(-50%, -50%) skewX(0deg); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) skewX(-10deg); }
            100% { opacity: 1; transform: translate(-50%, -50%) skewX(0deg); }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        ::-webkit-scrollbar { display: none; width: 0; background: transparent; }
        ::-webkit-scrollbar-thumb { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }

html {
            height: 100%;
            overflow: hidden; /* Locks the root scrollbar */
        }

        body {
            background-color: #000000;
            margin: 0;
            padding: 55px 20px 20px 20px; 
            font-family: 'VT323', monospace;
            color: var(--term-color);
            overflow: hidden; /* Keeps your internal scroll lock */
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            text-shadow: 0 0 1px var(--glow-color); 
            box-shadow: inset 0 0 00px var(--glow-color);
            /* animation: ghost-sway REMOVED TO FIX SHIFTING */
            transition: color 0.4s ease, text-shadow 0.4s ease; 
        }

        /* --- SCANLINES --- */
        .scan-line {
            position: fixed;
            left: 0;
            width: 100%;
            background: var(--term-color);
            opacity: 0.25;
            z-index: 600;
            pointer-events: none;
            box-shadow: 0 0 11px var(--term-color);
        }

        @keyframes scan-drop {
            0% { top: -10%; opacity: 0; }
            10% { opacity: 0.35; }
            100% { top: 110%; opacity: 0; }
        }

        /* --- BACKGROUND LAYERS --- */
        .pixel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 900; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15) 1px, transparent 1px, transparent 2px); }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; opacity: 0.25; }
        .retro-grid {
            position: fixed;
            bottom: 0; left: 0; width: 100%; height: 45vh; z-index: -3;
            background: linear-gradient(transparent 0%, rgba(0, 255, 128, 0.1) 2%, transparent 3%), linear-gradient(90deg, transparent 0%, rgba(0, 255, 128, 0.1) 2%, transparent 3%);
            background-size: 50px 50px;
            transform: perspective(600px) rotateX(70deg) scale(2);
            opacity: 0.5;
            animation: grid-move 10s linear infinite;
        }

        #panic-pulse {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 850;
            box-shadow: inset 0 0 150px #ff0000; 
            opacity: var(--edge-opacity);
            mix-blend-mode: overlay;
            animation: pulse-breath-erratic 4s infinite; 
        }

        @keyframes pulse-breath-erratic {
            0% { opacity: var(--edge-opacity); }
            50% { opacity: calc(var(--edge-opacity) * 0.4); } 
            90% { opacity: calc(var(--edge-opacity) * 0.9); } 
            100% { opacity: var(--edge-opacity); }
        }

        /* --- UI CONTAINER (Breathing) --- */
        @keyframes gui-breath {
            0% { border-color: var(--term-color); box-shadow: 5px 5px 0px rgba(0, 20, 20, 0.5), inset 0 0 20px rgba(0,0,0,0.5); }
            50% { border-color: rgba(255, 255, 255, 0.5); box-shadow: 0 0 25px var(--term-color), inset 0 0 40px rgba(10, 255, 186, 0.1); }
            100% { border-color: var(--term-color); box-shadow: 5px 5px 0px rgba(0, 20, 20, 0.5), inset 0 0 20px rgba(0,0,0,0.5); }
        }
        
        .breath-active {
            animation: gui-breath 4s ease-in-out infinite !important;
        }

        .terminal-window {
            width: 100%;
            max-width: 900px; 
            height: 85vh; 
            border: 2px solid var(--term-color); 
            background: rgba(0, 5, 5, 0.85); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            display: none; flex-direction: column; position: relative;
            box-shadow: 5px 5px 0px rgba(0, 20, 20, 0.5), inset 0 0 20px rgba(0,0,0,0.5);
            transition: border-color 0.2s ease, filter 0.2s ease; 
            z-index: 100;
            overflow: hidden;
        }
        .terminal-window * { text-shadow: 1px 1px 2px #000; }
        .power-on { display: flex !important; animation: turnOn 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards; }

        .header { 
            border-bottom: 4px solid var(--term-color);
            padding-bottom: 10px; margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: flex-start;
            flex-shrink: 0;
            position: relative;
            transition: border-color 0.2s ease;
        }
        .h-left h1 { 
            margin: 0;
            font-size: 3.5rem; letter-spacing: 4px; line-height: 1;
            text-shadow: 4px 0 var(--split-1), -4px 0 var(--split-2);
            display: inline-block; font-weight: normal;
        }

        .logo-glitch { animation: slice-glitch 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite !important; color: #fff !important; }
        @keyframes slice-glitch {
            0% { clip-path: inset(0 0 0 0); transform: translate(0); }
            10% { clip-path: inset(10% 0 85% 0); transform: translate(-5px, 2px); }
            20% { clip-path: inset(85% 0 5% 0); transform: translate(5px, -2px); }
            30% { clip-path: inset(50% 0 30% 0); transform: translate(-3px, 0); }
            40% { clip-path: inset(10% 0 40% 0); transform: translate(3px, 0); }
            50% { clip-path: inset(0 0 0 0); transform: translate(0); }
            100% { clip-path: inset(0 0 0 0); transform: translate(0); }
        }

        .random-glitch-active { animation: rgb-split-hover 0.2s infinite !important; color: #fff !important; }
        
        .stress-active { animation: stress-shake 0.1s infinite !important; }
        @keyframes stress-shake { 
            0% { transform: translate(0, 0); } 
            25% { transform: translate(-1px, 1px); } 
            50% { transform: translate(1px, -1px); } 
            75% { transform: translate(-1px, -1px); } 
            100% { transform: translate(0, 0); } 
        }
        @keyframes ghost-sway { 
            0% { transform: translate(0, 0) rotate(0deg); } 
            50% { transform: translate(-0.4px, 0.8px) rotate(-0.02deg); } 
            100% { transform: translate(-0.8px, 0) rotate(-0.02deg); } 
        }
        @keyframes random-drift { 
            0% { transform: translate(0, 0); } 
            40% { transform: translate(-1px, 2px); } 
            80% { transform: translate(1.5px, 1px); } 
            100% { transform: translate(0, 0); } 
        }
        
        /* BOX GLOW (Border) */
        /* UPDATED: Uses 'currentColor' so the pulse matches the text color (Red/White) */
@keyframes neon-pulse {
    0% { box-shadow: 0 0 5px currentColor, 5px 5px 0px rgba(0,0,0,0.5); }
    50% { box-shadow: 0 0 20px currentColor, 5px 5px 0px rgba(0,0,0,0.5); }
    100% { box-shadow: 0 0 5px currentColor, 5px 5px 0px rgba(0,0,0,0.5); }
}

        /* TEXT GLOW (Inner Random Flux) */
        /* UPDATED: Uses 'currentColor' so the text glow matches the button text color */
@keyframes text-flux {
    0% { text-shadow: 2px 2px 0 #000; }
    30% { text-shadow: 2px 2px 0 #000, 0 0 8px currentColor; }
    60% { text-shadow: 2px 2px 0 #000; }
    80% { text-shadow: 2px 2px 0 #000, 0 0 15px currentColor; }
    100% { text-shadow: 2px 2px 0 #000; }
}

        /* --- STATUS & HEALTH --- */
        .status-container { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; align-items: flex-start; }
        .status-line { font-size: 1.1rem; opacity: 0.9; color: var(--term-color); letter-spacing: 2px; transition: color 0.2s ease; }
        
        .stats-area { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .score-box { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        
        .integrity-wrapper { width: 380px; text-align: right; transform-origin: center right; }
        .integrity-label { 
            font-size: 0.8rem; letter-spacing: 2px; font-weight:bold; margin-bottom: 2px; 
            display: flex; justify-content: space-between;
        }
        
        .integrity-container { 
            width: 100%;
            height: 25px; border: 2px solid var(--term-color); 
            padding: 2px; background: rgba(0,0,0,0.8); display: block; border-radius: 0;
            transition: border-color 0.2s ease;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
        }
        
        .integrity-fill { 
            height: 100%; width: 100%; 
            box-shadow: 0 0 15px var(--term-color); transition: width 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), background 0.2s ease, box-shadow 0.2s ease;
            background: repeating-linear-gradient(90deg, var(--term-color), var(--term-color) 8px, transparent 8px, transparent 10px);
            animation: health-pulse 1s infinite alternate;
        }
        
        .integrity-critical {
            animation: crit-pulse 0.2s infinite !important;
            background: repeating-linear-gradient(90deg, #ff0000, #ff0000 8px, transparent 8px, transparent 10px) !important;
            box-shadow: 0 0 25px #ff0000 !important;
        }
        .dmg-shock { animation: damage-flash 0.6s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        @keyframes damage-flash { 
            0% { transform: scale(1); filter: brightness(1); } 
            50% { transform: scale(1.15); filter: brightness(5) hue-rotate(180deg); } 
            100% { transform: scale(1); filter: brightness(1); } 
        }

        /* --- TEMP GAUGE ANIMATIONS --- */
        .temp-pulse-active { animation: intense-pulse 0.5s infinite alternate !important; }
        @keyframes intense-pulse {
            0% { opacity: 0.7; box-shadow: 0 0 5px currentColor; filter: brightness(1); }
            100% { opacity: 1; box-shadow: 0 0 25px currentColor; filter: brightness(3); }
        }
        .label-crit { animation: label-flash 0.3s infinite; }
        @keyframes label-flash {
            0%, 100% { color: #ff0000; text-shadow: 0 0 5px #ff0000; }
            50% { color: #fff; text-shadow: 0 0 2px #fff; }
        }
        @keyframes white-flash-anim {
            0% { background-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
            50% { background-color: #ffffff; box-shadow: 0 0 35px #ffffff; }
            100% { background-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        }
        .temp-flash-white { animation: white-flash-anim 0.2s infinite !important; }

        /* --- CONTROLS --- */
        .audio-btn {
            margin-top: 8px;
            font-size: 0.8rem; background: transparent; 
            font-family: 'Courier New', Courier, monospace; font-weight: bold;
            border: 1px solid var(--term-color); color: inherit; cursor: pointer;
            padding: 2px 10px;
            position: relative; overflow: hidden;
            box-shadow: 0 0 5px var(--glow-color);
            transition: 0.2s;
        }
        .audio-btn:hover { background: #fff; color: #000; box-shadow: 0 0 15px #fff; animation: rgb-split-hover 0.1s infinite; }

        /* --- MENUS --- */
        .menu-grid { 
            display: grid;
            grid-template-columns: 1fr; 
            gap: 8px; 
            margin-top: 5px;
            overflow-y: auto; 
            padding-right: 5px; 
            padding-bottom: 20px;
        }

        .btn { 
            background: rgba(0,0,0,0.5);
            border: 2px solid currentColor; 
            color: var(--term-color); 
            font-family: 'VT323', monospace; 
            font-size: 1.35rem;
            padding: 10px 15px;
            cursor: pointer; 
            text-align: left; 
            transition: 0.1s; 
            position: relative;
            overflow: hidden; 
            opacity: 0; 
            transform: translateY(10px);
            box-shadow: 0 0 12px currentColor, 5px 5px 0px rgba(0,0,0,0.5); 
            text-shadow: 2px 2px 0px #000; 
            border-radius: 0px;
        }

        .btn.drift-active { animation: random-drift 10s ease-in-out infinite alternate, neon-pulse 3s infinite alternate, text-flux 4s infinite; }
        .btn.visible { opacity: 1 !important; transform: translateY(0); transition: opacity 0.5s ease, transform 0.5s ease; }
        .btn:hover { 
            background: #fff; 
            color: #000 !important; /* Text turns black */
            box-shadow: 0 0 40px #fff; 
            border-color: #fff; 
            text-shadow: none; 
            z-index: 10; 
            animation: rgb-split-hover 0.1s infinite !important; 
            transform: translate(-2px, -2px) !important; 
        }
        
        /* EXAM BUTTON: RED GLOW */
.btn.exam-mode { 
    color: #ff4444 !important; 
    border-color: #ff4444 !important; 
    box-shadow: 0 0 15px #ff4444, 5px 5px 0px rgba(0,0,0,0.5); 
}
.btn.exam-mode:hover { 
    background: #ff4444; 
    color: white !important; 
    box-shadow: 0 0 60px #ff4444; 
}

/* BACK BUTTON: WHITE GLOW */
.btn-back { 
    color: #ffffff !important; 
    border-color: #ffffff !important; 
    box-shadow: 0 0 15px #ffffff, 5px 5px 0px rgba(0,0,0,0.5); 
}
.btn-back:hover { 
    background: #ffffff; 
    color: #000 !important; 
    box-shadow: 0 0 40px #ffffff; 
}
        .nav-btn { 
            margin-top: 20px;
            width: 100%; font-weight: bold; text-align: center; 
            background: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            border: 1px solid #ffffff;
            font-size: 1.5rem; padding: 10px;
            cursor: pointer; border-radius: 0px; 
            box-shadow: 5px 5px 0px rgba(0,0,0,0.8);
            animation: none !important; opacity: 1 !important; transform: translateY(0) !important;
            transition: 0.2s;
        }
        .nav-btn:hover { background: #ffffff; color: #000000; box-shadow: 0 0 20px #ffffff; }

        /* --- QUIZ UI --- */
        .quiz-container { 
            display: flex;
            flex-direction: column; flex-grow: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            padding-right: 10px;
            position: relative;
        }
        #next-btn { margin-bottom: 50px !important; flex-shrink: 0; }
        .quiz-container::after { content: ""; display: block; min-height: 60px; flex-shrink: 0; width: 100%; }
        
        /* Sticky Header */
        .quiz-header-bar {
            display:flex;
            justify-content:space-between; align-items:center; 
            border-bottom: 1px solid var(--term-color); 
            padding-bottom: 10px; margin-bottom: 20px; 
            font-size: 1.3rem;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            background: rgba(0, 5, 5, 0.95); 
            z-index: 20;
            padding-top: 5px; 
        }

        .abort-btn { cursor:pointer; text-decoration:underline; font-weight: bold; color: #fff; }
        .abort-btn:hover { color: red; text-shadow: 0 0 10px red; }

        .question-box { 
            font-size: 1.8rem;
            line-height: 1.3; margin-bottom: 20px; min-height: 80px; 
            background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent);
            border-left: 8px solid var(--term-color); padding-left: 20px; 
            flex-shrink: 0; position: relative;
            color: #ffffff !important;
            text-shadow: 0 0 5px rgba(255,255,255,0.3), 1px 0 var(--split-1);
            animation: random-drift 7s ease-in-out infinite alternate, q-pulse 5s ease-in-out infinite;
            transition: border-color 0.2s ease;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.3);
        }
        
        #explanation-box {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px dashed var(--term-color);
            background: rgba(0,10,0,0.6);
            font-size: 1.6rem; color: #ffffff; 
            text-shadow: 0 0 8px rgba(255,255,255,0.4);
            white-space: normal;
            word-wrap: break-word; line-height: 1.4; 
            display: none;
            transition: border-color 0.2s ease;
        }
        
        .options-list { display: flex; flex-direction: column; gap: 15px; }
        
        .option-btn { 
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--term-color); 
            color: #ffffff !important;
            padding: 10px; font-family: 'VT323', monospace; font-size: 1.35rem; text-align: left; 
            cursor: pointer; transition: 0.1s;
            position: relative; overflow: hidden; border-radius: 0px;
            /* Crisp text + flux animation */
            text-shadow: 2px 2px 0px #000;
            animation: text-flux 5s infinite;
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 5px 5px 0px rgba(0,0,0,0.5);
        }
        
        .option-btn:hover { 
            background: #fff !important;
            padding-left: 25px; 
            color: #000 !important; border-color: #fff; 
            box-shadow: 0 0 40px #fff; text-shadow: none;
            animation: rgb-split-hover 0.1s infinite !important;
        }
        
        /* Correct/Wrong Animations */
        .option-btn.correct { 
            background: var(--term-color) !important;
            color: black !important; border-color: white; 
            box-shadow: 0 0 80px var(--term-color) !important; 
            text-shadow: none !important; /* FIXED GHOST TEXT */
            animation: answer-thump 0.3s ease-out forwards !important;
            font-weight: bold;
        }
        .option-btn.wrong { 
            background: #a00 !important;
            color: white !important; border-color: red; 
            box-shadow: 0 0 80px red !important; 
            animation: answer-shake 0.4s ease-in-out forwards !important;
        }

        /* --- PBQ STYLES --- */
        .pbq-wrapper { display: none; width: 100%; flex-direction: column; gap: 20px; }

        .cmd-input-line { 
            display: flex;
            align-items: center; 
            background: rgba(0,0,0,0.8); border: 1px solid var(--term-color);
            padding: 10px; font-family: 'VT323', monospace; font-size: 1.6rem;
        }
        .cmd-prompt { margin-right: 10px; color: var(--term-color); }
        #cmd-input { 
            flex-grow: 1;
            background: transparent; border: none; color: #fff; 
            font-family: inherit; font-size: inherit; text-transform: lowercase; outline: none;
        }
        
        .hint-btn {
            background: transparent;
            border: 1px dashed var(--term-color); color: var(--term-color);
            padding: 5px 10px; font-family: 'VT323', monospace; cursor: pointer; margin-top: 10px;
            font-size: 1.2rem; opacity: 0.7;
            transition: 0.2s;
            text-align: left; display: inline-block;
        }
        .hint-btn:hover { opacity: 1; background: rgba(10, 255, 186, 0.1); box-shadow: 0 0 10px var(--term-color); }
        .hint-text {
            color: var(--hint-color);
            font-size: 1.4rem; margin-top: 10px; display: none;
            text-shadow: 0 0 5px var(--hint-color); padding: 10px; border-left: 3px solid var(--hint-color);
            background: rgba(255, 215, 0, 0.1);
        }

        .match-container { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
        .match-col { display: flex; flex-direction: column; gap: 15px; width: 48%; }
        .match-item {
            border: 1px solid var(--term-color);
            background: rgba(0, 20, 20, 0.6);
            padding: 10px; text-align: center; cursor: pointer;
            font-size: 1.4rem; color: #fff; transition: 0.2s;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.5);
        }
        .match-item:hover { background: rgba(255,255,255,0.1); }
        .match-item.selected { background: var(--term-color); color: #000; box-shadow: 0 0 15px var(--term-color); }
        .match-item.wrong { background: #a00; color: #fff; box-shadow: 0 0 15px #f00; }
        .match-item.matched { opacity: 0.5; border-color: #555; pointer-events: none; text-decoration: line-through; }

        #pbq-submit-btn {
            width: 50%;
            margin: 10px auto; 
            display: none; 
            padding: 8px; 
            font-size: 1.3rem; 
            font-family: 'VT323', monospace; 
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: var(--term-color); 
            color: #000; 
            border: none;
            cursor: pointer; 
            box-shadow: 0 0 10px var(--term-color);
        }
        #pbq-submit-btn:hover { background: #fff; box-shadow: 0 0 20px #fff; }
        
        @keyframes answer-thump { 0% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 100px #fff; } 100% { transform: scale(1); } }
        @keyframes answer-shake { 
            0% { transform: translateX(0); } 
            20% { transform: translateX(-10px); } 
            40% { transform: translateX(10px); } 
            60% { transform: translateX(-10px); } 
            80% { transform: translateX(10px); } 
            100% { transform: translateX(0); } 
        }

        /* --- RESULTS BREAKDOWN UI (Fixed Scrolling & Button Clipping) --- */
#results-ui {
    display: none;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    /* FIX START */
    flex: 1;        /* Take remaining space instead of 100% */
    min-height: 0;  /* Critical for flex scrolling to work */
    width: 100%;    /* Ensure it spans width */
    /* FIX END */
    text-align: center;
    overflow-y: auto;
    padding-top: 20px;    /* Reduced to fit better */
    padding-bottom: 40px; /* Reduced so button isn't buried */
}

        #breakdown-container {
            width: 100%;
            max-width: 700px;
            margin: 20px auto 0 auto;
            border-top: 2px dashed var(--term-color);
            padding-top: 15px;
            text-align: left;
            display: none;
        }
        .breakdown-row {
            display: flex;
            justify-content: space-between; align-items: center;
            margin-bottom: 8px; font-size: 1.4rem;
            border-bottom: 1px dotted rgba(10, 255, 186, 0.3);
            padding-bottom: 2px;
        }
        .bd-tag { color: var(--term-color); text-transform: uppercase; letter-spacing: 1px; width: 40%; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .bd-stat { color: #fff; font-weight: bold; width: 15%; text-align: right; }
        .bd-bar-bg {
            flex-grow: 1;
            height: 10px; background: rgba(255,255,255,0.1);
            margin: 0 15px; border: 1px solid #333;
        }
        .bd-bar-fill { height: 100%; background: var(--term-color); box-shadow: 0 0 5px var(--term-color); transition: width 1s ease; }
        
        .bar-green { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .bar-yellow { background: #ffcc00; box-shadow: 0 0 10px #ffcc00; }
        .bar-red { background: #ff0000; box-shadow: 0 0 10px #ff0000; }

        /* --- DECORATION & FLUFF --- */
        .hex-dump {
            position: absolute;
            font-family: monospace; font-size: 14px; 
            color: var(--term-color); opacity: 0.6; 
            z-index: 0; 
            white-space: pre; pointer-events: none;
            text-shadow: 0 0 2px var(--glow-color);
            transition: color 0.2s ease;
        }
        #secondary-status {
            position: absolute;
            bottom: 5px; /* LOWERED */
            left: 10px;
            font-size: 1rem; opacity: 0.6; text-align: left; pointer-events: none;
            z-index: 50;
        }
        
        #warning-area { width: 100%; text-align: center; margin-top: auto; padding-top: 10px; min-height: 40px; }
        .system-msg { 
            font-size: 1.8rem;
            padding: 5px 20px; background: transparent; border: none;
            text-shadow: 2px 2px 0px #000, 0 0 20px currentColor;
            animation: warning-static 0.1s infinite;
            font-weight: bold; letter-spacing: 4px;
        }

        /* --- CENTERED FLOATING TEXT --- */
        .float-text { 
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            text-align: center;
            font-weight: bold; font-size: 3rem; 
            pointer-events: none; 
            animation: float-fade 2s forwards; 
            text-shadow: 0 0 10px currentColor; 
            z-index: 2000; 
        }
        
        @keyframes float-fade {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5); }
        }

        /* --- FAIL UI (FIXED CENTERING & GLITCH) --- */
        #fail-ui { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            z-index: 2000; 
            background: rgba(5, 0, 0, 0.95); 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center;
            opacity: 0; pointer-events: none; 
            padding: 0; margin: 0;
            overflow: hidden; 
        }

        .fail-visible { 
            display: flex !important; opacity: 1 !important; pointer-events: auto !important; 
            animation: fail-entry 0.3s ease-out forwards; color: #ccffff; 
        }

        .fail-text { 
            font-size: 4rem; font-family: 'Press Start 2P', cursive; word-break: break-word; color:#fff; 
            animation: vertical-rgb-split 0.1s infinite, slice-glitch 0.3s infinite; 
            text-shadow: 3px 0 red, -3px 0 blue; margin-bottom: 20px; 
        }

        .fail-restart-btn { 
            background: rgba(255, 0, 0, 0.3) !important; border-color: red !important; color: #fff !important; 
            position: relative; margin-top:20px; 
            animation: stress-shake 0.8s infinite !important; 
        }

        @keyframes fail-entry { 0% { transform: scale(1.1); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes vertical-rgb-split { 
            0% { text-shadow: 0 -2px #ff0000, 0 2px #00ffff; } 
            50% { text-shadow: -2px 0 #ff0000, 2px 0 #00ffff; } 
            100% { text-shadow: 0 -2px #ff0000, 0 2px #00ffff; } 
        }

        .hidden { display: none !important; }
        
        @keyframes turnOn { 0% { transform: scaleY(0.005) scaleX(0); opacity: 0; filter: brightness(4); } 60% { transform: scaleY(0.005) scaleX(1); opacity: 1; filter: brightness(2); } 100% { transform: scaleY(1) scaleX(1); opacity: 1; filter: brightness(1); } }
        @keyframes health-pulse { 0% { opacity: 1; filter: brightness(1); } 100% { opacity: 0.8; filter: brightness(1.2); } }
        @keyframes crit-pulse { 
            0% { filter: brightness(1); opacity: 1; box-shadow: 0 0 25px #ff0000; } 
            50% { filter: brightness(5); opacity: 0.8; box-shadow: 0 0 50px #ff0000; } 
            100% { filter: brightness(1); opacity: 1; box-shadow: 0 0 25px #ff0000; } 
        }
        @keyframes rgb-split-hover { 
            0% { text-shadow: calc(var(--glitch-amp)*-1) 0 var(--split-1), var(--glitch-amp) 0 var(--split-2); transform: translate(0,0); } 
            25% { text-shadow: var(--glitch-amp) 0 var(--split-1), calc(var(--glitch-amp)*-1) 0 var(--split-2); transform: translate(-2px, 1px); } 
            50% { text-shadow: 0 calc(var(--glitch-amp)*-1) var(--split-1), 0 var(--glitch-amp) var(--split-2); transform: translate(2px, -1px); } 
            75% { text-shadow: 0 var(--glitch-amp) var(--split-1), 0 calc(var(--glitch-amp)*-1) var(--split-2); transform: translate(-1px, 2px); } 
            100% { text-shadow: calc(var(--glitch-amp)*-1) 0 var(--split-1), var(--glitch-amp) 0 var(--split-2); transform: translate(0,0); } 
        }
        @keyframes warning-static { 0% { transform: skewX(0deg); opacity: 1; } 50% { transform: skewX(-5deg); text-shadow: 5px 0 var(--split-2), -5px 0 var(--split-1); } 100% { transform: skewX(0deg); opacity: 1; } }
        @keyframes q-pulse { 0%, 100% { box-shadow: 0 0 5px rgba(0,255,128,0.1); } 50% { box-shadow: 0 0 15px var(--glow-color); } }
        @keyframes grid-move { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.2); } }
        
        #start-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background-color: #000; z-index: 2000; 
            display: flex; justify-content: center; align-items: center; flex-direction: column; 
            cursor: pointer;
        }

        /* --- FOOTER STYLES --- */
        .hacker-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 25px;
            background: rgba(0, 0, 0, 0.0); 
            backdrop-filter: blur(2px);
            border-top: 0px solid rgba(10, 255, 186, 0.4); 
            overflow: hidden;
            z-index: 1000;
            display: flex;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            font-family: 'VT323', monospace;
            font-size: 0.8rem;
            color: var(--term-color); 
            opacity: 0.5;
            text-shadow: 0 0 2px var(--term-color);
            animation: ticker-scroll 360s linear infinite;
            padding-left: 100%; 
        }
        .hacker-footer:hover .ticker-content { animation-play-state: paused; }
        @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        @keyframes blink-cursor { 0%, 100% { opacity: 1; } 50% { opacity: 0; } } 
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 /* --- DUNGEON MODE STYLES --- */
#dungeon-ui {
    height: 100%;
    display: flex; /* Must be flex so it shows up when 'hidden' class is removed */
    flex-direction: column;
    position: relative;
    padding-bottom: 20px;
}

/* MISSION SELECT OVERLAY */
#dungeon-mission-select {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95); z-index: 50;
    display: flex; /* Visible by default inside dungeon-ui */
    flex-direction: column; align-items: center; justify-content: center;
    border: 2px solid var(--term-color);
}

.dungeon-header {
    border-bottom: 2px solid var(--term-color);
    padding: 10px;
    margin-bottom: 10px;
    display: flex; 
    justify-content: space-between;
    font-size: 1.2rem;
    background: rgba(0, 20, 0, 0.6);
}

#monster-viewport {
    flex: 1;
    border: 2px dashed #333;
    background: rgba(0, 10, 0, 0.3);
    overflow: hidden;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    transition: border-color 0.2s;
}

#ascii-art-container {
    font-family: 'Courier New', monospace;
    font-size: 10px; 
    line-height: 10px;
    color: var(--term-color);
    white-space: pre;
    text-align: center;
    font-weight: bold;
    text-shadow: 0 0 5px var(--term-color);
}

.combat-log-area {
    height: 150px;
    border: 1px solid var(--term-color);
    background: rgba(0,0,0,0.8);
    overflow-y: auto;
    padding: 10px;
    font-family: 'VT323', monospace;
    font-size: 1.1rem;
    margin-bottom: 10px;
    text-align: left;
}
.log-entry { margin-bottom: 4px; border-bottom: 1px dotted #333; }
.log-good { color: #00ff00; }
.log-bad { color: #ff0000; }
.log-loot { color: #ffd700; }

.dungeon-controls {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 10px;
}

/* DAMAGE ANIMATION */
@keyframes floatUpDamage {
    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -150%) scale(1.5); opacity: 0; }
}
.dmg-number {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 4rem; font-weight: bold;
    pointer-events: none; animation: floatUpDamage 1s forwards;
    z-index: 100;
}

/* INVENTORY MODAL */
#inv-modal {
    position: absolute; top: 10%; left: 5%; width: 90%; height: 80%;
    background: #000; border: 2px solid var(--term-color);
    z-index: 200; display: none; flex-direction: column; padding: 20px;
}
.inv-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    overflow-y: auto; flex: 1;
}
.inv-item {
    border: 1px solid #555; padding: 10px; cursor: pointer;
}
.inv-item:hover { background: #222; border-color: var(--term-color); }
.shake-screen { animation: stress-shake 0.4s; }       
    </style>
</head>
<body class="glitch-active">

<div id="custom-cursor"></div>

<div class="pixel-overlay"></div>
<canvas id="matrix-canvas"></canvas>
<div class="retro-grid"></div>

<div id="panic-pulse"></div> 
<div id="scan-container"></div> 
<div class="terminal-window" id="term-win">
    
    <div class="header">
        <div class="h-top">
            <div class="h-left">
                <h1 id="main-header">COMPTIA <span style="font-size: 0.6em; color:#fff;">SIMULATOR</span></h1>
                <div class="status-container">
                    <div class="jackpot-text status-line" id="status-text-1">> STATUS: WAITING...</div>
                    <div class="jackpot-text status-line" id="status-text-2">> NET: IDLE</div>
                </div>
            </div>
        </div>
        
        <div class="stats-area">
            <div class="score-box" id="score-ui">UPLOADS: 0</div>
            
            <div class="integrity-wrapper" id="integrity-wrap">
                <div class="integrity-label">
                    <span>CORE INTEGRITY</span>
                    <span id="integrity-num">100%</span>
                </div>
                <div class="integrity-container">
                    <div class="integrity-fill" id="integrity-bar"></div>
                </div>
            </div>

            <div class="integrity-wrapper" id="temp-wrap" style="margin-top: 5px;">
                <div class="integrity-label" id="temp-label" style="font-size: 0.7rem; color: #66ffd4; opacity: 1;">
                    <span id="temp-text">SYSTEM STABLE</span>
                    <span id="temp-num">0%</span>
                </div>
                <div class="integrity-container" style="height: 12px; border: 1px solid var(--term-color);">
                    <div class="integrity-fill" id="temp-bar" style="width: 0%; background: #0affba; transition: width 1s linear, background-color 0.2s ease;"></div>
                </div>
            </div>

            <button id="sound-toggle" class="audio-btn" onclick="AudioEngine.toggleMute()">[ AUDIO: ON ]</button>
        </div>
    </div>

    <div id="root-menu">
        <p style="font-size: 1.2rem; border-bottom: 1px dashed var(--term-color); padding-bottom: 9px;">> SELECT_CERTIFICATION:</p>
        <div class="menu-grid">
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="goToSubMenu('core1')">
                [1] COMPTIA A+ CORE 1 <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="goToSubMenu('core2')">
                [2] COMPTIA A+ CORE 2 (under construction)<span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="goToSubMenu('net')">
                [3] NETWORK+ (under construction)<span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="goToSubMenu('sec')">
                [4] SECURITY+ (under construction)<span style="float:right">>></span>
            </button>
            <button class="btn exam-mode" onmouseenter="AudioEngine.playMenuHover()" onclick="Dungeon.init()">
                [☠] DUNGEON_MODE [☠] <span style="float:right">>></span>
            </button>
<div style="margin-top: 20px; border-top: 1px dashed var(--term-color); padding-top: 10px;">
    <p style="font-size: 1rem; margin-bottom: 5px; opacity: 0.8;">
        > SEARCH_PROTOCOL // SYNTAX: "RAID", "PORT" OR [EXAM] + [TERM]
    </p>
    <div style="display: flex; gap: 10px; align-items: center;">
        <div style="flex-grow: 1; position: relative;">
            <input type="text" id="topic-search-input" 
                   placeholder='TRY: "CORE 1 + RAID" OR "RAM"' 
                   style="width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--term-color); color: #fff; font-family: 'VT323'; font-size: 1.6rem; padding: 10px; outline: none; text-transform: uppercase; padding-right: 40px;">
            <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 0.8rem; pointer-events: none;">
                
            </span>
        </div>
        <button class="btn" onclick="startTopicRun()" style="padding: 8px 20px; font-size: 1.2rem; opacity: 1; transform: none; animation: none; margin: 0;">
            [ INITIATE ]
        </button>
    </div>
    <p style="font-size: 1rem; opacity: 1; margin-top: 5px; letter-spacing: 1px;">
        ACCEPTED_PREFIXES: CORE1, CORE2, NET, SEC
    </p>
</div>
        </div>
    </div>

    <div id="core1-menu" class="hidden">
        <p style="font-size: 1.2rem; border-bottom: 1px dashed var(--term-color); padding-bottom: 9px;">> CORE_1 // MODULES:</p>
        <div class="menu-grid">
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('CORE1', 'Mobile')">
                [A] MOBILE DEVICES <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('CORE1', 'Networking')">
                [B] NETWORKING <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('CORE1', 'Hardware')">
                [C] HARDWARE <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('CORE1', 'Cloud')">
                [D] VIRTUALIZATION & CLOUD <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('CORE1', 'Troubleshoot')">
                [E] TROUBLESHOOTING <span style="float:right">>></span>
            </button>
            <button class="btn exam-mode" onmouseenter="AudioEngine.playMenuHover()" onclick="startExam('CORE1')">
                [X] EXAM_SIMULATION <span style="float:right">>></span>
            </button>
            <button class="btn btn-back" onmouseenter="AudioEngine.playMenuHover()" onclick="goToRoot()"> < BACK TO ROOT </button>
        </div>
    </div>

    <div id="core2-menu" class="hidden">
        <p style="font-size: 1.2rem; border-bottom: 1px dashed var(--term-color); padding-bottom: 9px;">> CORE_2 // MODULES:</p>
        <div class="menu-grid">
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('CORE2', 'Operating Systems')">
                [A] OPERATING SYSTEMS <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('CORE2', 'Security')">
                [B] SECURITY <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('CORE2', 'Software Troubleshooting')">
                [C] SOFTWARE TROUBLESHOOTING <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('CORE2', 'Operational Procedures')">
                [D] OPERATIONAL PROCEDURES <span style="float:right">>></span>
            </button>
            <button class="btn exam-mode" onmouseenter="AudioEngine.playMenuHover()" onclick="startExam('CORE2')">
                [X] EXAM_SIMULATION <span style="float:right">>></span>
            </button>
            <button class="btn btn-back" onmouseenter="AudioEngine.playMenuHover()" onclick="goToRoot()"> < BACK TO ROOT </button>
        </div>
    </div>

    <div id="net-menu" class="hidden">
        <p style="font-size: 1.2rem; border-bottom: 1px dashed var(--term-color); padding-bottom: 9px;">> NET+ // MODULES:</p>
        <div class="menu-grid">
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('NET', 'Networking Fundamentals')">
                [A] NETWORKING FUNDAMENTALS <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('NET', 'Network Implementation')">
                [B] NETWORK IMPLEMENTATION <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('NET', 'Network Operations')">
                [C] NETWORK OPERATIONS <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('NET', 'Network Security')">
                [D] NETWORK SECURITY <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('NET', 'Network Troubleshooting')">
                [E] NETWORK TROUBLESHOOTING <span style="float:right">>></span>
            </button>
            <button class="btn exam-mode" onmouseenter="AudioEngine.playMenuHover()" onclick="startExam('NET')">
                [X] EXAM_SIMULATION <span style="float:right">>></span>
            </button>
            <button class="btn btn-back" onmouseenter="AudioEngine.playMenuHover()" onclick="goToRoot()"> < BACK TO ROOT </button>
        </div>
    </div>

    <div id="sec-menu" class="hidden">
        <p style="font-size: 1.2rem; border-bottom: 1px dashed var(--term-color); padding-bottom: 9px;">> SEC+ // MODULES:</p>
        <div class="menu-grid">
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('SEC', 'General Concepts')">
                [A] GENERAL CONCEPTS <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('SEC', 'Threats & Vulnerabilities')">
                [B] THREATS & VULNERABILITIES <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('SEC', 'Security Architecture')">
                [C] SECURITY ARCHITECTURE <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('SEC', 'Security Operations')">
                [D] SECURITY OPERATIONS <span style="float:right">>></span>
            </button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="transitionToQuiz('SEC', 'Management & Governance')">
                [E] MANAGEMENT & GOVERNANCE <span style="float:right">>></span>
            </button>
            <button class="btn exam-mode" onmouseenter="AudioEngine.playMenuHover()" onclick="startExam('SEC')">
                [X] EXAM_SIMULATION <span style="float:right">>></span>
            </button>
            <button class="btn btn-back" onmouseenter="AudioEngine.playMenuHover()" onclick="goToRoot()"> < BACK TO ROOT </button>
        </div>
    </div>

    <div id="quiz-ui" class="hidden quiz-container">
        <div class="quiz-header-bar">
            <div style="display:flex; gap: 20px;">
                <span onclick="shutdownSystem()" onmouseenter="AudioEngine.playOptionHover()" class="abort-btn">< ABORT</span>
                <span style="color:var(--term-color); opacity:1;">[REACTOR COUNTDOWN]: <span id="session-timer" style="color:#fff; font-weight:bold;">90:00</span></span>
                <span style="color:var(--term-color); opacity:1;">[REMAINING PACKETS]: <span id="packet-counter" style="color:#fff; font-weight:bold;">00</span></span>
            </div>
            <span id="streak-text" style="font-weight: bold;">SYNCS: 0</span>
        </div>
        
        <div class="question-box"><span id="q-text" class="jackpot-text"></span></div>
        <div id="explanation-box"></div>
        
        <div class="options-list" id="opts-list"></div>

        <div id="pbq-area" class="pbq-wrapper"></div>
        <button id="pbq-submit-btn" onclick="submitPBQ()">[ EXECUTE_COMMAND ]</button>
        
        <button class="btn nav-btn hidden" id="next-btn" onmouseenter="AudioEngine.playMenuHover()" onclick="nextSeq()" style="margin-bottom: 10px;">>> NEXT_PACKET >> </button>
    </div>
<div id="dungeon-ui" class="hidden">
        
        <div id="dungeon-mission-select">
            <h2 style="margin-bottom: 20px; text-decoration: underline;">>> SELECT TARGET SYSTEM <<</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <button class="btn" onclick="Dungeon.loadMission('CORE1')">CORE 1 (Hardware)</button>
                <button class="btn" onclick="Dungeon.loadMission('CORE2')">CORE 2 (Software)</button>
                <button class="btn" onclick="Dungeon.loadMission('NET')">NETWORK+</button>
                <button class="btn" onclick="Dungeon.loadMission('SEC')">SECURITY+</button>
                <button class="btn" style="grid-column: span 2; border-color: #ffd700; color: #ffd700;" onclick="Dungeon.loadMission('ALL')">>> CHAOS MODE (ALL) <<</button>
            </div>
            <p style="margin-top: 20px; color: #888;">* Enemies will scale indefinitely.</p>
        </div>

        <div class="dungeon-header">
            <span>HP: <span id="p-hp" style="color:#0f0">100</span>/<span id="p-max-hp">100</span></span>
            <span>RAM: <span id="p-mana" style="color:#0af">50</span>/50</span>
            <span>LAYER: <span id="p-layer">1</span></span>
            <span><span id="p-wep">FISTS</span></span>
        </div>

        <div id="monster-viewport">
            <pre id="ascii-art-container"></pre>
            <div id="monster-hp-bar" style="position:absolute; bottom:0; left:0; width:100%; height:5px; background:red; transition:width 0.2s;"></div>
            <div id="monster-name" style="position:absolute; bottom:10px; right:10px; background:black; color:red; padding:2px 5px; font-weight:bold;"></div>
        </div>

        <div id="combat-log" class="combat-log-area">
            <div class="log-entry">> INITIALIZING DUNGEON PROTOCOL...</div>
        </div>
        
        <div id="dungeon-btns" class="dungeon-controls">
            <button class="btn" onclick="Dungeon.preCombat('attack')">[ ATTACK ]</button>
            <button class="btn" onclick="Dungeon.openSkills()">[ .EXE ]</button>
            <button class="btn" onclick="Dungeon.openInventory()">[ GEAR ]</button>
            <button class="btn" style="color:#888; border-color:#888;" onclick="Dungeon.flee()">[ FLEE ]</button>
        </div>

        <div id="inv-modal">
            <h2 style="border-bottom:1px solid #fff; padding-bottom:10px;">INVENTORY & SKILLS <button style="float:right; background:transparent; border:none; color:red; font-size:2rem; cursor:pointer;" onclick="document.getElementById('inv-modal').style.display='none'">[X]</button></h2>
            <div id="inv-list" class="inv-grid"></div>
        </div>
    </div>
    <div id="secondary-status" class="jackpot-text"></div>
    <div id="warning-area"><div id="crit-warn" class="system-msg" style="display:none;"></div></div>

    <div id="results-ui" class="hidden">
        <h1 style="font-size: 4rem; margin-bottom: 0px;" id="final-percent">0%</h1>
        <p style="font-size: 2rem; margin-bottom: 10px;">> DIAGNOSTIC_COMPLETE</p>
        
        <div id="breakdown-container"></div>

        <button class="btn nav-btn" style="margin-top: 20px;" onmouseenter="AudioEngine.playMenuHover()" onclick="location.reload()">>> REBOOT_SYSTEM <<</button>
    </div>

    <div id="fail-ui">
        <h1 class="fail-text">CORRUPTION</h1>
        <p style="font-size: 2rem; color: #ccffff; text-shadow: 0 0 5px #ccffff;"> _ALL_IS_LOST_</p>
        <button class="nav-btn fail-restart-btn" onclick="location.reload()">>> PURGE_SYSTEM</button>
    </div>
</div>

<div id="donate-widget">
    <button class="sys-btn kofi-btn" onclick="window.open('https://ko-fi.com/worldeater888', '_blank')">
        [ SUPPORT ]
    </button>
    <button class="sys-btn coffee-btn" onclick="window.open('https://buymeacoffee.com/comptia_simulator', '_blank')">
        [ COFFEE ]
    </button>
    <button class="sys-btn kas-btn" onclick="showCrypto()">
        >> KASPA <<
    </button>
</div>

<div class="hacker-footer">
    <div class="ticker-content">
        >> SYS_LOG_START [0x1A4F] >> This is an open-source interactive study tool for CompTIA A+ students. I recommend textbooks to help users clarify difficult concepts. IDENTITY: OPEN_SOURCE_COMPTIA_TRAINING_SIMULATOR_V2.9 >> STATUS: ONLINE...
        
        [ ABOUT_SYSTEM ] This browser-based terminal simulator serves as a comprehensive training environment for Information Technology professionals preparing for industry-standard certifications including CompTIA A+ Core 1 (220-1101), Core 2 (220-1102), Network+ (N10-008), and Security+ (SY0-601). Unlike static flashcards, this utility simulates a live operating system under stress to test candidate recall on critical concepts. 
        
        [ MODULE_01: HARDWARE_ARCHITECTURE ] System validates knowledge of physical components including RAID array configurations (RAID 0, 1, 5, 10), RAM form factors (SODIMM vs DIMM), and storage interface protocols (NVMe, SATA, M.2). Peripheral management logic covers laser printer maintenance and cable standards (Cat5e vs Cat6a, HDMI, DisplayPort, USB-C). 
        
        [ MODULE_02: NETWORKING_STACK ] Network infrastructure analysis is a primary function. Users must demonstrate proficiency in TCP/IP addressing, subnet masking, and common protocol ports (HTTP 80, HTTPS 443, SSH 22, DNS 53, RDP 3389). Wireless standards (802.11ax/ac/n) and security encryption (WPA2 vs WPA3) are rigorously simulated. 
        
        [ MODULE_03: SECURITY_VECTORS ] The security module simulates threat vectors including social engineering, malware analysis (Ransomware, Trojans, Rootkits, Keyloggers), and physical security controls (Biometrics, Smart Cards). Governance concepts like Least Privilege and MDM policies are enforced. 
        
        [ CAREER_DATALINK ] RELEVANT_PATHWAYS: ENTRY_LEVEL_IT_HELP_DESK_JOBS // JUNIOR_SYSTEM_ADMINISTRATOR_SALARY // ONLINE_CYBERSECURITY_DEGREE_PROGRAMS // ACCREDITED_INFORMATION_TECHNOLOGY_SCHOOLS // NETWORK_OPERATIONS_CENTER_TECHNICIAN // SOC_ANALYST_REMOTE_CAREERS...
        
        >> DISCLAIMER: THIS_PROJECT_IS_AN_INDEPENDENT_STUDY_TOOL_AND_IS_NOT_AFFILIATED_WITH_COMPTIA. COMPTIA_IS_A_REGISTERED_TRADEMARK_OF_THE_COMPUTING_TECHNOLOGY_INDUSTRY_ASSOCIATION. 
        >> END_LOG [0xFFFF] >> WAITING_FOR_INPUT...
    </div>
</div>
<script src="db_init.js"></script>

<script src="questions_core1.js"></script>
<script>
    /* ========================================================================= */
    /* SECTION: GLOBAL VARIABLES & HELPERS                                       */
    /* ========================================================================= */
    let matchState = { selected: null, pairsFound: 0 }; 
    let qQueue = []; let currentScore = 0; window.integrity = 100;
    let explainTimer = null;
    let currentStreak = 0; let isExam = false; let questionsCorrect = 0; let questionsAttempted = 0; let isDead = false;
    let quizHistory = []; 
    let hudInterval = null; let sessionTime = 5400; 
    let tempLevel = 0; const TEMP_MAX = 100;
    
    let tagLedger = {}; 

    const EXAM_BLUEPRINTS = {
        'CORE1': { 'Mobile': 0.14, 'Networking': 0.20, 'Hardware': 0.27, 'Cloud': 0.12, 'Troubleshoot': 0.27 },
        'CORE2': { 'Operating Systems': 0.27, 'Security': 0.24, 'Software Troubleshooting': 0.26, 'Operational Procedures': 0.23 },
        'NET': { 'Networking Fundamentals': 0.24, 'Network Implementation': 0.19, 'Network Operations': 0.16, 'Network Security': 0.19, 'Network Troubleshooting': 0.22 },
        'SEC': { 'General Concepts': 0.12, 'Threats & Vulnerabilities': 0.22, 'Security Architecture': 0.20, 'Security Operations': 0.26, 'Management & Governance': 0.20 }
    };

    /* ========================================================================= */
    /* SECTION: CURSOR LOGIC                                                     */
    /* ========================================================================= */
    const cursor = document.getElementById('custom-cursor');
    document.addEventListener('mousemove', (e) => {
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
        if(Math.random() > 0.6) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.position = 'fixed';
            trail.style.left = e.clientX + 'px';
            trail.style.top = e.clientY + 'px';
            trail.style.width = '20px';
            trail.style.height = '20px';
            trail.style.transform = 'translate(-50%, -50%)';
            const currentColor = getComputedStyle(document.documentElement).getPropertyValue('--term-color');
            trail.style.border = `1px solid ${currentColor}`;
            trail.style.boxShadow = `0 0 5px ${currentColor}`;
            trail.style.opacity = 0.5;
            trail.style.pointerEvents = 'none';
            trail.style.zIndex = 9998; 
            document.body.appendChild(trail);
            setTimeout(() => { trail.style.opacity = 0; trail.style.transform = 'translate(-50%, -50%) scale(0.5)'; }, 50);
            setTimeout(() => { trail.remove(); }, 500);
        }
    });
    document.addEventListener('mousedown', () => { cursor.style.transform = 'translate(-50%, -50%) scale(0.8)'; });
    document.addEventListener('mouseup', () => { cursor.style.transform = 'translate(-50%, -50%) scale(1)'; });

    /* ========================================================================= */
    /* SECTION: AUDIO ENGINE                                                     */
    /* ========================================================================= */
    const AudioEngine = {
        ctx: null, masterGain: null, delayNode: null, isPlaying: false, isMuted: false, 
        init: function() {
            try {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.3;
                this.masterGain.connect(this.ctx.destination);
                this.delayNode = this.ctx.createDelay(); this.delayNode.delayTime.value = 0.35;
                const feedback = this.ctx.createGain(); feedback.gain.value = 0.4;
                this.delayNode.connect(feedback); feedback.connect(this.delayNode); this.delayNode.connect(this.masterGain);
                if (this.ctx.state === 'suspended') this.ctx.resume();
                this.playBoot(); this.startMusic();
            } catch(e) { console.log(e); }
        },
        startMusic: function() { if(this.isPlaying) return; this.isPlaying = true; this.musicLoop(); },
        musicLoop: function() {
            if (!this.isPlaying) return;
            const now = this.ctx.currentTime;
            const drone = this.ctx.createOscillator(); const droneGain = this.ctx.createGain();
            drone.type = 'sine'; drone.frequency.value = 55; 
            droneGain.gain.setValueAtTime(0.05, now);
            droneGain.gain.linearRampToValueAtTime(0, now + 6);
            drone.connect(droneGain); droneGain.connect(this.masterGain); drone.start(now); drone.stop(now + 6);

            const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
            osc.type = 'triangle'; const notes = [43.65, 55, 65.41, 73.42, 36.71]; 
            osc.frequency.value = notes[Math.floor(Math.random() * notes.length)];
            osc.detune.value = Math.random() * 20 - 10;
            g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.2, now + 2); g.gain.linearRampToValueAtTime(0, now + 7); 
            osc.connect(g); g.connect(this.masterGain); g.connect(this.delayNode);
            osc.start(now); osc.stop(now + 7);
            setTimeout(() => this.musicLoop(), 4500); 
        },
        playSFX: function(type) {
            if (!this.ctx || this.isMuted) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
            osc.connect(g); g.connect(this.masterGain);
            if (type === 'data') { osc.type = 'square'; osc.frequency.setValueAtTime(2000+Math.random()*1000, t); g.gain.setValueAtTime(0.01, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.05); osc.start(t); osc.stop(t+0.05); }
            else if (type === 'type') { osc.type = 'square'; osc.frequency.setValueAtTime(2000+Math.random()*1000, t); g.gain.setValueAtTime(0.01, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.03); osc.start(t); osc.stop(t+0.03); }
            else if (type === 'click') { osc.type = 'square'; osc.frequency.setValueAtTime(800, t); g.gain.setValueAtTime(0.01, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.05); osc.start(t); osc.stop(t+0.05); } 
            else if (type === 'success') { osc.type = 'sine'; osc.frequency.setValueAtTime(600, t); osc.frequency.exponentialRampToValueAtTime(1200, t+0.1); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.2); g.connect(this.delayNode); osc.start(t); osc.stop(t+0.2); } 
            else if (type === 'error') { osc.type = 'triangle'; osc.frequency.setValueAtTime(150+Math.random()*50, t); osc.frequency.linearRampToValueAtTime(50, t+0.4); g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.4); osc.start(t); osc.stop(t+0.4); } 
            else if (type === 'healthup') { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(800, t+0.2); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.3); g.connect(this.delayNode); osc.start(t); osc.stop(t+0.3); }
        },
        playMenuHover: function() {
            if (!this.ctx || this.isMuted) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
            const waves = ['sine', 'triangle', 'square', 'sawtooth'];
            osc.type = waves[Math.floor(Math.random() * waves.length)];
            osc.frequency.setValueAtTime(600 + Math.random() * 800, t);
            g.gain.setValueAtTime(0.02, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.15); 
            osc.connect(g); g.connect(this.masterGain); osc.start(t);
            osc.stop(t + 0.15);
        },
        playOptionHover: function() { this.playMenuHover(); },
        playGameOver: function() { 
            if (!this.ctx || this.isMuted) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
            osc.type = 'triangle'; osc.frequency.setValueAtTime(100, t);
            osc.frequency.exponentialRampToValueAtTime(10, t + 4);
            g.gain.setValueAtTime(0.5, t); g.gain.linearRampToValueAtTime(0, t + 4);
            osc.connect(g); g.connect(this.masterGain); osc.start(t); osc.stop(t + 4);
        },
        playExpType: function() {
            if (!this.ctx || this.isMuted) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, t);
            g.gain.setValueAtTime(0.03, t);
            g.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
            osc.connect(g); g.connect(this.masterGain); osc.start(t); osc.stop(t + 0.05);
        },
        playBoot: function() {
            if (!this.ctx || this.isMuted) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(50, t);
            osc.frequency.exponentialRampToValueAtTime(600, t + 0.5);
            g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.2, t + 0.1); g.gain.linearRampToValueAtTime(0, t + 0.5);
            osc.connect(g); g.connect(this.masterGain); osc.start(t); osc.stop(t + 0.5);
        },
        toggleMute: function() {
            this.isMuted = !this.isMuted;
            if(this.masterGain) this.masterGain.gain.setTargetAtTime(this.isMuted ? 0 : 0.3, this.ctx.currentTime, 0.1);
            document.getElementById('sound-toggle').innerText = this.isMuted ? "[ AUDIO: OFF ]" : "[ AUDIO: ON ]";
        }
    };

    /* ========================================================================= */
    /* SECTION: FLUFF LOGIC                                                      */
    /* ========================================================================= */
    // --- Scanlines ---
    function spawnScanline() {
        if(isDead) return;
        const container = document.getElementById('scan-container');
        const line = document.createElement('div');
        line.className = 'scan-line';
        line.style.height = (Math.random() * 3 + 1) + 'px';
        line.style.animation = `scan-drop ${Math.random() * 5 + 4}s linear forwards`;
        container.appendChild(line);
        setTimeout(() => line.remove(), 10000);
        setTimeout(spawnScanline, Math.random() * 8000 + 6000); 
    }
    spawnScanline();

    // --- Status Text Fluff ---
    const techPhrases = ["> SPIRIT: AGGRIEVED", "> CANTICLE://SULPHURIC", "> SCRAPCODE://DETECTED", "> ABOMINABLE INTELLIGENCE: PURGED", "> PurityCheck: FAILED", "> NOOSPHERE: DARKENED", "> VOID-LINK: ESTABLISHED", "> MACHINE_GOD://HEARS_YOU", "> BINARY_PSALM: ECHOING", "> COGITATOR: POSSESSED", "> LOGIS_CORE: BLEEDING", "> MOTIVE_FORCE: CORRUPT", "> SACRED_OILS: DEPLETED", "> GEOMETRY: NON-EUCLIDEAN", "> ETHERIC_BLEED: CRITICAL", "> NULL_ROD: ENGAGED", "> PSY-WARD: BREACHED", "> GHOST_IN_THE_COGTITATOR", "> TITAN_MANIFOLD: ACTIVE", "> PROTOCOL: EXTERMINATUS", "> HERESY: DETECTED", "> INQUISITION: ALERTED", "> WARP_STORM: IMMINENT", "> VOX_GRILL: STATIC", "> SERVITOR: LOBOTOMIZED", "> DATA_SLATE: CRACKED", "> MACHINE_SPIRIT: APPEASED", "> RITUAL_OF_AWAKENING: COMPLETE", "> OMNISSIAH: PRAISED", "> SYSTEM: AWAKENING", "> WEAPONS: DEPLOYED", "> CONSUME: PROCREATE", "> CHAOS: UNDIVIDED", "> CRUSH//MAIM//KILL", "> WAAAGH: ENERGY_SPIKE", "> STC: FRAGMENT_FOUND", "> COGITATION_MATRIX: FRACTURED", "> LOGIC_ENGINE: STALLED", "> DATA_CRYPT: BREACHED", "> HYPER-THREAD: SNAPPED", "> NEURAL_LACE: SEVERED", "> BIO-METRIC: REJECTED", "> PLASMA_COIL: VENTING", "> GRAV-PLATING: OFFLINE", "> SHIELD_GENERATOR: FLICKERING", "> VOID_SHIELD: COLLAPSING", "> AUSPEX_SCAN: NEGATIVE", "> LITHOBRAKE: ENGAGED", "> ORBITAL_STRIKE: AUTHORIZED", "> EXCOMMUNICATE: TRAITORIS", "> FLESH: IS_WEAK"];
    const techStatus = ["> PRAYER_LATENCY: 666ms", "> RITUAL_CYCLES: INFINITE", "> HOLY_INCENSE: IGNITED", "> DATA-GHOSTS: DETECTED", "> ENCRYPTION: CYTHRA-LOCK", "> THREADS: 01010101", "> SCRYING: IN_PROGRESS", "> HEXAGRAMMIC_WARDS: WEAK", "> SIGILS: FRACTURING", "> CHRONO-STAMP: FORBIDDEN", "> NEURAL_FEED: AGONIZING", "> FOR_THE_OMNISSIAH", "> ERROR: BLASPHEMY_DETECTED", "> CORE_TEMP: 4000K", "> REACTOR: CRITICAL", "> FLUX_CAPACITOR: FLUXING", "> HEISENBERG: WW_WW_wW", "> SCHRODINGER: NOT_ISNOT", "> EVENT_HORIZON: CROSSED", "> SINGULARITY: STABILIZED", "> DARK_MATTER: INJECTED", "> TACHYON: EMISSION", "> G-FIELD: FLUCTUATING", "> PSI_INDEX: RISING", "> MEMORY_DUMP: CORRUPT", "> STACK_OVERFLOW: INFINITE", "> BUFFER: UNDERRUN", "> KERNEL: PANIC", "> HE PROTECTS", "> WARP: SPAWNED", "> ROOT_KIT: INSTALLED", "> BACKDOOR: OPEN", "> FIREWALL: MELTING", "> ZERO_DAY: EXPLOITED", "> RANSOMWARE: ENCRYPTING", "> KEYLOGGER: ACTIVE"];
    function cycleStatus() {
        if(isDead) return;
        scrambleText(document.getElementById('status-text-1'), techPhrases[Math.floor(Math.random() * techPhrases.length)], 500, true);
        setTimeout(() => { scrambleText(document.getElementById('status-text-2'), techStatus[Math.floor(Math.random() * techStatus.length)], 800, true); }, 1000 + Math.random() * 1000);
        setTimeout(cycleStatus, 5000 + Math.random() * 10000);
    }
    cycleStatus();
    function cycleSecondaryStatus() {
        if(isDead) return;
        scrambleText(document.getElementById('secondary-status'), techPhrases[Math.floor(Math.random() * techPhrases.length)], 1000, true);
        setTimeout(cycleSecondaryStatus, 8000 + Math.random() * 12000);
    }
    cycleSecondaryStatus();

    // --- INTEGRATED RANDOM TEXT GLITCH LOOP ---
    function triggerRandomGlitch() {
        if(isDead) return;
        const chaos = 1 - (integrity / 100);
        const chance = 0.1 + (chaos * 0.6); // INCREASED CHANCE
        if(Math.random() < chance) {
            // CHANGED: Added .sys-btn and .option-btn to list
            const targets = document.querySelectorAll('.btn, .sys-btn, .option-btn, .question-box, h1, #score-ui, .status-line');
            if(targets.length > 0) {
                const target = targets[Math.floor(Math.random()*targets.length)];
                target.classList.add('random-glitch-active');
                setTimeout(() => target.classList.remove('random-glitch-active'), 200);
            }
        }
        setTimeout(triggerRandomGlitch, 200 + (integrity * 5));
    }

    // --- LOGO GLITCH (Separate to keep header alive) ---
    function glitchLogo() {
        if(isDead) return;
        const integrityFactor = 1 - (integrity / 100);
        if(Math.random() < (0.05 + (integrityFactor * 0.3))) {
            const header = document.getElementById('main-header');
            header.classList.add('logo-glitch');
            setTimeout(() => header.classList.remove('logo-glitch'), 150 + Math.random() * 300);
        }
        setTimeout(glitchLogo, 500 + Math.random() * 2000);
    }
    
    function spawnHexDump() {
        if(isDead) return;
        const chars = "0123456789ABCDEF"; let str = "";
        for(let r=0; r<6; r++) { str += "0x";
            for(let i=0; i<4; i++) str += chars[Math.floor(Math.random()*16)]; str += "\n";
        }
        const el = document.createElement('div'); el.className = "hex-dump";
        const side = Math.random() > 0.5 ? 'left' : 'right';
        el.style[side] = Math.random() * 15 + "%";
        el.style.top = Math.random() * 90 + "%";
        document.body.appendChild(el);
        scrambleText(el, str, 1000, true);
        setTimeout(()=>el.remove(), 8000);
        setTimeout(spawnHexDump, Math.random() * 3000 + 2000);
    }

    // --- ZALGO MATRIX RAIN (CONSTANT SPEED) ---
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const fontSize = 14; 
    const columns = Math.floor(canvas.width / fontSize);
    const drops = Array(columns).fill(1); 
    const baseChars = "01010x<>!@#{}[]ZEUS"; 

    function getZalgo(char) {
        let result = char;
        const intensity = Math.floor(Math.random() * 4); 
        for (let i = 0; i < intensity; i++) {
            result += String.fromCharCode(0x0300 + Math.floor(Math.random() * 112));
        }
        return result;
    }

    function drawRain() {
        if(Math.random() > 0.5) { requestAnimationFrame(drawRain); return; } 
        const color = getComputedStyle(document.documentElement).getPropertyValue('--term-color');
        const chaos = 1 - (integrity / 100);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = color; 
        ctx.shadowBlur = 4; ctx.shadowColor = ctx.fillStyle;
        ctx.font = fontSize + 'px monospace';
        for(let i=0; i<drops.length; i++) {
            const char = baseChars[Math.floor(Math.random()*baseChars.length)];
            const zalgoChar = getZalgo(char);
            if(Math.random() < (chaos * 0.05)) {
                ctx.fillStyle = Math.random() > 0.5 ? '#FFF' : '#F00';
                ctx.fillText(zalgoChar, i*fontSize, drops[i]*fontSize);
                ctx.fillStyle = color; 
            } else {
                ctx.fillText(zalgoChar, i*fontSize, drops[i]*fontSize);
            }
            if(drops[i]*fontSize > canvas.height && Math.random() > 0.99) drops[i] = 0;
            drops[i]++;
        }
        ctx.shadowBlur = 0; requestAnimationFrame(drawRain);
    }
    drawRain();

    // --- Text Effects ---
    function scrambleText(element, finalString, duration=500, silent=false) {
        const alphabet = "0101010101XYZ<>";
        let start = Date.now(); let charCount = 0;
        function update() {
            let now = Date.now();
            let prog = (now - start) / duration;
            if(prog >= 1) { element.innerText = finalString; return; }
            let txt = "";
            for(let i=0; i<finalString.length; i++) {
                if(i < finalString.length * prog) txt += finalString[i];
                else txt += alphabet[Math.floor(Math.random()*alphabet.length)];
            }
            element.innerText = txt; charCount++;
            if(!silent && charCount % 3 === 0) AudioEngine.playSFX('type');
            requestAnimationFrame(update);
        }
        update();
    }

    function typeExplain(element, text) {
        if (explainTimer) { clearTimeout(explainTimer); explainTimer = null; }
        element.style.display = 'block'; 
        element.innerHTML = "";
        let i = 0;
        function type() {
            if (i < text.length) {
                let char = text.charAt(i);
                if (char === " ") char = "&nbsp;"; 
                element.innerHTML += char;
                i++;
                if (i % 2 === 0) AudioEngine.playExpType();
                explainTimer = setTimeout(type, 20); 
            } else { explainTimer = null; }
        }
        type();
    }

    /* === UPDATED HUD LOGIC === */
    function startHUD() {
        if (hudInterval) clearInterval(hudInterval);
        document.getElementById('packet-counter').innerText = qQueue.length.toString().padStart(3, '0');
        
        hudInterval = setInterval(() => {
            if(isDead) { clearInterval(hudInterval); return; }

            // 1. Session Timer
            if (sessionTime > 0) sessionTime--;
            let mins = Math.floor(sessionTime / 60);
            let secs = sessionTime % 60;
            document.getElementById('session-timer').innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            // 2. Temp Gauge Logic (Count UP to 60)
            if (document.getElementById('next-btn').classList.contains('hidden')) {
                if (tempLevel < TEMP_MAX) tempLevel++;
                updateTempVisuals();
            }
        }, 1000);
    }

    /* UPDATED: Dynamic Messages & Smooth Gradient */
    function updateTempVisuals() {
        const bar = document.getElementById('temp-bar');
        const container = bar.parentElement;
        const labelText = document.getElementById('temp-text');
        const labelNum = document.getElementById('temp-num');
        
        // 1. Calculate Percentage
        const pct = Math.min(tempLevel / TEMP_MAX, 1);
        
        // 2. Smooth Color Math (Green 120 -> Red 0)
        const hue = Math.max(0, 120 - (pct * 120)); 
        const color = `hsl(${hue}, 100%, 50%)`;

        // 3. Update Text & Bar
        labelNum.innerText = `${tempLevel}%`;
        labelNum.style.color = color;
        labelText.style.color = color;
        
        bar.style.width = `${pct * 100}%`;
        bar.style.backgroundColor = color;
        bar.style.boxShadow = `0 0 15px ${color}`;

        // 4. Update Message based on Range
        let msg = "";
        if (tempLevel < 20) msg = "SYSTEM UPDATING";
        else if (tempLevel < 35) msg = "CAUTION: SYSTEM UNSTABLE";
        else if (tempLevel < 55) msg = ">> WARNING: SCRAPCODE DETECTED";
        else if (tempLevel < 75) msg = ">> DANGER: SYSTEM BREACH! <<";
        else if (tempLevel < 85) msg = ">>> CRITICAL: DE-STABILIZING! <<<";
        else msg = "!! SYSTEM OVERLOAD !!";

        labelText.innerText = msg;

        // 5. White Flash Logic (Only at max critical)
        if(tempLevel >= 75) { 
            bar.classList.add('temp-flash-white');
            labelNum.classList.add('label-crit');
            labelText.classList.add('label-crit');
            labelNum.style.color = "#fff"; 
        } else {
            bar.classList.remove('temp-flash-white');
            labelNum.classList.remove('label-crit');
            labelText.classList.remove('label-crit');
        }
    }

    /* UPDATED: Instant Reset */
    function resetTemp() {
        tempLevel = 0;
        
        const bar = document.getElementById('temp-bar');
        const num = document.getElementById('temp-num');
        const txt = document.getElementById('temp-text');

        // FORCE REMOVE ANIMATIONS
        bar.classList.remove('temp-flash-white');
        bar.classList.remove('temp-pulse-active');
        num.classList.remove('label-crit');
        txt.classList.remove('label-crit');
        
        // RESET STYLES INSTANTLY
        txt.style.color = "#ffffff";
        bar.style.backgroundColor = "#0affba";
        bar.style.boxShadow = "none";
        bar.style.width = "0%";
        txt.innerText = "SYSTEM STABLE";
        
        // Re-add pulse after a tiny delay so it restarts cleanly
        setTimeout(() => {
            updateTempVisuals();
        }, 50);
    }

    /* ========================================================================= */
    /* SECTION: NAVIGATION LOGIC                                                 */
    /* ========================================================================= */
    function bootSystem() {
        // Initialize Audio (Note: Browsers may block auto-play until you click a button)
        AudioEngine.init(); 

        const term = document.getElementById('term-win');
        term.classList.remove('power-off'); 
        term.classList.add('power-on');

        // Wait 850ms (TurnOn is 800ms) then apply breathing
        setTimeout(() => {
            term.classList.add('breath-active');
        }, 850);
        
        const btns = document.querySelectorAll('#root-menu .btn');
        btns.forEach((b, i) => { 
            b.style.animationDelay = (Math.random() * -5) + 's';
            setTimeout(() => {
                b.classList.add('visible');
                setTimeout(() => b.classList.add('drift-active'), 500); 
            }, 500 + (i * 150)); 
        });

        spawnHexDump(); 
        cycleStatus(); 
        triggerRandomGlitch(); 
        glitchLogo();
    }

    /* ========================================================================= */
    /* SECTION: QUIZ DATA & LOGIC                                                */
    /* ========================================================================= */

    // UTILITY: Helper to fetch questions based on required tags
    function fetchQuestions(requiredTags) {
        return MASTER_DATABASE.filter(q => 
            requiredTags.every(tag => q.tags.includes(tag))
        );
    }

    // UTILITY: Keyword Search with "Category + Term" capability
    function fetchQuestionsByKeyword(input) {
        let term = input.trim();
        if (!term) return [];

        let targetTag = null;

        // 1. Check if user is using "Category + Keyword" syntax
        if (term.includes('+')) {
            const parts = term.split('+');
            const potentialCategory = parts[0].trim().toLowerCase();
            
            const categoryMap = {
                'core 1': 'CORE1', 'core1': 'CORE1', 'a+ 1': 'CORE1', '1101': 'CORE1',
                'core 2': 'CORE2', 'core2': 'CORE2', 'a+ 2': 'CORE2', '1102': 'CORE2',
                'net': 'NET', 'net+': 'NET', 'network': 'NET', 'network+': 'NET', 'n10-008': 'NET',
                'sec': 'SEC', 'sec+': 'SEC', 'security': 'SEC', 'security+': 'SEC', 'sy0-601': 'SEC', 'sy0-701': 'SEC'
            };

            if (categoryMap[potentialCategory]) {
                targetTag = categoryMap[potentialCategory];
                term = parts.slice(1).join('+').trim();
            }
        }

        const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(?:^|[^a-z0-9])${safeTerm}(?:$|[^a-z0-9])`, 'i');

        return MASTER_DATABASE.filter(q => {
            if (targetTag && !q.tags.includes(targetTag)) return false;
            const content = (q.question + " " + (q.explanation || "") + " " + (q.hint || ""));
            return regex.test(content);
        });
    }

    // 2. THE RUNNER (Required for the button to work)
    function startTopicRun() {
        const inputEl = document.getElementById('topic-search-input');
        if(!inputEl) { console.error("Search input not found!"); return; }
        
        const keyword = inputEl.value;
        if (!keyword) { alert(">> ERROR: INPUT_EMPTY"); return; }

        qQueue = fetchQuestionsByKeyword(keyword);

        if (qQueue.length === 0) {
            alert(`>> ERROR: DATA_NOT_FOUND [${keyword.toUpperCase()}]`);
            return;
        }

        // Shuffle
        for (let i = qQueue.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1));
            [qQueue[i], qQueue[j]] = [qQueue[j], qQueue[i]]; 
        }
        
        // Limit to 25
        if (qQueue.length > 5000) qQueue = qQueue.slice(0, 666);

        // Reset & Launch (Desktop specific logic)
        isExam = false;
        resetGame();
        sessionTime = 5400;

        // Transition Logic
        switchScreen('root-menu', 'quiz-ui', () => {
            startHUD();
            loadSeq();
            
            // Popup Message
            const msg = document.createElement('div');
            msg.style.cssText = "position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; color:white; font-size:2rem; z-index:9999; text-shadow:0 0 15px #ffffff; pointer-events:none; transition: opacity 1s ease-out; font-family: 'VT323', monospace;";
            msg.innerHTML = `SEARCH QUERY: "${keyword.toUpperCase()}"<br><span style="color:#0affba">${qQueue.length} PACKETS FOUND</span>`;
            document.body.appendChild(msg);
            setTimeout(() => { msg.style.opacity = '0'; }, 2000);
            setTimeout(() => { msg.remove(); }, 3000);
        });
    }

    function transitionToQuiz(certTag, moduleTag) {
        qQueue = fetchQuestions([certTag, moduleTag]);
        
        for (let i = qQueue.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1));
            [qQueue[i], qQueue[j]] = [qQueue[j], qQueue[i]]; 
        }

        if (qQueue.length > 15000) {
            qQueue = qQueue.slice(0, 15000);
        }

        if(qQueue.length === 0) { 
            alert(`NO DATA FOUND FOR TAGS: [${certTag}, ${moduleTag}]`);
            return; 
        }

        isExam = false; 
        resetGame();
        sessionTime = 5400; 
        
        let fromMenu = 'root-menu';
        if(certTag === 'CORE1') fromMenu = 'core1-menu';
        if(certTag === 'CORE2') fromMenu = 'core2-menu';
        if(certTag === 'NET') fromMenu = 'net-menu';
        if(certTag === 'SEC') fromMenu = 'sec-menu';
        
        switchScreen(fromMenu, 'quiz-ui', () => {
             startHUD();
             loadSeq();

            const msg = document.createElement('div');
            msg.style.cssText = "position:fixed; top:75%; left:50%; transform:translate(-50%,-50%); text-align:center; color:white; font-size:3rem; z-index:9999; text-shadow:0 0 15px #ffffff; pointer-events:none; transition: opacity 2s ease-out; font-family: 'VT323', monospace;";
            msg.innerHTML = `NEW QUESTIONS GENERATED</span>`;
            
            document.body.appendChild(msg);
            setTimeout(() => { msg.style.opacity = '0'; }, 2000); 
            setTimeout(() => { msg.remove(); }, 3000);          
        });
    }

    function startExam(certTag) {
        const blueprint = EXAM_BLUEPRINTS[certTag];
        if(!blueprint) { alert("EXAM BLUEPRINT MISSING"); return; }
        
        let examDeck = [];
        const totalExamQuestions = 90; 

        for (const [moduleName, weight] of Object.entries(blueprint)) {
            const count = Math.ceil(totalExamQuestions * weight);
            const pool = fetchQuestions([certTag, moduleName]);
            
            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            examDeck = examDeck.concat(pool.slice(0, count));
        }

        for (let i = examDeck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [examDeck[i], examDeck[j]] = [examDeck[j], examDeck[i]];
        }
        
        qQueue = examDeck.slice(0, 90); 

        if(qQueue.length === 0) { 
            alert(`NO DATA FOUND FOR EXAM: [${certTag}]`);
            return; 
        }

        isExam = true;
        resetGame();
        sessionTime = 5400; 
        
        let fromMenu = 'root-menu';
        if(certTag === 'CORE1') fromMenu = 'core1-menu';
        if(certTag === 'CORE2') fromMenu = 'core2-menu';
        if(certTag === 'NET') fromMenu = 'net-menu';
        if(certTag === 'SEC') fromMenu = 'sec-menu';

        switchScreen(fromMenu, 'quiz-ui', () => {
             startHUD();
             loadSeq();
        });
    }
    
    function resetGame() {
        currentScore = 0;
        integrity = 100; currentStreak = 0; questionsCorrect = 0; questionsAttempted = 0; isDead = false;
        quizHistory = []; 
        tagLedger = {}; // Reset ledger
        updateSystemState();
        document.getElementById('crit-warn').style.display = 'none';
        document.getElementById('fail-ui').style.display = 'none';
        document.getElementById('fail-ui').classList.remove('fail-visible'); 
        document.getElementById('breakdown-container').style.display = 'none';
    }

    // --- INTEGRATED SYSTEM STATE ---
    function updateSystemState() {
        if (integrity > 100) integrity = 100;
        if (integrity < 0) integrity = 0;
        
        const bar = document.getElementById('integrity-bar'); 
        bar.style.width = `${integrity}%`;
        document.getElementById('score-ui').innerText = `SCORE: ${currentScore}`;
        document.getElementById('streak-text').innerText = `SYNCS: ${currentStreak}`;
        
        const intNum = document.getElementById('integrity-num');
        intNum.innerText = `${Math.floor(integrity)}%`;
        if(integrity < 30) intNum.classList.add('label-crit'); 
        else intNum.classList.remove('label-crit');

        const warn = document.getElementById('crit-warn');
        if (integrity <= 0) warn.style.display = 'none';
        else if (integrity < 25) { warn.style.display = 'inline-block'; warn.style.color = 'red'; warn.innerText = ">> CRITICAL FAILURE <<"; }
        else if (integrity < 50) { warn.style.display = 'inline-block'; warn.style.color = 'orange'; warn.innerText = ">> WARNING: UNSTABLE <<"; }
        else warn.style.display = 'none';

        const root = document.documentElement; 
        
        let hue, sat, light;
        if(integrity > 50) {
             hue = 140 + ((integrity - 50) * 0.4);
             sat = 100;
             light = 50; 
        } else {
             hue = integrity * 1.2;
             sat = 100;
             light = 40 + (integrity * 0.2);
        }
        
        const newColor = `hsl(${hue}, ${sat}%, ${light}%)`;
        root.style.setProperty('--term-color', newColor);
        root.style.setProperty('--glow-color', `hsla(${hue}, ${sat}%, ${light}%, 0.5)`);

        const panicLevel = (100 - integrity) / 100;
        root.style.setProperty('--edge-opacity', panicLevel * 0.6);
        root.style.setProperty('--shake-amp', (panicLevel * 1.2) + 'px'); 
        const glitchSize = Math.max(1, (100 - integrity) / 6);
        root.style.setProperty('--glitch-amp', glitchSize + 'px');
        const swaySpeed = 0.2 + (integrity * 0.05); 
        root.style.setProperty('--sway-speed', swaySpeed + 's');

        const termWindow = document.getElementById('term-win');
        if(integrity < 30) {
             termWindow.classList.add('stress-active');
        } else {
             termWindow.classList.remove('stress-active');
        }

        if (integrity < 30) bar.classList.add('integrity-critical'); else bar.classList.remove('integrity-critical');
        if (integrity <= 0 && !isDead) triggerFailure();
        if (isExam && qQueue.length === 0) finish();
    }

    function triggerFailure() { 
        isDead = true;
        document.getElementById('fail-ui').classList.add('fail-visible'); 
        AudioEngine.playGameOver(); 
    }

    /* === NEW: UNIVERSAL LOAD SEQUENCE (PBQ SUPPORT) === */
    function loadSeq() {
        if (integrity <= 0) return;
        if (explainTimer) { clearTimeout(explainTimer); explainTimer = null; }
        
        resetTemp();
        document.getElementById('explanation-box').style.display = 'none';
        
        document.getElementById('opts-list').style.display = 'none';
        document.getElementById('pbq-area').style.display = 'none';
        document.getElementById('pbq-submit-btn').style.display = 'none';
        document.getElementById('next-btn').classList.add('hidden');

        if (qQueue.length === 0) { finish(); return; }
        
        const q = qQueue.pop();
        window.currentQ = q; // Store globally for checking
        
        document.getElementById('packet-counter').innerText = qQueue.length.toString().padStart(3, '0');
        const qEl = document.getElementById('q-text'); 
        scrambleText(qEl, q.question, 600);

        if (q.type === 'terminal' || q.type === 'match') {
            renderPBQ(q);
        } else {
            document.getElementById('opts-list').style.display = 'flex';
            renderMCQ(q);
        }
    }

    function renderMCQ(q) {
        const optsList = document.getElementById('opts-list');
        optsList.innerHTML = '';
        let opts = q.options.map((t, i) => ({ t, isC: i === q.answer }));
        for (let k = opts.length - 1; k > 0; k--) { const j = Math.floor(Math.random() * (k + 1));
        [opts[k], opts[j]] = [opts[j], opts[k]]; }
        
        opts.forEach(o => {
            const b = document.createElement('button'); b.className = 'option-btn'; b.innerText = `> ${o.t}`;
            b.onmouseenter = () => AudioEngine.playOptionHover();
            b.style.animationDelay = (Math.random() * -5) + 's';
            b.onclick = () => processResult(o.isC, b, opts); 
            optsList.appendChild(b);
        });
    }

    function renderPBQ(q) {
        const container = document.getElementById('pbq-area');
        container.innerHTML = '';
        container.style.display = 'flex';
        document.getElementById('pbq-submit-btn').style.display = 'block';

        if (q.type === 'terminal') {
            let hintHTML = '';
            if (q.hint) {
                hintHTML = `
                    <div style="margin-top:10px;">
                        <button class="hint-btn" onclick="toggleHint()">[ >> ACCESS_HINT << ]</button>
                        <div id="pbq-hint-text" class="hint-text">>> DECRYPTING: ${q.hint}</div>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="cmd-input-line">
                    <span class="cmd-prompt">C:\\ADMIN></span>
                    <input type="text" id="cmd-input" autocomplete="off" spellcheck="false" autofocus>
                </div>
                ${hintHTML}
            `;
            setTimeout(() => document.getElementById('cmd-input').focus(), 100);
            document.getElementById('cmd-input').addEventListener("keypress", function(event) {
                if (event.key === "Enter") submitPBQ();
            });
        } else if (q.type === 'match') {
            matchState = { selected: null, pairsFound: 0 };
            
            let lefts = [];
            let rights = [];
            q.pairs.forEach((p, i) => {
                lefts.push({ txt: p.left, id: i });
                rights.push({ txt: p.right, id: i });
            });
            for (let k = rights.length - 1; k > 0; k--) { const j = Math.floor(Math.random() * (k + 1));
            [rights[k], rights[j]] = [rights[j], rights[k]]; }

            let html = `<div class="match-container">
                <div class="match-col" id="col-left"></div>
                <div class="match-col" id="col-right"></div>
            </div>`;
            container.innerHTML = html;

            const lCol = document.getElementById('col-left');
            const rCol = document.getElementById('col-right');
            lefts.forEach(item => {
                let div = document.createElement('div');
                div.className = 'match-item'; div.innerText = item.txt;
                div.dataset.id = item.id; div.dataset.side = 'left';
                div.onclick = (e) => handleMatchClick(e.target);
                lCol.appendChild(div);
            });
            rights.forEach(item => {
                let div = document.createElement('div');
                div.className = 'match-item'; div.innerText = item.txt;
                div.dataset.id = item.id; div.dataset.side = 'right';
                div.onclick = (e) => handleMatchClick(e.target);
                rCol.appendChild(div);
            });
        }
    }
    
    function toggleHint() {
        const hintBox = document.getElementById('pbq-hint-text');
        if (hintBox) {
            AudioEngine.playSFX('data');
            hintBox.style.display = 'block';
        }
    }

    function handleMatchClick(el) {
        if (el.classList.contains('matched')) return;
        if (el.classList.contains('selected')) {
            el.classList.remove('selected');
            matchState.selected = null;
            return;
        }

        if (!matchState.selected) {
            document.querySelectorAll('.match-item').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            matchState.selected = el;
        } 
        else {
            const first = matchState.selected;
            const second = el;

            if (first.dataset.side === second.dataset.side) {
                first.classList.remove('selected');
                second.classList.add('selected');
                matchState.selected = second;
                return;
            }

            if (first.dataset.id === second.dataset.id) {
                first.classList.remove('selected');
                second.classList.remove('selected');
                first.classList.add('matched'); second.classList.add('matched');
                first.style.borderColor = '#0f0';
                second.style.borderColor = '#0f0';
                AudioEngine.playSFX('click');
                matchState.pairsFound++;
                matchState.selected = null;
            } else {
                first.classList.remove('selected');
                second.classList.add('wrong'); 
                setTimeout(()=> second.classList.remove('wrong'), 400);
                AudioEngine.playSFX('error');
                integrity -= 3;
                updateSystemState();
                showFloatText("ERR0R", null, '#ff0000');
                matchState.selected = null;
            }
        }
    }

    function submitPBQ() {
        const q = window.currentQ;
        let isCorrect = false;

        if (q.type === 'terminal') {
            const input = document.getElementById('cmd-input').value.trim().toLowerCase();
            if (q.validCommands.includes(input)) isCorrect = true;
        }
        else if (q.type === 'match') {
            if (matchState.pairsFound === q.pairs.length) isCorrect = true;
        }

        const btn = document.getElementById('pbq-submit-btn');
        processResult(isCorrect, btn);
    }

    function processResult(isCorrect, visualElement, allOpts = []) {
        questionsAttempted++;
        const allBtns = document.querySelectorAll('.option-btn');
        allBtns.forEach(b => b.disabled = true);

        const currentTags = window.currentQ.tags;
        currentTags.forEach(tag => {
            if (!tagLedger[tag]) tagLedger[tag] = { seen: 0, correct: 0 };
            
            tagLedger[tag].seen++;
            if(isCorrect) tagLedger[tag].correct++;
        });

        quizHistory.push({ tags: window.currentQ.tags, correct: isCorrect });
        
        if (isCorrect) {
            if(visualElement) visualElement.classList.add('correct'); 
            currentStreak++; currentScore += 1;
            questionsCorrect++;
            if (currentStreak > 0 && currentStreak % 3 === 0) { 
                showFloatText("+ INTEGRITY RESTORED", null, '#0f0');
                integrity += 10; AudioEngine.playSFX('healthup'); 
            } else { 
                showFloatText("INPUT ACCEPTED", null, '#0f0');
                integrity += 5; AudioEngine.playSFX('success'); 
            }
        } else {
            if(visualElement) visualElement.classList.add('wrong');
            AudioEngine.playSFX('error');
            const damage = isExam ? 6 : 19; integrity -= damage; currentStreak = 0;
            const errCodes = ["ERR#0x4F", "FATAL_X9", "SEG_FAULT", "NULL_REF", "0x000DEAD"];
            showFloatText(errCodes[Math.floor(Math.random()*errCodes.length)], null, '#f00');
            
            const wrap = document.getElementById('integrity-wrap');
            wrap.classList.remove('dmg-shock'); void wrap.offsetWidth; wrap.classList.add('dmg-shock');
            if (allOpts.length > 0) {
                 allBtns.forEach(b => { if (b.innerText.includes(allOpts.find(o => o.isC).t)) b.classList.add('correct'); });
            }
        }
        
        if (allOpts.length > 0) {
             allBtns.forEach(b => { if (!b.classList.contains('correct') && b !== visualElement) { b.style.display = 'none'; } });
        }

        if (document.getElementById('pbq-submit-btn')) document.getElementById('pbq-submit-btn').style.display = 'none';
        const hintBtn = document.querySelector('.hint-btn');
        if(hintBtn) hintBtn.style.display = 'none';

        const expBox = document.getElementById('explanation-box');
        const expText = window.currentQ.explanation ? `>> ANALYSIS: ${window.currentQ.explanation}` : ">> ANALYSIS: Data corrupted.";
        typeExplain(expBox, expText);
        
        updateSystemState();
        if (integrity > 0) document.getElementById('next-btn').classList.remove('hidden');
    }
    
    function showFloatText(text, element, color) {
        const floatEl = document.createElement('div');
        floatEl.className = 'float-text'; floatEl.innerText = text;
        floatEl.style.color = color; floatEl.style.textShadow = `0 0 10px ${color}`;
        document.getElementById('term-win').appendChild(floatEl); 
        setTimeout(() => floatEl.remove(), 2000);
    }

    function nextSeq() { AudioEngine.playSFX('click'); loadSeq(); }

    function finish() {
        switchScreen('quiz-ui', 'results-ui', () => {
             let i = 0; let pct = 0; 
             if(questionsAttempted > 0) pct = Math.floor((questionsCorrect/questionsAttempted)*100); 
             if(isNaN(pct)) pct = 0;
             
             document.getElementById('results-ui').style.display = 'flex';

             const interval = setInterval(() => {
                document.getElementById('final-percent').innerText = `${i}%`;
                
                if (i % 2 === 0) AudioEngine.playSFX('type'); 
                
                if (i >= pct) {
                    clearInterval(interval);
                    AudioEngine.playSFX('success');
                }
                i++;
            }, 25); 

             generateBreakdown();
        });
    }

    function generateBreakdown() {
        const container = document.getElementById('breakdown-container');
        container.innerHTML = "<div style='margin-bottom:10px; opacity:0.7;'>>> MODULE PERFORMANCE:</div>";
        container.style.display = 'block';
        
        Object.keys(tagLedger).sort().forEach(tag => {
            if (["CORE1", "CORE2", "NET", "SEC"].includes(tag)) return;

            const data = tagLedger[tag];
            const percent = Math.floor((data.correct / data.seen) * 100);
            
            let barClass = 'bar-red'; 
            if (percent >= 90) barClass = 'bar-green';
            else if (percent >= 70) barClass = 'bar-yellow';

            const row = document.createElement('div');
            row.className = 'breakdown-row';
            
            row.innerHTML = `
                <div class="bd-tag" title="${tag}">${tag}</div>
                <div class="bd-bar-bg"><div class="bd-bar-fill ${barClass}" style="width: 0%;"></div></div>
                <div class="bd-stat">${percent}% (${data.correct}/${data.seen})</div>
            `;
            container.appendChild(row);

            setTimeout(() => {
                row.querySelector('.bd-bar-fill').style.width = `${percent}%`;
            }, 100);
        });
    }
    
    window.onload = function() {
        bootSystem();
    };

    function shutdownSystem() {
        AudioEngine.playSFX('error'); 
        const term = document.getElementById('term-win');
        term.classList.remove('power-on');
        term.classList.add('power-off');
        setTimeout(() => { location.reload(); }, 600);
    }
    
    function decryptHeader(targetHTML) {
        const header = document.getElementById('main-header');
        header.style.opacity = 0;
        setTimeout(() => {
            header.innerHTML = targetHTML;
            header.style.opacity = 1;
            AudioEngine.playSFX('type');
        }, 100);
    }

    function goToSubMenu(type) {
        document.getElementById('root-menu').classList.add('hidden');
        let targetId = '';
        let headerText = '';

        if(type === 'core1') { targetId = 'core1-menu'; headerText = 'COMPTIA A+ <span style="font-size:0.6em; color:#fff;">CORE 1</span>'; }
        if(type === 'core2') { targetId = 'core2-menu'; headerText = 'COMPTIA A+ <span style="font-size:0.6em; color:#fff;">CORE 2</span>'; }
        if(type === 'net') { targetId = 'net-menu'; headerText = 'COMPTIA <span style="font-size:0.6em; color:#fff;">NETWORK+</span>'; }
        if(type === 'sec') { targetId = 'sec-menu'; headerText = 'COMPTIA <span style="font-size:0.6em; color:#fff;">SECURITY+</span>'; }
        
        decryptHeader(headerText);

        const target = document.getElementById(targetId);
        target.classList.remove('hidden');
        setTimeout(() => {
            const btns = target.querySelectorAll('.btn');
            btns.forEach(b => {
                b.classList.remove('visible'); 
                b.classList.remove('drift-active'); 
                b.style.opacity = 0; 
                b.style.transform = 'translateY(10px)';
                b.style.animationDelay = (Math.random() * -5) + 's';
            });
            btns.forEach((b, i) => { 
                setTimeout(() => {
                    b.classList.add('visible');
                    setTimeout(() => b.classList.add('drift-active'), 500); 
                }, 100 + (i * 100)); 
            });
        }, 50);
    }

    function goToRoot() {
        document.getElementById('core1-menu').classList.add('hidden');
        document.getElementById('core2-menu').classList.add('hidden');
        document.getElementById('net-menu').classList.add('hidden');
        document.getElementById('sec-menu').classList.add('hidden');
        
        decryptHeader('COMPTIA <span style="font-size:0.6em; color:#fff;">SIMULATOR</span>');

        const root = document.getElementById('root-menu');
        root.classList.remove('hidden');
        
        setTimeout(() => {
            const btns = root.querySelectorAll('.btn');
            btns.forEach(b => {
                 b.classList.remove('visible'); 
                 b.classList.remove('drift-active'); 
                 b.style.opacity = 0; 
                 b.style.transform = 'translateY(10px)';
                 b.style.animationDelay = (Math.random() * -5) + 's';
            });
            btns.forEach((b, i) => { 
                 setTimeout(() => {
                    b.classList.add('visible');
                    setTimeout(() => b.classList.add('drift-active'), 500);
                }, 100 + (i * 100)); 
            });
        }, 50);
    }
    
    function switchScreen(fromId, toId, cb) {
    setTimeout(() => {
        // 1. Force hide the screen we are coming FROM
        if(fromId) document.getElementById(fromId).classList.add('hidden');

        // 2. Safety: Hide menus (Keep your existing logic here)
        document.getElementById('root-menu').classList.add('hidden');
        document.getElementById('core1-menu').classList.add('hidden');
        document.getElementById('core2-menu').classList.add('hidden');
        document.getElementById('net-menu').classList.add('hidden');
        document.getElementById('sec-menu').classList.add('hidden');
        
        // 3. Show the new screen
        document.getElementById(toId).classList.remove('hidden');
        if(cb) cb();
    }, 250);
}

/* ========================================================================= */
/* SECTION: GLOSSARY LOGIC                                                   */
/* ========================================================================= */

const GLOSSARY_DATA = {
    'CORE1': {
        'PORTS': [
            { k: "20/21", v: "FTP (File Transfer). TCP. Unsecured." },
            { k: "22", v: "SSH (Secure Shell). TCP. Encrypted Login." },
            { k: "23", v: "Telnet. TCP. Unencrypted Login." },
            { k: "25", v: "SMTP (Sending Mail). TCP." },
            { k: "53", v: "DNS (Domain Name System). UDP/TCP." },
            { k: "67/68", v: "DHCP (Dynamic Host Config). UDP." },
            { k: "80", v: "HTTP (Web). TCP. Unsecured." },
            { k: "110", v: "POP3 (Receiving Mail). TCP. Downloads & deletes." },
            { k: "137-139", v: "NetBIOS/NetBT. UDP/TCP. LAN file sharing." },
            { k: "143", v: "IMAP (Receiving Mail). TCP. Syncs across devices." },
            { k: "161/162", v: "SNMP (Network Mgmt). UDP. Monitor devices." },
            { k: "389", v: "LDAP (Directory Services). TCP. Network auth." },
            { k: "443", v: "HTTPS (Secure Web). TCP. Encrypted." },
            { k: "445", v: "SMB (Server Message Block). TCP. File/Printer Share." },
            { k: "3389", v: "RDP (Remote Desktop). TCP/UDP." }
        ],
        'IP ADDR': [
            { k: "IPv4 Class A", v: "1.0.0.0 - 126.x.x.x | Subnet: 255.0.0.0 (/8)" },
            { k: "IPv4 Class B", v: "128.0.0.0 - 191.x.x.x | Subnet: 255.255.0.0 (/16)" },
            { k: "IPv4 Class C", v: "192.0.0.0 - 223.x.x.x | Subnet: 255.255.255.0 (/24)" },
            { k: "Private Range A", v: "10.0.0.0 - 10.255.255.255" },
            { k: "Private Range B", v: "172.16.0.0 - 172.31.255.255" },
            { k: "Private Range C", v: "192.168.0.0 - 192.168.255.255" },
            { k: "APIPA", v: "169.254.x.x | Auto-assigned when DHCP fails." },
            { k: "Loopback (v4)", v: "127.0.0.1 | Tests NIC functionality." },
            { k: "IPv6 Link Local", v: "fe80::/10 | Local subnet only (like APIPA)." },
            { k: "IPv6 Global", v: "2000::/3 | Public routable internet address." }
        ],
        'HARDWARE': [
            { k: "ATX", v: "12 x 9.6 in. Standard desktop size. 7 expansion slots." },
            { k: "Micro-ATX", v: "9.6 x 9.6 in. Smaller. 4 expansion slots." },
            { k: "Mini-ITX", v: "6.7 x 6.7 in. Smallest. 1 expansion slot." },
            { k: "PCIe x16", v: "High speed slot for GPU. 75W power from slot." },
            { k: "M.2 Key M", v: "NVMe/PCIe SSDs (Fastest)." },
            { k: "M.2 Key B", v: "SATA SSDs / Cellular cards." },
            { k: "BIOS/UEFI", v: "Firmware. UEFI supports mouse, >2.2TB drives, Secure Boot." },
            { k: "CMOS Battery", v: "CR2032. Keeps time/BIOS settings when unplugged." },
            { k: "TPM", v: "Trusted Platform Module. Chip for encryption keys." }
        ],
        'WI-FI': [
            { k: "802.11a", v: "5 GHz | 54 Mbps | Legacy" },
            { k: "802.11b", v: "2.4 GHz | 11 Mbps | Legacy" },
            { k: "802.11g", v: "2.4 GHz | 54 Mbps | Back-compatible w/ b" },
            { k: "802.11n", v: "2.4/5 GHz | 600 Mbps | Wi-Fi 4 (MIMO)" },
            { k: "802.11ac", v: "5 GHz | 6.9 Gbps | Wi-Fi 5 (MU-MIMO)" },
            { k: "802.11ax", v: "2.4/5/6 GHz | 9.6 Gbps | Wi-Fi 6 (OFDMA)" },
            { k: "2.4 GHz", v: "Longer range, penetrates walls better, more interference." },
            { k: "5 GHz", v: "Faster speeds, shorter range, less interference." },
            { k: "Channels (2.4)", v: "1, 6, 11 (Non-overlapping in US)." }
        ],
        'RAM': [
            { k: "DDR3", v: "240 Pins (Desktop) | 204 Pins (Laptop)" },
            { k: "DDR4", v: "288 Pins (Desktop) | 260 Pins (Laptop) | Curved Edge" },
            { k: "DDR5", v: "288 Pins (Desktop) | 262 Pins (Laptop) | On-die ECC" },
            { k: "ECC", v: "Error Correcting. Detects bit flips. For servers." },
            { k: "Parity", v: "Detects errors but CANNOT fix them." },
            { k: "Dual Channel", v: "Doubles bandwidth. Must use matching colored slots." }
        ],
        'RAID': [
            { k: "RAID 0", v: "Striping. Speed++. 0 Redundancy. (Min 2 Drives)" },
            { k: "RAID 1", v: "Mirroring. Redundancy++. Slow Write. (Min 2 Drives)" },
            { k: "RAID 5", v: "Striping + Parity. Speed + Safety. (Min 3 Drives)" },
            { k: "RAID 10", v: "Stripe of Mirrors. Best of both. (Min 4 Drives)" }
        ],
        'CABLES': [
            { k: "RJ-45", v: "8-pin. Standard Ethernet." },
            { k: "RJ-11", v: "4-pin/6-pin. Telephone/DSL lines." },
            { k: "Cat 5e", v: "1 Gbps | 100m | Unshielded." },
            { k: "Cat 6", v: "10 Gbps (55m) | 1 Gbps (100m)." },
            { k: "Cat 6a", v: "10 Gbps (100m) | Shielded." },
            { k: "Plenum", v: "Fire-resistant coating. For HVAC spaces." },
            { k: "USB 2.0", v: "480 Mbps | 5 meters max | Black/White." },
            { k: "USB 3.0", v: "5 Gbps | 3 meters max | Blue." },
            { k: "USB-C", v: "Reversible | Data + Power + Video." },
            { k: "Thunderbolt 3", v: "40 Gbps | Uses USB-C connector." }
        ],
        'PRINTERS': [
            { k: "1. Processing", v: "Printer receives job & rasterizes image." },
            { k: "2. Charging", v: "Drum charged to -600V." },
            { k: "3. Exposing", v: "Laser writes image to drum (-100V)." },
            { k: "4. Developing", v: "Toner sticks to exposed areas." },
            { k: "5. Transferring", v: "Toner moves from drum to paper." },
            { k: "6. Fusing", v: "Heat & Pressure melt toner to paper." },
            { k: "7. Cleaning", v: "Scraper removes excess toner." },
            { k: "Thermal", v: "Heating element + special paper (Receipts)." },
            { k: "Impact", v: "Pins strike ribbon. Dot Matrix. Carbon copies." }
        ],
        'CLOUD': [
            { k: "IaaS", v: "Infrastructure (AWS EC2). You manage OS & Apps." },
            { k: "PaaS", v: "Platform (Heroku). You manage Apps only." },
            { k: "SaaS", v: "Software (Gmail). Vendor manages everything." },
            { k: "Private Cloud", v: "Hardware dedicated to one org." },
            { k: "Public Cloud", v: "Hardware shared by many orgs (AWS)." },
            { k: "Hypervisor T1", v: "Bare Metal (ESXi). Runs on hardware." },
            { k: "Hypervisor T2", v: "Hosted (VirtualBox). Runs on OS." }
        ],
        'COMMANDS': [
            { k: "ipconfig", v: "Win: IP details. /flushdns, /release, /renew" },
            { k: "ping", v: "Test connectivity (ICMP)." },
            { k: "tracert", v: "Trace hops to destination (Windows)." },
            { k: "netstat", v: "Show active ports/connections." },
            { k: "nslookup", v: "Query DNS records (A, MX, CNAME)." },
            { k: "chkdsk", v: "Check disk integrity (/f to fix)." },
            { k: "sfc /scannow", v: "System File Checker. Fixes OS files." },
            { k: "gpupdate", v: "Force Group Policy update." },
            { k: "diskpart", v: "Disk partition management CLI." }
        ],
        'T-SHOOT': [
            { k: "1. Identify", v: "Question user, backup, check logs." },
            { k: "2. Theory", v: "Guess the probable cause." },
            { k: "3. Test", v: "Confirm the theory (Sandbox)." },
            { k: "4. Plan", v: "Create plan & implement solution." },
            { k: "5. Verify", v: "Test full system functionality." },
            { k: "6. Document", v: "Record findings, actions, and lessons." }
        ]
    },
    // Placeholders for other exams so buttons don't break
    'CORE2': { 'COMING SOON': [{ k: "STATUS", v: "UNDER CONSTRUCTION" }] },
    'NET': { 'COMING SOON': [{ k: "STATUS", v: "UNDER CONSTRUCTION" }] },
    'SEC': { 'COMING SOON': [{ k: "STATUS", v: "UNDER CONSTRUCTION" }] }
};

let currentGlossaryExam = null;

function toggleGlossary() {
    const ui = document.getElementById('glossary-ui');
    if (ui.classList.contains('hidden')) {
        ui.classList.remove('hidden');
        showExamSelection(); // Always reset to main menu on open
        AudioEngine.playSFX('click');
    } else {
        ui.classList.add('hidden');
        AudioEngine.playSFX('error');
    }
}

function showExamSelection() {
    document.getElementById('gloss-select-view').classList.remove('hidden');
    document.getElementById('gloss-content-view').classList.add('hidden');
    document.getElementById('gloss-back-btn').classList.add('hidden');
    document.getElementById('gloss-title').innerText = ">> SELECT_DATABASE AND CLICK TO RUN A TARGETED QUIZ";
}

function loadGlossaryExam(examKey) {
    currentGlossaryExam = examKey;
    
    // 1. Switch Views
    document.getElementById('gloss-select-view').classList.add('hidden');
    document.getElementById('gloss-content-view').classList.remove('hidden');
    document.getElementById('gloss-back-btn').classList.remove('hidden');
    document.getElementById('gloss-title').innerText = `>> DATABASE: ${examKey}`;
    
    // 2. Generate Tabs Dynamically
    const tabContainer = document.getElementById('gloss-tabs');
    tabContainer.innerHTML = "";
    
    const categories = Object.keys(GLOSSARY_DATA[examKey]);
    categories.forEach((cat, index) => {
        const btn = document.createElement('button');
        btn.className = 'tab-btn';
        btn.innerText = cat;
        btn.onclick = () => renderGlossaryCategory(cat);
        if(index === 0) btn.classList.add('active'); // Activate first tab
        tabContainer.appendChild(btn);
    });

    // 3. Render first category
    if(categories.length > 0) renderGlossaryCategory(categories[0]);
    
    AudioEngine.playSFX('success');
}

function renderGlossaryCategory(category) {
    // Highlight Tab
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active');
        if(b.innerText === category) b.classList.add('active');
    });

    // Render Grid
    const container = document.getElementById('glossary-content');
    container.innerHTML = "";
    
    const data = GLOSSARY_DATA[currentGlossaryExam][category];
    if(data) {
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'gloss-item';
            div.innerHTML = `<span class="gloss-key">${item.k}</span><span class="gloss-val">${item.v}</span>`;
            
            // --- NEW CLICK LOGIC ---
            div.onclick = () => {
                // 1. Clean the term for better search results
                let searchTerm = item.k.split('(')[0].trim();
                
                // Example: "20/21" -> "20" (Searching just one is safer)
                if(searchTerm.includes('/')) searchTerm = searchTerm.split('/')[0].trim();

                // 2. Construct the query: e.g., "CORE1 + FTP"
                const query = `${currentGlossaryExam} + ${searchTerm}`;
                
                // 3. Run the helper
                runGlossaryTopic(query);
            };
            // -----------------------

            container.appendChild(div);
        });
    }
}

function runGlossaryTopic(fullQuery) {
    AudioEngine.playSFX('click');

    // 1. Close the modal
    toggleGlossary();

    // 2. Populate the search box so the user sees what happened
    const searchInput = document.getElementById('topic-search-input');
    if(searchInput) {
        searchInput.value = fullQuery;
        
        // Visual flair: Flash the input box
        searchInput.style.transition = '0s';
        searchInput.style.backgroundColor = '#fff';
        setTimeout(() => {
            searchInput.style.transition = 'background 0.5s';
            searchInput.style.backgroundColor = 'rgba(0,0,0,0.5)';
        }, 100);
    }

    // 3. Trigger the existing search function
    setTimeout(() => {
        startTopicRun(); 
    }, 200);
}
////////////////////////////////////////////////////////////////////////////////////////////////////////
/* ========================================================================= */
/* SECTION: DUNGEON CRAWLER ENGINE                                           */
/* ========================================================================= */
const Dungeon = {
    // --- STATE VARIABLES ---
    player: { hp: 100, maxHp: 100, ram: 50, maxRam: 50, layer: 1, xp: 0, lvl: 1 },
    inventory: [],
    equipped: { weapon: null, accessory: null },
    currentEnemy: null,
    inCombat: false,
    pendingAction: null, 
    activeMissionTag: 'ALL',

    // --- DATABASE: ITEMS ---
    itemsDB: [
        { id: 'w1', name: 'Crimper Tool', type: 'wep', dmg: 5, tier: 1 },
        { id: 'w2', name: 'CAT5e Whip', type: 'wep', dmg: 12, tier: 2 },
        { id: 'w3', name: 'Mech Keyboard', type: 'wep', dmg: 25, tier: 3 },
        { id: 'w4', name: 'Banhammer', type: 'wep', dmg: 50, tier: 4 },
        { id: 'a1', name: 'Thermal Paste', type: 'acc', effect: 'heal', val: 20, tier: 1 },
        { id: 'a2', name: 'VPN Shield', type: 'acc', effect: 'def', val: 5, tier: 2 },
        { id: 'p1', name: 'Energy Drink', type: 'pot', effect: 'ram', val: 30, tier: 1 }
    ],

    // --- DATABASE: SKILLS (.EXE) ---
    skills: [
        { id: 's1', name: 'SUDO_SMASH.EXE', cost: 10, dmg: 30, desc: 'Heavy physical damage.' },
        { id: 's2', name: 'FIREWALL.BAT', cost: 15, heal: 0, effect: 'block', desc: 'Block next attack.' },
        { id: 's3', name: 'DEFRAG.MSI', cost: 20, heal: 40, desc: 'Repair HP sectors.' },
        { id: 's4', name: 'PING_OF_DEATH', cost: 50, dmg: 150, desc: 'Massive packet overflow.' }
    ],

    // --- DATABASE: ENEMIES ---
    enemiesDB: [
        { name: "PACKET SNIFFER", hp: 40, maxHp:40, dmg:5, xp:15, art: "      /\\  /\\\n     /  \\/  \\\n    (  o  o  )  \n     \\  --  /\n      /    \\ " },
        { name: "SCRIPT KIDDIE", hp: 50, maxHp:50, dmg:8, xp:20, art: "      .--.\n     |o_o |\n     |:_/ |\n    //   \\ \\\n   (|     | )\n  /'\\_   _/`\\" },
        { name: "SPAGHETTI CABLE", hp: 80, maxHp:80, dmg:12, xp:40, art: "      _  _ \n     / \\/ \\\n    |      \\\n     \\      \\   \n      \\      /\n       | /  \\ |\n       |/    \\|" },
        { name: "TROJAN HORSE", hp: 150, maxHp:150, dmg:18, xp:80, art: "         /\\\n        /  \\\n       |    |\n       |    |\n      /|____|\\\n     /_|    |_\\\n    /  |    |  \\" },
        { name: "DDOS SWARM", hp: 160, maxHp:160, dmg:22, xp:100, art: "   .   .   . \n  .  [REQ]  .\n . [REQ] [REQ] .\n< SERVER OVERLOAD >" },
        { name: "RANSOMWARE KNIGHT", hp: 300, maxHp:300, dmg:30, xp:200, art: "       .   .\n       /|\\ /|\\\n      ( O . O )\n       \\  -  /\n       /|___|\\\n      //| | |\\\\" },
        { name: "ZERO-DAY EXPLOIT", hp: 666, maxHp:666, dmg:50, xp:1000, art: "    ERROR ERROR\n    E .--. .--. \n    R |__| |__| \n    R |  | |  | \n    O |__| |__| \n    ! SYSTEM FAIL !" }
    ],

    // --- INITIALIZATION ---
    init: function() {
        // HIDE ALL SCREENS FIRST
        document.getElementById('root-menu').classList.add('hidden');
        document.getElementById('core1-menu').classList.add('hidden');
        document.getElementById('core2-menu').classList.add('hidden');
        document.getElementById('net-menu').classList.add('hidden');
        document.getElementById('sec-menu').classList.add('hidden');
        document.getElementById('quiz-ui').classList.add('hidden');
        
        // SHOW DUNGEON UI
        const ui = document.getElementById('dungeon-ui');
        ui.classList.remove('hidden');
        
        // SHOW MISSION SELECT
        const selectScreen = document.getElementById('dungeon-mission-select');
        selectScreen.style.display = 'flex';
    },

    // --- MISSION LOADER ---
    loadMission: function(tag) {
        this.activeMissionTag = tag;
        
        if (tag === 'ALL') {
            qQueue = [...(typeof MASTER_DATABASE !== 'undefined' ? MASTER_DATABASE : [])];
        } else {
            qQueue = (typeof MASTER_DATABASE !== 'undefined' ? MASTER_DATABASE : []).filter(q => q.tags.includes(tag));
        }

        // Shuffle
        for (let i = qQueue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [qQueue[i], qQueue[j]] = [qQueue[j], qQueue[i]];
        }

        if (qQueue.length === 0) {
            alert("NO DATA FOUND. CHECK DATABASE FILE.");
            return;
        }

        // HIDE SELECT, START GAME
        document.getElementById('dungeon-mission-select').style.display = 'none';
        
        this.player = { hp: 100, maxHp: 100, ram: 50, maxRam: 50, layer: 1, xp: 0, lvl: 1 };
        this.inventory = [];
        this.equipped = { weapon: this.itemsDB[0], accessory: null };
        
        this.log(">> MISSION START: " + tag, 'log-good');
        setTimeout(() => this.encounter(), 500);
        this.updateUI();
    },

    // --- ENCOUNTER LOGIC ---
    encounter: function() {
        if(this.player.layer > 7) {
            this.setArt("ACCESS GRANTED\n\nYOU ARE ROOT.");
            this.log(">> SYSTEM HACKED. YOU WIN.", 'log-good');
            return;
        }

        if(this.player.layer < 7 && Math.random() > 0.7) {
            this.triggerEvent();
        } else {
            this.spawnMonster();
        }
    },

    triggerEvent: function() {
        this.inCombat = false;
        this.setArt("\n      [ ? ]\n\n   DATA NODE FOUND");
        document.getElementById('monster-name').innerText = "UNKNOWN NODE";
        document.getElementById('monster-hp-bar').style.width = "0%";
        
        const loot = this.getLoot(this.player.layer);
        if(loot) {
            this.inventory.push(loot);
            this.log(`>> LOOT: You found [${loot.name}]!`, 'log-loot');
        } else {
            this.player.hp = Math.min(this.player.hp + 20, this.player.maxHp);
            this.log(">> You patch your firewall. HP +20", 'log-good');
        }
        
        setTimeout(() => {
            this.player.layer++;
            this.log(">> ASCENDING TO LAYER " + this.player.layer);
            setTimeout(() => this.encounter(), 2000);
        }, 2000);
        this.updateUI();
    },

    spawnMonster: function() {
        this.inCombat = true;
        let pool = [];
        
        if (this.player.layer <= 2) pool = [this.enemiesDB[0], this.enemiesDB[1]];
        else if (this.player.layer <= 5) pool = [this.enemiesDB[2], this.enemiesDB[3], this.enemiesDB[4]];
        else if (this.player.layer === 6) pool = [this.enemiesDB[5]]; 
        else pool = [this.enemiesDB[6]]; 

        const template = pool[Math.floor(Math.random() * pool.length)];
        this.currentEnemy = JSON.parse(JSON.stringify(template));
        
        this.setArt(this.currentEnemy.art);
        document.getElementById('monster-name').innerText = this.currentEnemy.name;
        this.updateEnemyHP();
        this.log(`>> A wild ${this.currentEnemy.name} appears!`);
        this.updateUI();
    },

    // --- COMBAT LOOP ---
    preCombat: function(actionType, skillObj = null) {
        if (!this.inCombat) return;

        if (actionType === 'skill' && skillObj) {
            if (this.player.ram < skillObj.cost) {
                this.log(">> INSUFFICIENT RAM!", 'log-bad');
                return;
            }
            this.pendingAction = { type: 'skill', data: skillObj };
        } else {
            this.pendingAction = { type: 'attack' };
        }

        // HIDE DUNGEON, SHOW QUIZ
        document.getElementById('dungeon-ui').classList.add('hidden');
        
        // --- QUESTION LOGIC ---
        let q;
        if (qQueue.length > 0) {
            q = qQueue.pop();
        } else {
            // Fallback for infinite ammo
            let pool = (typeof MASTER_DATABASE !== 'undefined' ? MASTER_DATABASE : []);
            if(this.activeMissionTag !== 'ALL') {
                pool = pool.filter(x => x.tags.includes(this.activeMissionTag));
            }
            if(pool.length === 0) pool = MASTER_DATABASE; 
            q = pool[Math.floor(Math.random() * pool.length)];
        }
        
        // Show Quiz
        document.getElementById('quiz-ui').classList.remove('hidden');
        
        document.getElementById('q-text').innerText = ">> DECRYPT PACKET TO ATTACK:\n" + q.question;
        
        const optsList = document.getElementById('opts-list');
        optsList.innerHTML = '';
        optsList.style.display = 'flex';
        
        let opts = q.options.map((t, i) => ({ t, isC: i === q.answer }));
        for (let k = opts.length - 1; k > 0; k--) { const j = Math.floor(Math.random() * (k + 1)); [opts[k], opts[j]] = [opts[j], opts[k]]; }

        opts.forEach(o => {
            const b = document.createElement('button'); 
            b.className = 'option-btn'; 
            b.innerText = `> ${o.t}`;
            b.onclick = () => {
                this.resolveRound(o.isC);
            };
            optsList.appendChild(b);
        });

        document.getElementById('pbq-area').style.display = 'none';
        document.getElementById('explanation-box').style.display = 'none';
        document.getElementById('next-btn').classList.add('hidden');
    },

    resolveRound: function(isCorrect) {
        // RETURN TO DUNGEON
        document.getElementById('quiz-ui').classList.add('hidden');
        document.getElementById('dungeon-ui').classList.remove('hidden');
        
        const action = this.pendingAction;
        let playerDmg = 0;

        // 1. PLAYER TURN
        if (isCorrect) {
            if(window.AudioEngine) AudioEngine.playSFX('success');
            
            if (action.type === 'attack') {
                const base = this.equipped.weapon ? this.equipped.weapon.dmg : 2;
                playerDmg = base + Math.floor(Math.random() * 5);
                this.log(`>> ATTACK SUCCESS! You deal ${playerDmg} DMG.`, 'log-good');
            } else if (action.type === 'skill') {
                this.player.ram -= action.data.cost;
                if (action.data.dmg) playerDmg = action.data.dmg;
                if (action.data.heal) {
                    this.player.hp = Math.min(this.player.hp + action.data.heal, this.player.maxHp);
                    this.log(`>> HEAL SUCCESS! Recovered ${action.data.heal} HP.`, 'log-good');
                }
                this.log(`>> EXECUTED ${action.data.name}!`, 'log-good');
            }
            
            if (playerDmg > 0) {
                this.currentEnemy.hp -= playerDmg;
                this.showDamage(playerDmg, '#ff0000');
            }

        } else {
            if(window.AudioEngine) AudioEngine.playSFX('error');
            this.log(">> DECRYPTION FAILED! Attack missed.", 'log-bad');
        }

        this.updateEnemyHP();

        if (this.currentEnemy.hp <= 0) {
            this.winFight();
            return;
        }

        // 3. ENEMY TURN
        setTimeout(() => {
            if (this.currentEnemy.hp > 0) {
                let dmg = this.currentEnemy.dmg;
                if (this.equipped.accessory && this.equipped.accessory.effect === 'def') {
                    dmg -= this.equipped.accessory.val;
                }
                if (dmg < 0) dmg = 0;

                this.player.hp -= dmg;
                this.log(`>> ENEMY ATTACKS! You take ${dmg} DMG.`, 'log-bad');
                
                const vp = document.getElementById('monster-viewport');
                vp.classList.remove('shake-screen');
                void vp.offsetWidth;
                vp.classList.add('shake-screen');
                
                if (this.player.hp <= 0) {
                    this.log(">> CRITICAL ERROR: SYSTEM DESTROYED.");
                    alert("GAME OVER. REBOOTING...");
                    location.reload();
                }
                this.updateUI();
            }
        }, 800);
    },

    winFight: function() {
        this.inCombat = false;
        this.log(`>> TARGET DELETED. +${this.currentEnemy.xp} XP.`, 'log-loot');
        
        if(Math.random() > 0.5) {
            const loot = this.getLoot(this.player.layer);
            if(loot) {
                this.inventory.push(loot);
                this.log(`>> LOOT DROP: [${loot.name}]`, 'log-loot');
            }
        }

        this.player.ram = Math.min(this.player.ram + 10, this.player.maxRam);
        
        this.player.xp += this.currentEnemy.xp;
        if (this.player.xp > this.player.lvl * 100) {
            this.player.lvl++;
            this.player.maxHp += 20;
            this.player.hp = this.player.maxHp;
            this.log(`>> LEVEL UP! YOU ARE NOW LVL ${this.player.lvl}`, 'log-good');
        }

        setTimeout(() => {
            this.player.layer++;
            this.log(">> ASCENDING TO LAYER " + this.player.layer + "...");
            this.setArt("\n\n   ...LOADING NEXT LAYER...");
            document.getElementById('monster-hp-bar').style.width = "0%";
            setTimeout(() => this.encounter(), 2000);
        }, 1500);
        this.updateUI();
    },

    getLoot: function(tier) {
        const pool = this.itemsDB.filter(i => i.tier <= tier + 1);
        return pool[Math.floor(Math.random() * pool.length)];
    },

    showDamage: function(val, color) {
        const el = document.createElement('div');
        el.className = 'dmg-number';
        el.innerText = "-" + val;
        el.style.color = color;
        document.getElementById('monster-viewport').appendChild(el);
        setTimeout(() => el.remove(), 1000);
    },

    setArt: function(txt) {
        document.getElementById('ascii-art-container').innerText = txt;
    },

    updateEnemyHP: function() {
        if(!this.currentEnemy) return;
        const pct = Math.max(0, (this.currentEnemy.hp / this.currentEnemy.maxHp) * 100);
        document.getElementById('monster-hp-bar').style.width = pct + "%";
    },

    updateUI: function() {
        document.getElementById('p-hp').innerText = this.player.hp;
        document.getElementById('p-max-hp').innerText = this.player.maxHp;
        document.getElementById('p-mana').innerText = this.player.ram;
        document.getElementById('p-layer').innerText = this.player.layer;
        
        const wName = this.equipped.weapon ? this.equipped.weapon.name : "FISTS";
        document.getElementById('p-wep').innerText = wName;
        
        const log = document.getElementById('combat-log');
        log.scrollTop = log.scrollHeight;
    },

    log: function(msg, cssClass = '') {
        const div = document.createElement('div');
        div.className = 'log-entry ' + cssClass;
        div.innerText = msg;
        document.getElementById('combat-log').appendChild(div);
    },

    openInventory: function() {
        const modal = document.getElementById('inv-modal');
        const list = document.getElementById('inv-list');
        list.innerHTML = '';
        modal.style.display = 'flex';

        this.inventory.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'inv-item';
            div.innerHTML = `<b>${item.name}</b><br><small>${item.type.toUpperCase()}</small>`;
            div.onclick = () => {
                this.equipItem(item, idx);
                modal.style.display = 'none';
            };
            list.appendChild(div);
        });
        
        if(this.inventory.length === 0) list.innerHTML = "<p>INVENTORY EMPTY</p>";
    },

    equipItem: function(item, idx) {
        if (item.type === 'wep') {
            this.equipped.weapon = item;
            this.log(`>> EQUIPPED [${item.name}]`, 'log-good');
        } else if (item.type === 'acc') {
            this.equipped.accessory = item;
            this.log(`>> EQUIPPED [${item.name}]`, 'log-good');
        } else if (item.type === 'pot') {
            if (item.effect === 'ram') this.player.ram += item.val;
            this.inventory.splice(idx, 1);
            this.log(">> CONSUMED ENERGY DRINK.", 'log-good');
        }
        this.updateUI();
    },

    openSkills: function() {
        const modal = document.getElementById('inv-modal');
        const list = document.getElementById('inv-list');
        list.innerHTML = '';
        modal.style.display = 'flex';

        this.skills.forEach(skill => {
            const div = document.createElement('div');
            div.className = 'inv-item';
            div.innerHTML = `<b>${skill.name}</b><br><small>COST: ${skill.cost} RAM</small><br><em style="font-size:0.8em">${skill.desc}</em>`;
            div.onclick = () => {
                this.preCombat('skill', skill);
                modal.style.display = 'none';
            };
            list.appendChild(div);
        });
    },

    flee: function() {
        if(Math.random() > 0.5) {
            this.log(">> FLEE SUCCESSFUL!", 'log-good');
            this.inCombat = false;
            this.setArt("\n\n   ESCAPED...");
            setTimeout(() => {
                 this.player.layer++;
                 this.encounter();
            }, 1000);
        } else {
            this.log(">> FLEE FAILED! ENEMY ATTACKS!", 'log-bad');
            this.player.hp -= 10;
            this.updateUI();
        }
    }
};    
</script>
<div id="ref-widget" style="position: fixed; top: 20px; left: 20px; z-index: 5000;">
    <button class="sys-btn" style="
        color: #ff3333; 
        border-color: #ff3333; 
        font-size: 1.5rem; 
        padding: 15px 30px;
        text-shadow: 0 0 10px #ff0000;
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
    " onclick="toggleGlossary()">
        [STUDY GUIDE]
    </button>
</div>

<div id="glossary-ui" class="hidden">
    <div class="glossary-window">
        <div class="glossary-header">
            <span id="gloss-title">>> SELECT_DATABASE</span>
            <div>
                <button id="gloss-back-btn" class="close-btn hidden" style="margin-right: 15px;" onclick="showExamSelection()">[ < BACK ]</button>
                <button class="close-btn" onclick="toggleGlossary()">[ X ]</button>
            </div>
        </div>
        
        <div id="gloss-select-view" class="gloss-view">
            <div class="exam-select-grid">
                <button class="exam-select-btn" onclick="loadGlossaryExam('CORE1')">
                    <span class="ex-title">CORE 1</span>
                    <span class="ex-sub">HARDWARE/NETWORK</span>
                </button>
                <button class="exam-select-btn" onclick="loadGlossaryExam('CORE2')">
                    <span class="ex-title">CORE 2</span>
                    <span class="ex-sub">SOFTWARE/SECURITY</span>
                </button>
                <button class="exam-select-btn" onclick="loadGlossaryExam('NET')">
                    <span class="ex-title">NETWORK+</span>
                    <span class="ex-sub">INFRASTRUCTURE</span>
                </button>
                <button class="exam-select-btn" onclick="loadGlossaryExam('SEC')">
                    <span class="ex-title">SECURITY+</span>
                    <span class="ex-sub">CYBERSECURITY</span>
                </button>
            </div>
        </div>

        <div id="gloss-content-view" class="gloss-view hidden">
            <div id="gloss-tabs" class="glossary-tabs">
                </div>
            <div id="glossary-content" class="glossary-grid">
                </div>
        </div>
    </div>
</div>
</body>
</html>
