<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COGITATOR</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --term-color: #0affba;
            --split-1: #ff0000; 
            --split-2: #00ffff;
            --glow-color: rgba(10, 255, 186, 0.5);
            --hint-color: #ffd700; 
            --edge-opacity: 0;
            --shake-amp: 0px; 
            --glitch-amp: 1px;
            --sway-speed: 5s; 
        }

        /* --- GLOBAL & UTILS --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        ::-webkit-scrollbar { display: none; width: 0; background: transparent; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        html { height: 100%; overflow: hidden; }
        
        body {
            background-color: #000000;
            margin: 0;
            padding: 20px; 
            font-family: 'VT323', monospace;
            color: var(--term-color);
            overflow: hidden; 
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; /* Center Vertically */
            text-shadow: 0 0 1px var(--glow-color); 
            box-shadow: inset 0 0 00px var(--glow-color);
            transition: color 0.4s ease, text-shadow 0.4s ease; 
        }

        .hidden { display: none !important; }

        /* --- TERMINAL WINDOW --- */
        .terminal-window {
            width: 100%; max-width: 900px; height: 85vh; 
            border: 2px solid var(--term-color); 
            background: rgba(0, 5, 5, 0.85); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            display: none; flex-direction: column; position: relative;
            box-shadow: 5px 5px 0px rgba(0, 20, 20, 0.5), inset 0 0 20px rgba(0,0,0,0.5);
            transition: border-color 0.2s ease, filter 0.2s ease; 
            z-index: 100;
            overflow: hidden;
        }
        .power-on { display: flex !important; animation: turnOn 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards; }

        /* --- HEADER & STATS --- */
        .header { 
            border-bottom: 4px solid var(--term-color);
            padding-bottom: 10px; margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: flex-start;
            flex-shrink: 0; position: relative;
        }
        .h-left h1 { 
            margin: 0; font-size: 3.5rem; letter-spacing: 4px; line-height: 1;
            text-shadow: 4px 0 var(--split-1), -4px 0 var(--split-2);
            display: inline-block; font-weight: normal;
        }
        .status-container { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        .stats-area { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .score-box { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        
        .integrity-wrapper { width: 380px; text-align: right; }
        .integrity-label { font-size: 0.8rem; letter-spacing: 2px; font-weight:bold; display: flex; justify-content: space-between; }
        .integrity-container { width: 100%; height: 25px; border: 2px solid var(--term-color); padding: 2px; background: rgba(0,0,0,0.8); }
        .integrity-fill { height: 100%; width: 100%; background: repeating-linear-gradient(90deg, var(--term-color), var(--term-color) 8px, transparent 8px, transparent 10px); box-shadow: 0 0 15px var(--term-color); transition: width 0.5s ease; }
        .integrity-critical { background: repeating-linear-gradient(90deg, #ff0000, #ff0000 8px, transparent 8px, transparent 10px) !important; box-shadow: 0 0 25px #ff0000 !important; animation: crit-pulse 0.2s infinite; }

        /* --- MENUS & BUTTONS --- */
        .menu-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 5px; overflow-y: auto; padding-bottom: 20px; }
        
        .btn { 
            background: rgba(0,0,0,0.5); border: 2px solid currentColor; color: var(--term-color); 
            font-family: 'VT323', monospace; font-size: 1.35rem; padding: 10px 15px;
            cursor: pointer; text-align: left; transition: 0.1s; position: relative;
            opacity: 0; transform: translateY(10px);
            box-shadow: 0 0 12px currentColor; text-shadow: 2px 2px 0px #000;
        }
        .btn.visible { opacity: 1 !important; transform: translateY(0); transition: opacity 0.5s ease, transform 0.5s ease; }
        .btn:hover { background: #fff; color: #000 !important; border-color: #fff; text-shadow: none; z-index: 10; animation: rgb-split-hover 0.1s infinite !important; transform: translate(-2px, -2px) !important; }
        
        .btn.exam-mode { color: #ff4444 !important; border-color: #ff4444 !important; box-shadow: 0 0 15px #ff4444; }
        .btn.exam-mode:hover { background: #ff4444; color: white !important; box-shadow: 0 0 60px #ff4444; }
        .btn-back { color: #ffffff !important; border-color: #ffffff !important; box-shadow: 0 0 15px #ffffff; }
        .btn-back:hover { background: #ffffff; color: #000 !important; box-shadow: 0 0 40px #ffffff; }

        .nav-btn { width: 100%; margin-top: 20px; padding: 10px; font-size: 1.5rem; background: rgba(0,0,0,0.8); color: #fff; border: 1px solid #fff; cursor: pointer; transition: 0.2s; }
        .nav-btn:hover { background: #fff; color: #000; }

        /* --- QUIZ UI --- */
        .quiz-container { display: flex; flex-direction: column; flex-grow: 1; overflow-y: auto; position: relative; padding-right: 10px; }
        .quiz-header-bar { display:flex; justify-content:space-between; border-bottom: 1px solid var(--term-color); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.3rem; flex-shrink: 0; position: sticky; top: 0; background: rgba(0, 5, 5, 0.95); z-index: 20; }
        .question-box { font-size: 1.8rem; margin-bottom: 20px; min-height: 80px; border-left: 8px solid var(--term-color); padding-left: 20px; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.3); }
        #explanation-box { margin-bottom: 20px; padding: 15px; border: 2px dashed var(--term-color); background: rgba(0,10,0,0.6); font-size: 1.6rem; color: #fff; display: none; }
        
        .option-btn { background: rgba(0, 0, 0, 0.7); border: 2px solid var(--term-color); color: #fff; padding: 10px; font-family: 'VT323', monospace; font-size: 1.35rem; text-align: left; cursor: pointer; margin-bottom: 10px; text-shadow: 2px 2px 0 #000; }
        .option-btn:hover { background: #fff !important; color: #000 !important; padding-left: 25px; }
        .option-btn.correct { background: var(--term-color) !important; color: #000 !important; font-weight: bold; box-shadow: 0 0 50px var(--term-color); animation: answer-thump 0.3s ease-out; }
        .option-btn.wrong { background: #a00 !important; color: #fff !important; border-color: red; animation: answer-shake 0.4s; }

        /* --- RESULTS & FAIL --- */
        #results-ui { display: none; flex-direction: column; justify-content: flex-start; align-items: center; flex: 1; width: 100%; min-height: 0; text-align: center; overflow-y: auto; padding-top: 20px; padding-bottom: 40px; }
        #breakdown-container { width: 100%; max-width: 700px; margin-top: 20px; border-top: 2px dashed var(--term-color); padding-top: 15px; text-align: left; display: none; }
        .breakdown-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1.4rem; border-bottom: 1px dotted rgba(10,255,186,0.3); }
        .bd-bar-fill { height: 10px; background: var(--term-color); transition: width 1s ease; }
        .bar-green { background: #0f0; } .bar-yellow { background: #ff0; } .bar-red { background: #f00; }

        #fail-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: rgba(5,0,0,0.95); flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .fail-visible { display: flex !important; animation: fail-entry 0.3s forwards; }
        .fail-text { font-size: 4rem; color: #fff; text-shadow: 3px 0 red, -3px 0 blue; margin-bottom: 20px; }

        /* --- DUNGEON MODE SPECIFIC STYLES --- */
        #dungeon-ui {
            height: 100%;
            display: flex; /* CHANGED FROM NONE TO FLEX TO FIX BLACK SCREEN */
            flex-direction: column;
            position: relative;
            padding-bottom: 20px;
        }
        
        #dungeon-mission-select {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 50;
            display: none; /* JS toggles this to flex */
            flex-direction: column; align-items: center; justify-content: center;
            border: 2px solid var(--term-color);
        }

        .dungeon-header { border-bottom: 2px solid var(--term-color); padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; font-size: 1.2rem; background: rgba(0, 20, 0, 0.6); }
        
        #monster-viewport {
            flex: 1; border: 2px dashed #333; background: rgba(0, 10, 0, 0.3);
            overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;
            margin-bottom: 10px; transition: border-color 0.2s;
        }
        
        #ascii-art-container {
            font-family: 'Courier New', monospace; font-size: 10px; line-height: 10px;
            color: var(--term-color); white-space: pre; text-align: center; font-weight: bold;
            text-shadow: 0 0 5px var(--term-color);
        }

        .combat-log-area {
            height: 150px; border: 1px solid var(--term-color); background: rgba(0,0,0,0.8);
            overflow-y: auto; padding: 10px; font-family: 'VT323', monospace; font-size: 1.1rem;
            margin-bottom: 10px; text-align: left;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px dotted #333; }
        .log-good { color: #0f0; } .log-bad { color: #f00; } .log-loot { color: #ffd700; }
        
        .dungeon-controls { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        
        /* Dungeon Animations */
        @keyframes floatUpDamage { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -150%) scale(1.5); opacity: 0; } }
        .dmg-number { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: bold; pointer-events: none; animation: floatUpDamage 1s forwards; z-index: 100; }
        .shake-screen { animation: stress-shake 0.4s; }

        /* Inventory */
        #inv-modal { position: absolute; top: 10%; left: 5%; width: 90%; height: 80%; background: #000; border: 2px solid var(--term-color); z-index: 200; display: none; flex-direction: column; padding: 20px; }
        .inv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; overflow-y: auto; flex: 1; }
        .inv-item { border: 1px solid #555; padding: 10px; cursor: pointer; }
        .inv-item:hover { background: #222; border-color: var(--term-color); }

        /* --- WIDGETS --- */
        #donate-widget { position: fixed; top: 10px; right: 20px; display: flex; gap: 8px; z-index: 5000; }
        .sys-btn { background: rgba(0,0,0,0.9); font-family: 'VT323'; font-size: 1.3rem; padding: 5px 12px; border: 1px solid; color: var(--term-color); cursor: pointer; animation: sys-btn-float 5s ease-in-out infinite; }
        .sys-btn:hover { animation: none; transform: translate(-1px,-1px); box-shadow: 0 0 15px currentColor; }
        
        /* RESTORED STUDY BUTTON */
        #ref-widget { position: fixed; top: 20px; left: 20px; z-index: 5000; }

        /* --- GLOSSARY UI --- */
        #glossary-ui { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .glossary-window { width: 90%; max-width: 900px; height: 80vh; border: 2px solid var(--term-color); background: #000; display: flex; flex-direction: column; overflow: hidden; }
        .gloss-view { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .exam-select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 40px; overflow-y: auto; }
        .exam-select-btn { border: 2px solid var(--term-color); background: rgba(0,20,20,0.5); color: var(--term-color); padding: 20px; cursor: pointer; }
        .exam-select-btn:hover { background: var(--term-color); color: #000; }
        .glossary-tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--term-color); }
        .tab-btn { flex: 1; background: none; border: none; color: var(--term-color); padding: 10px; cursor: pointer; font-family: 'VT323'; font-size: 1.2rem; border-right: 1px solid #333; }
        .tab-btn.active { background: var(--term-color); color: #000; }
        .glossary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; padding: 20px; overflow-y: auto; }
        .gloss-item { border: 1px solid #333; padding: 10px; cursor: pointer; }
        .gloss-item:hover { border-color: var(--term-color); background: #111; }
        .gloss-key { color: var(--term-color); font-weight: bold; display: block; border-bottom: 1px dashed #333; margin-bottom: 5px; }
        
        /* ANIMATIONS */
        @keyframes turnOn { 0% { transform: scaleY(0.005) scaleX(0); opacity: 0; } 100% { transform: scaleY(1) scaleX(1); opacity: 1; } }
        @keyframes sys-btn-float { 0% { transform: translate(0,0); } 50% { transform: translate(-1px,1px); } 100% { transform: translate(0,0); } }
        @keyframes random-drift { 0% { transform: translate(0,0); } 100% { transform: translate(1px,-1px); } }
        @keyframes rgb-split-hover { 0% { text-shadow: -1px 0 red, 1px 0 cyan; } 100% { text-shadow: 1px 0 red, -1px 0 cyan; } }
        @keyframes answer-thump { 50% { transform: scale(1.05); } }
        @keyframes answer-shake { 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes stress-shake { 0% { transform: translate(0,0); } 25% { transform: translate(-2px,2px); } 75% { transform: translate(2px,-2px); } 100% { transform: translate(0,0); } }
    </style>
</head>
<body class="glitch-active">

<div id="custom-cursor"></div>
<div class="pixel-overlay"></div>
<canvas id="matrix-canvas"></canvas>
<div class="retro-grid"></div>
<div id="panic-pulse"></div> 
<div id="scan-container"></div> 

<div class="terminal-window" id="term-win">
    
    <div class="header">
        <div class="h-left">
            <h1 id="main-header">COMPTIA <span style="font-size: 0.6em; color:#fff;">SIMULATOR</span></h1>
            <div class="status-container">
                <div class="jackpot-text status-line" id="status-text-1">> STATUS: WAITING...</div>
                <div class="jackpot-text status-line" id="status-text-2">> NET: IDLE</div>
            </div>
        </div>
        <div class="stats-area">
            <div class="score-box" id="score-ui">SCORE: 0</div>
            
            <div class="integrity-wrapper" id="integrity-wrap">
                <div class="integrity-label"><span>CORE INTEGRITY</span><span id="integrity-num">100%</span></div>
                <div class="integrity-container"><div class="integrity-fill" id="integrity-bar"></div></div>
            </div>

            <div class="integrity-wrapper" id="temp-wrap" style="margin-top: 5px;">
                <div class="integrity-label" id="temp-label" style="font-size: 0.7rem; color: #66ffd4;">
                    <span id="temp-text">SYSTEM STABLE</span><span id="temp-num">0%</span>
                </div>
                <div class="integrity-container" style="height: 12px; border: 1px solid var(--term-color);">
                    <div class="integrity-fill" id="temp-bar" style="width: 0%; background: #0affba; transition: width 1s linear;"></div>
                </div>
            </div>
            
            <button id="sound-toggle" class="audio-btn" onclick="AudioEngine.toggleMute()">[ AUDIO: ON ]</button>
        </div>
    </div>

    <div id="root-menu">
        <p style="font-size: 1.2rem; border-bottom: 1px dashed var(--term-color); padding-bottom: 9px;">> SELECT_CERTIFICATION:</p>
        <div class="menu-grid">
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="goToSubMenu('core1')">[1] COMPTIA A+ CORE 1 <span style="float:right">>></span></button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="goToSubMenu('core2')">[2] COMPTIA A+ CORE 2 <span style="float:right">>></span></button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="goToSubMenu('net')">[3] NETWORK+ <span style="float:right">>></span></button>
            <button class="btn" onmouseenter="AudioEngine.playMenuHover()" onclick="goToSubMenu('sec')">[4] SECURITY+ <span style="float:right">>></span></button>
            
            <button class="btn exam-mode" onmouseenter="AudioEngine.playMenuHover()" onclick="Dungeon.init()">
                [☠] DUNGEON_MODE [☠] <span style="float:right">>></span>
            </button>

            <div style="margin-top: 20px; border-top: 1px dashed var(--term-color); padding-top: 10px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="topic-search-input" placeholder='TRY: "CORE 1 + RAID"' style="flex-grow: 1; background: rgba(0,0,0,0.5); border: 1px solid var(--term-color); color: #fff; font-family: 'VT323'; font-size: 1.6rem; padding: 10px;">
                    <button class="btn" onclick="startTopicRun()" style="padding: 8px 20px; font-size: 1.2rem; margin: 0; opacity: 1; transform: none;">[ INITIATE ]</button>
                </div>
            </div>
        </div>
    </div>

    <div id="core1-menu" class="hidden">
        <div class="menu-grid">
            <button class="btn" onclick="transitionToQuiz('CORE1', 'Mobile')">[A] MOBILE DEVICES</button>
            <button class="btn" onclick="transitionToQuiz('CORE1', 'Networking')">[B] NETWORKING</button>
            <button class="btn" onclick="transitionToQuiz('CORE1', 'Hardware')">[C] HARDWARE</button>
            <button class="btn" onclick="transitionToQuiz('CORE1', 'Cloud')">[D] VIRTUALIZATION</button>
            <button class="btn" onclick="transitionToQuiz('CORE1', 'Troubleshoot')">[E] TROUBLESHOOTING</button>
            <button class="btn exam-mode" onclick="startExam('CORE1')">[X] EXAM_SIMULATION</button>
            <button class="btn btn-back" onclick="goToRoot()"> < BACK TO ROOT </button>
        </div>
    </div>
    <div id="core2-menu" class="hidden"><div class="menu-grid"><button class="btn btn-back" onclick="goToRoot()">< BACK</button></div></div>
    <div id="net-menu" class="hidden"><div class="menu-grid"><button class="btn btn-back" onclick="goToRoot()">< BACK</button></div></div>
    <div id="sec-menu" class="hidden"><div class="menu-grid"><button class="btn btn-back" onclick="goToRoot()">< BACK</button></div></div>

    <div id="quiz-ui" class="hidden quiz-container">
        <div class="quiz-header-bar">
            <div style="display:flex; gap: 20px;">
                <span onclick="shutdownSystem()" class="abort-btn">< ABORT</span>
                <span style="color:var(--term-color);">[TIME]: <span id="session-timer" style="color:#fff;">90:00</span></span>
                <span style="color:var(--term-color);">[REMAINING]: <span id="packet-counter" style="color:#fff;">00</span></span>
            </div>
            <span id="streak-text" style="font-weight: bold;">SYNCS: 0</span>
        </div>
        <div class="question-box"><span id="q-text" class="jackpot-text"></span></div>
        <div id="explanation-box"></div>
        <div class="options-list" id="opts-list"></div>
        <div id="pbq-area" class="pbq-wrapper"></div>
        <button id="pbq-submit-btn" onclick="submitPBQ()">[ EXECUTE_COMMAND ]</button>
        <button class="btn nav-btn hidden" id="next-btn" onclick="nextSeq()" style="margin-bottom: 10px;">>> NEXT_PACKET >> </button>
    </div>

    <div id="dungeon-ui" class="hidden">
        <div id="dungeon-mission-select">
            <h2 style="margin-bottom: 20px; text-decoration: underline;">>> SELECT TARGET SYSTEM <<</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <button class="btn" onclick="Dungeon.loadMission('CORE1')">CORE 1</button>
                <button class="btn" onclick="Dungeon.loadMission('CORE2')">CORE 2</button>
                <button class="btn" onclick="Dungeon.loadMission('NET')">NETWORK+</button>
                <button class="btn" onclick="Dungeon.loadMission('SEC')">SECURITY+</button>
                <button class="btn" style="grid-column: span 2; border-color: #ffd700; color: #ffd700;" onclick="Dungeon.loadMission('ALL')">>> CHAOS MODE <<</button>
            </div>
        </div>

        <div class="dungeon-header">
            <span>HP: <span id="p-hp" style="color:#0f0">100</span>/<span id="p-max-hp">100</span></span>
            <span>RAM: <span id="p-mana" style="color:#0af">50</span>/50</span>
            <span>LAYER: <span id="p-layer">1</span></span>
            <span><span id="p-wep">FISTS</span></span>
        </div>

        <div id="monster-viewport">
            <pre id="ascii-art-container"></pre>
            <div id="monster-hp-bar" style="position:absolute; bottom:0; left:0; width:100%; height:5px; background:red; transition:width 0.2s;"></div>
            <div id="monster-name" style="position:absolute; bottom:10px; right:10px; background:black; color:red; padding:2px 5px; font-weight:bold;"></div>
        </div>

        <div id="combat-log" class="combat-log-area"><div class="log-entry">> INITIALIZING DUNGEON...</div></div>
        
        <div id="dungeon-btns" class="dungeon-controls">
            <button class="btn" onclick="Dungeon.preCombat('attack')">[ ATTACK ]</button>
            <button class="btn" onclick="Dungeon.openSkills()">[ .EXE ]</button>
            <button class="btn" onclick="Dungeon.openInventory()">[ GEAR ]</button>
            <button class="btn" style="color:#888; border-color:#888;" onclick="Dungeon.flee()">[ FLEE ]</button>
        </div>

        <div id="inv-modal">
            <h2 style="border-bottom:1px solid #fff; padding-bottom:10px;">INVENTORY <button style="float:right; background:transparent; border:none; color:red; font-size:2rem; cursor:pointer;" onclick="document.getElementById('inv-modal').style.display='none'">[X]</button></h2>
            <div id="inv-list" class="inv-grid"></div>
        </div>
    </div>

    <div id="results-ui" class="hidden">
        <h1 style="font-size: 4rem; margin-bottom: 0px;" id="final-percent">0%</h1>
        <div id="breakdown-container"></div>
        <button class="btn nav-btn" style="margin-top: 20px;" onclick="location.reload()">>> REBOOT_SYSTEM <<</button>
    </div>

    <div id="fail-ui">
        <h1 class="fail-text">FATAL_ERROR</h1>
        <button class="nav-btn fail-restart-btn" onclick="location.reload()">>> RESTART</button>
    </div>
    
    <div id="secondary-status" class="jackpot-text"></div>
    <div id="warning-area"><div id="crit-warn" class="system-msg" style="display:none;"></div></div>
</div>

<div id="donate-widget">
    <button class="sys-btn kofi-btn" onclick="window.open('https://ko-fi.com/worldeater888', '_blank')">[ SUPPORT ]</button>
    <button class="sys-btn kas-btn" onclick="showCrypto()">>> KASPA <<</button>
</div>

<div id="ref-widget">
    <button class="sys-btn" style="color: #ff3333; border-color: #ff3333; font-size: 1.5rem; padding: 15px 30px; text-shadow: 0 0 10px #ff0000; box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);" onclick="toggleGlossary()">
        [STUDY GUIDE]
    </button>
</div>

<div id="glossary-ui" class="hidden">
    <div class="glossary-window">
        <div class="glossary-header">
            <span id="gloss-title">>> SELECT_DATABASE</span>
            <button class="close-btn" onclick="toggleGlossary()">[ X ]</button>
        </div>
        <div id="gloss-select-view" class="gloss-view">
            <div class="exam-select-grid">
                <button class="exam-select-btn" onclick="loadGlossaryExam('CORE1')"><span class="ex-title">CORE 1</span></button>
                <button class="exam-select-btn" onclick="loadGlossaryExam('CORE2')"><span class="ex-title">CORE 2</span></button>
                <button class="exam-select-btn" onclick="loadGlossaryExam('NET')"><span class="ex-title">NET+</span></button>
                <button class="exam-select-btn" onclick="loadGlossaryExam('SEC')"><span class="ex-title">SEC+</span></button>
            </div>
        </div>
        <div id="gloss-content-view" class="gloss-view hidden">
            <button id="gloss-back-btn" class="nav-btn" style="margin:0; width:auto;" onclick="showExamSelection()">< BACK</button>
            <div id="gloss-tabs" class="glossary-tabs"></div>
            <div id="glossary-content" class="glossary-grid"></div>
        </div>
    </div>
</div>

<div class="hacker-footer">
    <div class="ticker-content">>> SYS_LOG_START... WELCOME TO OPEN SOURCE COMPTIA SIMULATOR...</div>
</div>

<script src="db_init.js"></script>
<script src="questions_core1.js"></script>
<script>
    // --- GLOBAL STATE ---
    let qQueue = []; let currentScore = 0; let integrity = 100;
    let questionsAttempted = 0; let questionsCorrect = 0; let currentStreak = 0;
    let isExam = false; let isDead = false;
    let hudInterval, explainTimer;
    let tempLevel = 0; const TEMP_MAX = 100;
    let tagLedger = {};
    let matchState = { selected: null, pairsFound: 0 };

    const EXAM_BLUEPRINTS = {
        'CORE1': { 'Mobile': 0.14, 'Networking': 0.20, 'Hardware': 0.27, 'Cloud': 0.12, 'Troubleshoot': 0.27 },
        'CORE2': { 'Operating Systems': 0.27, 'Security': 0.24, 'Software Troubleshooting': 0.26, 'Operational Procedures': 0.23 },
        'NET': { 'Networking Fundamentals': 0.24, 'Network Implementation': 0.19, 'Network Operations': 0.16, 'Network Security': 0.19, 'Network Troubleshooting': 0.22 },
        'SEC': { 'General Concepts': 0.12, 'Threats & Vulnerabilities': 0.22, 'Security Architecture': 0.20, 'Security Operations': 0.26, 'Management & Governance': 0.20 }
    };

    // --- AUDIO ---
    const AudioEngine = {
        ctx: null, masterGain: null, isMuted: false,
        init: function() {
            try {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.3;
                this.masterGain.connect(this.ctx.destination);
                if (this.ctx.state === 'suspended') this.ctx.resume();
            } catch(e) {}
        },
        playSFX: function(type) { if(!this.ctx || this.isMuted) return; 
            const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const g = this.ctx.createGain(); 
            osc.connect(g); g.connect(this.masterGain);
            if(type==='click'){ osc.frequency.value=800; osc.type='square'; g.gain.value=0.01; osc.start(t); osc.stop(t+0.05); }
            if(type==='error'){ osc.frequency.value=150; osc.type='sawtooth'; g.gain.value=0.1; osc.start(t); osc.stop(t+0.3); }
            if(type==='success'){ osc.frequency.value=600; osc.frequency.exponentialRampToValueAtTime(1200,t+0.1); g.gain.value=0.1; osc.start(t); osc.stop(t+0.2); }
        },
        playMenuHover: function() { if(!this.ctx || this.isMuted) return; const t=this.ctx.currentTime; const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.connect(g); g.connect(this.masterGain); o.frequency.value=200; g.gain.value=0.01; o.start(t); o.stop(t+0.05); },
        playOptionHover: function() { this.playMenuHover(); },
        playGameOver: function() { this.playSFX('error'); },
        playExpType: function() { this.playMenuHover(); },
        toggleMute: function() { this.isMuted = !this.isMuted; if(this.masterGain) this.masterGain.gain.value = this.isMuted?0:0.3; }
    };

    // --- MAIN LOGIC ---
    window.onload = function() {
        AudioEngine.init();
        document.getElementById('term-win').classList.add('power-on');
        setTimeout(() => document.getElementById('root-menu').classList.remove('hidden'), 500);
        setInterval(drawRain, 50);
        cycleStatus();
    };

    function goToSubMenu(id) {
        document.getElementById('root-menu').classList.add('hidden');
        if(id==='core1') document.getElementById('core1-menu').classList.remove('hidden');
        if(id==='core2') document.getElementById('core2-menu').classList.remove('hidden');
        if(id==='net') document.getElementById('net-menu').classList.remove('hidden');
        if(id==='sec') document.getElementById('sec-menu').classList.remove('hidden');
    }

    function goToRoot() {
        ['core1-menu','core2-menu','net-menu','sec-menu'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('root-menu').classList.remove('hidden');
    }

    function transitionToQuiz(cert, module) {
        qQueue = fetchQuestions([cert, module]);
        shuffleQueue();
        startQuiz();
    }

    function startExam(cert) {
        const blueprint = EXAM_BLUEPRINTS[cert];
        let deck = [];
        for(let [mod, weight] of Object.entries(blueprint)) {
            let pool = fetchQuestions([cert, mod]);
            deck = deck.concat(pool.slice(0, Math.ceil(90*weight)));
        }
        qQueue = deck;
        shuffleQueue();
        isExam = true;
        startQuiz();
    }

    function startQuiz() {
        if(qQueue.length===0) { alert("NO DATA"); return; }
        resetGame();
        switchScreen('root-menu', 'quiz-ui');
        loadSeq();
        startHUD();
    }

    function shuffleQueue() {
        for (let i = qQueue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [qQueue[i], qQueue[j]] = [qQueue[j], qQueue[i]];
        }
    }

    function fetchQuestions(tags) {
        return (typeof MASTER_DATABASE !== 'undefined' ? MASTER_DATABASE : []).filter(q => tags.every(t => q.tags.includes(t)));
    }

    function resetGame() {
        integrity=100; currentScore=0; questionsCorrect=0; questionsAttempted=0; isDead=false;
        document.getElementById('integrity-bar').style.width = "100%";
        document.getElementById('breakdown-container').innerHTML = "";
    }

    function switchScreen(from, to) {
        if(from) document.getElementById(from).classList.add('hidden');
        document.querySelectorAll('.hidden').forEach(el => {
            if(el.id !== to) el.classList.add('hidden'); // Ensure cleanup
        });
        document.getElementById(to).classList.remove('hidden');
    }

    function loadSeq() {
        if(integrity<=0) return;
        if(qQueue.length===0) { finish(); return; }
        const q = qQueue.pop();
        window.currentQ = q;
        
        document.getElementById('opts-list').innerHTML = "";
        document.getElementById('q-text').innerText = q.question;
        document.getElementById('explanation-box').style.display='none';
        document.getElementById('next-btn').classList.add('hidden');
        
        // Simple MCQ Render
        const opts = q.options.map((t,i)=>({t, i}));
        opts.sort(()=>Math.random()-0.5);
        opts.forEach(o => {
            const b = document.createElement('button');
            b.className = 'option-btn';
            b.innerText = "> " + o.t;
            b.onclick = () => processResult(o.i === q.answer, b);
            document.getElementById('opts-list').appendChild(b);
        });
        document.getElementById('opts-list').style.display='flex';
    }

    function processResult(isCorrect, btn) {
        questionsAttempted++;
        const all = document.querySelectorAll('.option-btn');
        all.forEach(b => b.disabled=true);
        if(isCorrect) {
            btn.classList.add('correct');
            integrity = Math.min(100, integrity+5);
            questionsCorrect++;
            AudioEngine.playSFX('success');
        } else {
            btn.classList.add('wrong');
            integrity -= 15;
            AudioEngine.playSFX('error');
        }
        document.getElementById('integrity-bar').style.width = integrity+"%";
        document.getElementById('integrity-num').innerText = Math.floor(integrity)+"%";
        
        if(integrity<=0 && !isDead) { isDead=true; document.getElementById('fail-ui').style.display='flex'; }
        else document.getElementById('next-btn').classList.remove('hidden');
        
        const exp = document.getElementById('explanation-box');
        exp.innerText = window.currentQ.explanation || "No data.";
        exp.style.display='block';
    }

    function nextSeq() { loadSeq(); }

    function finish() {
        switchScreen('quiz-ui', 'results-ui');
        document.getElementById('final-percent').innerText = Math.floor((questionsCorrect/questionsAttempted)*100) + "%";
        document.getElementById('results-ui').style.display='flex';
    }

    function startHUD() {
        if(hudInterval) clearInterval(hudInterval);
        hudInterval = setInterval(()=>{
            if(integrity<=0) clearInterval(hudInterval);
            // Temp Logic...
        }, 1000);
    }

    // --- DUNGEON LOGIC (FIXED) ---
    const Dungeon = {
        player: { hp: 100, maxHp: 100, ram: 50, maxRam: 50, layer: 1, xp: 0, lvl: 1 },
        inventory: [], equipped: { weapon: null, accessory: null },
        currentEnemy: null, inCombat: false, pendingAction: null, activeMissionTag: 'ALL',
        
        itemsDB: [
            { id: 'w1', name: 'Crimper Tool', type: 'wep', dmg: 5, tier: 1 },
            { id: 'w2', name: 'CAT5e Whip', type: 'wep', dmg: 12, tier: 2 },
            { id: 'w3', name: 'Mech Keyboard', type: 'wep', dmg: 25, tier: 3 },
            { id: 'p1', name: 'Energy Drink', type: 'pot', effect: 'ram', val: 30, tier: 1 }
        ],
        skills: [
            { id: 's1', name: 'SUDO_SMASH.EXE', cost: 10, dmg: 30, desc: 'Heavy physical damage.' },
            { id: 's2', name: 'FIREWALL.BAT', cost: 15, heal: 0, effect: 'block', desc: 'Block next attack.' },
            { id: 's3', name: 'DEFRAG.MSI', cost: 20, heal: 40, desc: 'Repair HP sectors.' }
        ],
        enemiesDB: [
            { name: "PACKET SNIFFER", hp: 40, maxHp:40, dmg:5, xp:15, art: "      /\\  /\\\n     /  \\/  \\\n    (  o  o  )  \n     \\  --  /\n      /    \\ " },
            { name: "SCRIPT KIDDIE", hp: 50, maxHp:50, dmg:8, xp:20, art: "      .--.\n     |o_o |\n     |:_/ |\n    //   \\ \\\n   (|     | )\n  /'\\_   _/`\\" },
            { name: "TROJAN HORSE", hp: 150, maxHp:150, dmg:18, xp:80, art: "         /\\\n        /  \\\n       |    |\n       |    |\n      /|____|\\\n     /_|    |_\\\n    /  |    |  \\" },
            { name: "ZERO-DAY EXPLOIT", hp: 666, maxHp:666, dmg:50, xp:1000, art: "    ERROR ERROR\n    E .--. .--. \n    R |__| |__| \n    R |  | |  | \n    O |__| |__| \n    ! SYSTEM FAIL !" }
        ],

        init: function() {
            // Force Hide Root, Show Dungeon
            document.getElementById('root-menu').classList.add('hidden');
            document.getElementById('dungeon-ui').classList.remove('hidden'); 
            
            // Show Mission Select Overlay
            document.getElementById('dungeon-mission-select').style.display = 'flex';
        },

        loadMission: function(tag) {
            this.activeMissionTag = tag;
            if (tag === 'ALL') qQueue = [...(typeof MASTER_DATABASE!=='undefined'?MASTER_DATABASE:[])];
            else qQueue = (typeof MASTER_DATABASE!=='undefined'?MASTER_DATABASE:[]).filter(q => q.tags.includes(tag));
            
            shuffleQueue();
            
            if (qQueue.length === 0) { alert("NO DATA FOUND."); return; }

            document.getElementById('dungeon-mission-select').style.display = 'none';
            this.player = { hp: 100, maxHp: 100, ram: 50, maxRam: 50, layer: 1, xp: 0, lvl: 1 };
            this.inventory = [];
            this.equipped = { weapon: this.itemsDB[0], accessory: null };
            
            this.log(">> MISSION START: " + tag, 'log-good');
            setTimeout(() => this.encounter(), 500);
            this.updateUI();
        },

        encounter: function() {
            if(this.player.layer > 7) { this.log(">> YOU WIN.", 'log-good'); return; }
            if(this.player.layer < 7 && Math.random() > 0.7) this.triggerEvent();
            else this.spawnMonster();
        },

        triggerEvent: function() {
            this.inCombat = false;
            document.getElementById('ascii-art-container').innerText = "\n      [ ? ]\n\n   DATA NODE FOUND";
            document.getElementById('monster-name').innerText = "UNKNOWN NODE";
            document.getElementById('monster-hp-bar').style.width = "0%";
            
            const loot = this.itemsDB[Math.floor(Math.random()*this.itemsDB.length)];
            this.inventory.push(loot);
            this.log(`>> LOOT: You found [${loot.name}]!`, 'log-loot');
            
            setTimeout(() => { this.player.layer++; this.encounter(); }, 2000);
            this.updateUI();
        },

        spawnMonster: function() {
            this.inCombat = true;
            let idx = this.player.layer <= 2 ? 0 : (this.player.layer <= 5 ? 2 : 3);
            if(idx >= this.enemiesDB.length) idx = this.enemiesDB.length-1;
            
            this.currentEnemy = JSON.parse(JSON.stringify(this.enemiesDB[idx]));
            document.getElementById('ascii-art-container').innerText = this.currentEnemy.art;
            document.getElementById('monster-name').innerText = this.currentEnemy.name;
            this.updateEnemyHP();
            this.log(`>> A wild ${this.currentEnemy.name} appears!`);
            this.updateUI();
        },

        preCombat: function(actionType, skillObj = null) {
            if (!this.inCombat) return;
            if (actionType === 'skill' && skillObj) {
                if (this.player.ram < skillObj.cost) { this.log(">> NO RAM!", 'log-bad'); return; }
                this.pendingAction = { type: 'skill', data: skillObj };
            } else {
                this.pendingAction = { type: 'attack' };
            }

            document.getElementById('dungeon-ui').classList.add('hidden');
            document.getElementById('quiz-ui').classList.remove('hidden');
            
            let q = qQueue.length > 0 ? qQueue.pop() : MASTER_DATABASE[Math.floor(Math.random()*MASTER_DATABASE.length)];
            
            document.getElementById('q-text').innerText = ">> DECRYPT PACKET TO ATTACK:\n" + q.question;
            document.getElementById('opts-list').innerHTML = '';
            
            let opts = q.options.map((t, i) => ({ t, isC: i === q.answer }));
            opts.sort(()=>Math.random()-0.5);

            opts.forEach(o => {
                const b = document.createElement('button'); b.className = 'option-btn'; b.innerText = `> ${o.t}`;
                b.onclick = () => this.resolveRound(o.isC);
                document.getElementById('opts-list').appendChild(b);
            });
            document.getElementById('pbq-area').style.display='none';
            document.getElementById('explanation-box').style.display='none';
            document.getElementById('next-btn').classList.add('hidden');
        },

        resolveRound: function(isCorrect) {
            document.getElementById('quiz-ui').classList.add('hidden');
            document.getElementById('dungeon-ui').classList.remove('hidden');
            
            if (isCorrect) {
                AudioEngine.playSFX('success');
                let dmg = this.pendingAction.type === 'attack' ? (this.equipped.weapon ? this.equipped.weapon.dmg : 2) : this.pendingAction.data.dmg || 0;
                if(this.pendingAction.type === 'skill') this.player.ram -= this.pendingAction.data.cost;
                
                this.currentEnemy.hp -= dmg;
                this.log(`>> ATTACK SUCCESS! ${dmg} DMG.`, 'log-good');
            } else {
                AudioEngine.playSFX('error');
                this.log(">> DECRYPTION FAILED!", 'log-bad');
            }
            this.updateEnemyHP();

            if (this.currentEnemy.hp <= 0) {
                this.log(">> ENEMY DEFEATED.", 'log-loot');
                setTimeout(() => { this.player.layer++; this.encounter(); }, 1500);
            } else {
                setTimeout(() => {
                    this.player.hp -= this.currentEnemy.dmg;
                    this.log(`>> ENEMY HITS FOR ${this.currentEnemy.dmg} DMG`, 'log-bad');
                    if(this.player.hp<=0) { alert("GAME OVER"); location.reload(); }
                    this.updateUI();
                }, 800);
            }
            this.updateUI();
        },

        updateEnemyHP: function() {
            const pct = Math.max(0, (this.currentEnemy.hp / this.currentEnemy.maxHp) * 100);
            document.getElementById('monster-hp-bar').style.width = pct + "%";
        },
        updateUI: function() {
            document.getElementById('p-hp').innerText = this.player.hp;
            document.getElementById('p-mana').innerText = this.player.ram;
            document.getElementById('p-layer').innerText = this.player.layer;
            document.getElementById('p-wep').innerText = this.equipped.weapon ? this.equipped.weapon.name : "FISTS";
            const log = document.getElementById('combat-log'); log.scrollTop = log.scrollHeight;
        },
        log: function(msg, cls) {
            const div = document.createElement('div'); div.className = 'log-entry ' + cls; div.innerText = msg;
            document.getElementById('combat-log').appendChild(div);
        },
        openInventory: function() {
            document.getElementById('inv-modal').style.display = 'flex';
            const list = document.getElementById('inv-list'); list.innerHTML = '';
            this.inventory.forEach((item, i) => {
                const d = document.createElement('div'); d.className='inv-item'; d.innerText=item.name;
                d.onclick=()=>{ this.equipItem(item, i); document.getElementById('inv-modal').style.display='none'; };
                list.appendChild(d);
            });
        },
        equipItem: function(item, i) {
            if(item.type==='wep') this.equipped.weapon = item;
            if(item.type==='pot') { this.player.ram+=item.val; this.inventory.splice(i,1); }
            this.updateUI();
        },
        openSkills: function() {
            document.getElementById('inv-modal').style.display = 'flex';
            const list = document.getElementById('inv-list'); list.innerHTML = '';
            this.skills.forEach(s => {
                const d = document.createElement('div'); d.className='inv-item'; d.innerText=s.name;
                d.onclick=()=>{ this.preCombat('skill', s); document.getElementById('inv-modal').style.display='none'; };
                list.appendChild(d);
            });
        },
        flee: function() {
            this.log(">> FLEEING...", 'log-bad');
            setTimeout(() => { this.player.layer++; this.encounter(); }, 1000);
        }
    };

    // --- GLOSSARY (Combined from previous requests) ---
    const GLOSSARY_DATA_DB = {
        'CORE1': { 'PORTS': [{k:'80', v:'HTTP'}, {k:'443', v:'HTTPS'}], 'HARDWARE': [{k:'ATX', v:'12x9.6'}] },
        'CORE2': { 'OS': [{k:'WIN', v:'Windows'}] }, 'NET': {}, 'SEC': {}
    };
    function toggleGlossary() { document.getElementById('glossary-ui').classList.toggle('hidden'); showExamSelection(); }
    function showExamSelection() { document.getElementById('gloss-select-view').classList.remove('hidden'); document.getElementById('gloss-content-view').classList.add('hidden'); }
    function loadGlossaryExam(key) {
        document.getElementById('gloss-select-view').classList.add('hidden');
        document.getElementById('gloss-content-view').classList.remove('hidden');
        const content = document.getElementById('glossary-content'); content.innerHTML = '';
        if(GLOSSARY_DATA_DB[key]) {
            Object.keys(GLOSSARY_DATA_DB[key]).forEach(cat => {
                GLOSSARY_DATA_DB[key][cat].forEach(i => {
                    const d = document.createElement('div'); d.className='gloss-item';
                    d.innerHTML = `<span class="gloss-key">${i.k}</span>${i.v}`;
                    content.appendChild(d);
                });
            });
        }
    }

    // --- FLUFF ---
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const drops = Array(Math.floor(canvas.width/14)).fill(1);
    function drawRain() {
        ctx.fillStyle='rgba(0,0,0,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle='#0affba'; ctx.font='14px monospace';
        drops.forEach((y,i)=>{
            const text = String.fromCharCode(0x30A0+Math.random()*96);
            ctx.fillText(text, i*14, y*14);
            if(y*14>canvas.height && Math.random()>0.975) drops[i]=0;
            drops[i]++;
        });
    }
    
    function cycleStatus() {
        const texts = ["> CONNECTING...", "> ENCRYPTING...", "> CHECKING PORTS..."];
        document.getElementById('status-text-1').innerText = texts[Math.floor(Math.random()*texts.length)];
        setTimeout(cycleStatus, 4000);
    }
</script>
</body>
</html>
