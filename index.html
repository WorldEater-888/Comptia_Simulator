<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>COMPTIA SIMULATOR</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* COLORS */
            --term-color: #0affba;       /* Neon Mint */
            --term-dim: rgba(10, 255, 186, 0.4); 
            
            /* GLOWS */
            --glow-color: rgba(10, 255, 186, 0.6); 
            
            /* VARIABLES */
            --edge-opacity: 0; 
            --shake-amp: 0px; 
            --sway-speed: 5s;
        }

        /* --- GLOBAL RESETS --- */
        * { 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            cursor: auto !important; 
        }
        
        html, body {
            width: 100%;
            overflow-x: hidden;
        }
        
        body {
            background-color: #050505; 
            margin: 0; padding: 0;
            font-family: 'VT323', monospace;
            color: var(--term-color);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            
            /* Base glow */
            text-shadow: 0 0 8px var(--glow-color);
            
            /* Sway maintained */
            animation: ghost-sway var(--sway-speed) ease-in-out infinite alternate;
            transition: color 0.5s ease;
        }

        /* --- CRT EFFECTS --- */
        .scan-line {
            position: fixed;
            left: 0; width: 100%;
            background: var(--term-color); opacity: 0.15; z-index: 600; 
            pointer-events: none;
        }
        
        /* DARK RARE SCANLINE */
        .dark-scan-line {
            position: fixed;
            left: 0; width: 100%;
            background: rgba(0, 0, 0, 0.9); 
            z-index: 850; 
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
        }

        @keyframes scan-drop { 
            0% { top: -10%; opacity: 0; } 
            10% { opacity: 0.2; } 
            100% { top: 110%; opacity: 0; } 
        }
        
        @keyframes dark-scan-drop { 
            0% { top: -20%; opacity: 0; } 
            5% { opacity: 0.8; } 
            100% { top: 120%; opacity: 0.8; } 
        }

        .pixel-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 900; 
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px);
        }
        
        #matrix-canvas { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: -2; opacity: 0.25; 
        }
        
        .retro-grid {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 45vh; z-index: -3;
            background: linear-gradient(transparent 0%, rgba(0, 255, 128, 0.1) 2%, transparent 3%), 
                        linear-gradient(90deg, transparent 0%, rgba(0, 255, 128, 0.1) 2%, transparent 3%);
            background-size: 50px 50px;
            transform: perspective(600px) rotateX(70deg) scale(2);
            opacity: 0.4;
            animation: grid-move 10s linear infinite;
        }

        #panic-pulse {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 850;
            box-shadow: inset 0 0 150px #ff0000; 
            opacity: var(--edge-opacity);
            mix-blend-mode: overlay;
            animation: pulse-breath-erratic 2s infinite; 
        }

        /* --- TERMINAL WINDOW --- */
        .terminal-window {
            width: 100%; height: 100%;
            border: none;
            background: rgba(0, 5, 5, 0.25); 
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(2px);
            padding: 10px;
            display: none; flex-direction: column; position: relative;
            z-index: 100; overflow: hidden;
            transition: border-color 0.2s ease, filter 0.2s ease; 
        }
        .power-on { 
            display: flex !important;
            animation: turnOn 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards; 
        }

        /* --- HEADER --- */
        .header { 
            border-bottom: 2px solid var(--term-color);
            padding-bottom: 5px; margin-bottom: 10px; 
            display: flex; flex-direction: column; gap: 5px;
            flex-shrink: 0; position: relative;
            transition: border-color 0.2s ease;
        }
        .header-top { 
            display: flex; justify-content: space-between; align-items: flex-start; width: 100%;
        }
        
        .h-left {
            display: flex; align-items: center;
        }

        /* HEADER TEXT */
        .h-left h1 { 
            margin: 0;
            font-family: 'VT323', monospace; 
            font-size: 2.0rem;
            letter-spacing: 2px; 
            line-height: 1;
            font-weight: bold;
            color: var(--term-color); 
            padding-top: 0px; 
        }
        
        /* THE CURSOR BOX */
        .cursor-block {
            display: inline-block;
            width: 0.6em;
            height: 1em;
            background-color: var(--term-color);
            vertical-align: bottom;
            margin-left: 5px;
            margin-bottom: 5px; 
            animation: blink-cursor 0.8s steps(2) infinite;
            box-shadow: 0 0 8px var(--term-color);
        }
        @keyframes blink-cursor { 0% { opacity: 1; } 100% { opacity: 0; } }

        /* --- ERRATIC PULSE ANIMATION --- */
        @keyframes erratic-glow {
            0%, 100% { text-shadow: 0 0 5px var(--glow-color); opacity: 1; }
            50% { text-shadow: 0 0 15px var(--glow-color), 0 0 20px var(--term-color); opacity: 0.9; }
        }
        .erratic-target {
            animation: erratic-glow 2s ease-in-out infinite;
        }

        /* --- STATIC JITTER (REDUCED 70%) --- */
        @keyframes static-jitter {
            /* Base State */
            0% { opacity: 1; text-shadow: 0 0 5px currentColor; transform: translate(0,0); }
            
            /* Micro Jitters (0.15px range) */
            10% { transform: translate(0.1px, 0.1px); }
            20% { transform: translate(-0.1px, 0); }
            30% { transform: translate(0, 0.2px); }
            40% { transform: translate(0.2px, -0.2px); }
            50% { transform: translate(-0.2px, 0.2px); }
            60% { transform: translate(0, -0.2px); }
            70% { transform: translate(0.2px, 0); }
            80% { transform: translate(-0.2px, -0.2px); }
            
            /* Subtle RGB Glitch (Reduced distance to 1px) */
            95% { opacity: 0.98; text-shadow: 1px 0 #00ffff, -1px 0 #ff00ff; transform: translateX(0.5px); }
            96% { opacity: 0.95; text-shadow: -1px 0 #00ffff, 1px 0 #ff00ff; transform: translateX(-0.5px); }
            
            100% { opacity: 1; text-shadow: 0 0 5px currentColor; transform: translate(0,0); }
        }

        /* Donation Buttons */
        .donate-group { display: flex; gap: 6px; }
        .sys-btn {
            background: rgba(0, 0, 0, 0.8);
            font-family: 'VT323', monospace;
            font-size: 0.9rem; font-weight: bold;
            cursor: pointer; padding: 4px 8px;
            border: 1px solid;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            transition: all 0.2s ease;
            text-transform: uppercase;
            animation: static-jitter 1s infinite; 
        }
        .sys-btn:active { transform: translate(1px, 1px);
            box-shadow: 0 0 10px var(--term-color); background: var(--term-color); color: #000; }
        .kofi-btn { color: #ffd700; border-color: #ffd700; }
        .kas-btn { color: #70c7ba; border-color: #70c7ba; }

        /* Integrity & Temp Bars */
        .header-stats-row { display: flex; align-items: flex-end; justify-content: space-between; width: 100%; }
        .bars-group { display: flex; flex-direction: column; gap: 4px; width: 65%; }
        .integrity-wrapper { width: 100%; display: flex; align-items: center; gap: 5px; }
        .integrity-label { font-size: 0.8rem; letter-spacing: 1px; font-weight:bold; min-width: 65px; }
        
        .integrity-container { 
            flex-grow: 1; height: 10px; border: 1px solid var(--term-color); 
            background: rgba(0,0,0,0.8); padding: 1px; position: relative;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* PHOSPHORUS EFFECT LAYER */
        .integrity-ghost {
            position: absolute; top: 1px; left: 1px; bottom: 1px;
            background: #fff; opacity: 0;
            width: 100%;
            pointer-events: none; z-index: 1;
            transition: width 0.2s linear, opacity 2.5s ease-out; 
        }

        /* Main Bar */
        .integrity-fill {
            position: relative; z-index: 2;
            height: 100%; background: var(--term-color);
            box-shadow: 0 0 5px var(--term-color);
            width: 100%;
            transition: width 0.2s cubic-bezier(0.1, 0.9, 0.2, 1); 
        }
        
        /* CRITICAL STATE */
        .integrity-critical { 
            animation: crit-border-pulse 0.2s infinite !important; 
            background: rgba(0,0,0,0.8) !important;
        }
        @keyframes purple-phos-glow {
    0% {
        /* Bright flash */
        box-shadow: 0 0 10px #bc13fe, 0 0 20px #bc13fe, inset 0 0 10px #bc13fe;
        opacity: 1;
    }
    50% {
        /* The "After Image" expansion */
        box-shadow: 0 0 30px #bc13fe, 0 0 50px rgba(188, 19, 254, 0.4);
        opacity: 0.8;
    }
    100% {
        /* Fade out */
        box-shadow: 0 0 60px transparent;
        opacity: 0.4;
    }
}

        .damage-flash .integrity-ghost {
            opacity: 1 !important;
            background: #fff !important;
            box-shadow: 0 0 20px #fff;
            transition: none; 
        }

        /* Temp Strobe Animation */
        @keyframes temp-strobe {
            0% { background-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
            50% { background-color: #ffffff; box-shadow: 0 0 25px #ffffff; }
            100% { background-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
        }
        .strobe-active { animation: temp-strobe 0.2s infinite !important; }

        /* Audio Toggle */
        .audio-btn { 
            font-family: 'VT323', monospace; text-transform: uppercase; 
            letter-spacing: 1px; font-size: 1.0rem; background: transparent; 
            border: 1px solid var(--term-color); color: inherit; padding: 2px 5px;
            cursor: pointer; position: relative; overflow: hidden; transition: 0.2s;
        }

        /* --- MENUS & BUTTONS --- */
        .menu-grid { 
            display: grid; grid-template-columns: 1fr; 
            gap: 10px; margin-top: 5px; overflow-y: auto; padding-bottom: 20px;
        }

        .btn { 
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--term-color); 
            color: var(--term-color); 
            font-family: 'VT323', monospace; 
            font-size: 1.4rem; padding: 12px 15px;
            cursor: pointer; text-align: left; 
            transition: 0.2s; position: relative; overflow: hidden; 
            opacity: 0; transform: translateY(10px); 
            
            box-shadow: 0 0 8px var(--term-color), inset 0 0 8px rgba(10, 255, 186, 0.2);
            text-shadow: 0 0 5px var(--glow-color);
            
            /* REDUCED CONSTANT JITTER */
            animation: static-jitter 3s infinite;
        }

        .btn.visible { 
            opacity: 1 !important; 
            transform: translateY(0);
        }
        
        .btn:hover {
            transform: translateX(10px) !important;
            background: rgba(10, 255, 186, 0.1); border-color: #fff; text-shadow: 0 0 15px #fff;
            box-shadow: 0 0 15px var(--term-color), inset 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .btn:active { 
            background: #fff; color: #000; 
            box-shadow: 0 0 30px #fff; border-color: #fff; 
            transform: translate(-1px, -1px) !important;
        }
        
        /* EXAM BUTTON SPECIFIC - SOLID RED */
        .btn.exam-mode { 
            border-color: #ff0000; 
            background-color: #cc0000 !important; /* Solid Red */
            color: #ffffff !important; 
            text-shadow: 0 0 5px #fff;
            box-shadow: 0 0 10px #ff0000, inset 0 0 10px #500;
        }
        .btn.exam-mode:hover {
            background-color: #ff0000 !important;
            box-shadow: 0 0 20px #ff0000;
        }
        .btn.exam-mode:active { 
            background: #fff !important; color: #cc0000 !important; 
            box-shadow: 0 0 60px #ff0000; 
        }

        .nav-btn { 
            position: fixed; bottom: 15px; left: 10px; width: calc(100% - 20px);
            font-weight: bold; text-align: center; 
            background: #000; color: var(--term-color); border: 2px solid var(--term-color);
            font-family: 'VT323', monospace; font-size: 1.8rem; padding: 15px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.8); z-index: 500; text-transform: uppercase;
            animation: static-jitter 3s infinite;
        }
        .nav-btn:active { background: var(--term-color); color: #000; box-shadow: 0 0 40px var(--term-color); }

        /* --- QUIZ AREA --- */
        .quiz-container { 
            display: flex; flex-direction: column; flex-grow: 1; 
            overflow-y: auto; overflow-x: hidden; padding-bottom: 90px;
        }
        .quiz-header-bar {
            display:flex; justify-content:space-between; align-items:center; 
            border-bottom: 1px solid var(--term-color); 
            padding-bottom: 5px; margin-bottom: 10px; font-size: 1.2rem;
        }
        .question-box { 
            font-size: 1.6rem; line-height: 1.2; margin-bottom: 15px; 
            background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent);
            border-left: 6px solid var(--term-color); padding: 10px; 
            color: #ffffff !important; text-shadow: none;
            /* Keeps gentle drift for question box only */
            animation: random-drift 7s ease-in-out infinite alternate;
        }
        #explanation-box {
            margin-bottom: 15px; padding: 10px; border: 2px dashed var(--term-color);
            background: rgba(0,10,0,0.6); font-size: 1.4rem; color: #ffffff; display: none;
            text-shadow: 0 0 5px var(--glow-color);
        }
        .options-list { display: flex; flex-direction: column; gap: 10px; }
        
        .option-btn { 
            background: rgba(0, 0, 0, 0.7); border: 2px solid var(--term-color); 
            color: #ffffff !important; padding: 12px; 
            font-family: 'VT323', monospace; font-size: 1.4rem; text-align: left; 
            cursor: pointer; position: relative;
            box-shadow: 0 0 8px var(--term-color), inset 0 0 5px rgba(255,255,255,0.1);
            animation: static-jitter 3s infinite;
        }

        .option-btn:active { 
            background: #fff !important; padding-left: 15px; color: #000 !important; border-color: #fff; box-shadow: 0 0 40px #fff;
        }
        .option-btn.correct { background: var(--term-color) !important; color: black !important; border-color: white;
            box-shadow: 0 0 50px var(--term-color) !important; animation: answer-thump 0.3s ease-out forwards !important;
        }
        .option-btn.wrong { background: #a00 !important; color: white !important; border-color: red;
            box-shadow: 0 0 50px red !important; animation: answer-shake 0.4s ease-in-out forwards !important;
        }

        /* --- PBQ --- */
        .pbq-wrapper { display: none; width: 100%; flex-direction: column; gap: 15px; }
        .cmd-input-line { display: flex; align-items: center;
            background: rgba(0,0,0,0.8); border: 1px solid var(--term-color); padding: 10px; font-size: 1.3rem;
        }
        #cmd-input { flex-grow: 1; background: transparent; border: none; color: #fff; font-family: inherit; font-size: inherit; outline: none; }
        .match-container { display: flex; justify-content: space-between; gap: 10px; }
        .match-col { display: flex; flex-direction: column; gap: 10px; width: 48%; }
        .match-item { border: 1px solid var(--term-color); background: rgba(0, 20, 20, 0.6);
            padding: 10px; text-align: center; font-size: 1.1rem; color: #fff; transition: 0.2s;
            animation: static-jitter 3s infinite;
        }
        .match-item.selected { background: var(--term-color); color: #000; box-shadow: 0 0 15px var(--term-color); }
        .match-item.matched { opacity: 0.5; text-decoration: line-through; pointer-events: none; }
        .match-item.wrong { background: #a00; color: #fff; box-shadow: 0 0 15px #f00; }

        /* --- ANIMATIONS --- */
        @keyframes turnOn { 0% { transform: scaleY(0.005) scaleX(0); opacity: 0; filter: brightness(4); } 60% { transform: scaleY(0.005) scaleX(1); opacity: 1; filter: brightness(2); } 100% { transform: scaleY(1) scaleX(1); opacity: 1; filter: brightness(1); } }
        
        @keyframes stress-shake { 
            0% { transform: translate(0, 0); } 20% { transform: translate(-1px, 1px); } 
            40% { transform: translate(1px, -1px); } 60% { transform: translate(-0.5px, 0.5px); } 
            80% { transform: translate(0.5px, -0.5px); } 100% { transform: translate(0, 0); } 
        }
        
        @keyframes ghost-sway { 
            0% { transform: translate(0, 0) rotate(0deg); } 
            50% { transform: translate(-0.4px, 0.8px) rotate(-0.02deg); } 
            100% { transform: translate(-0.8px, 0) rotate(-0.02deg); } 
        }
        
        /* VERTICAL/SIDEWAYS SCANLINE FOR TITLE */
        @keyframes scan-pass-vertical {
            0% { left: -100%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 200%; opacity: 0; }
        }
        .black-scan {
            position: relative; overflow: hidden; display: inline-block;
        }
        .black-scan::after {
            content: ''; 
            position: absolute; 
            top: 0; 
            left: -50%;          
            width: 25px;         
            height: 100%;        
            background: #000; 
            opacity: 0.8;
            animation: scan-pass-vertical 2.5s infinite ease-in-out;
            pointer-events: none;
        }
        
        @keyframes random-drift { 0% { transform: translate(0, 0); } 100% { transform: translate(1.5px, 1px); } }
        @keyframes grid-move { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        @keyframes intense-pulse { 0% { opacity: 0.7; box-shadow: 0 0 5px currentColor; filter: brightness(1); } 100% { opacity: 1; box-shadow: 0 0 25px currentColor; filter: brightness(3); } }
        @keyframes label-flash { 0%, 100% { color: #ff0000; text-shadow: 0 0 5px #ff0000; } 50% { color: #fff; text-shadow: 0 0 2px #fff; } }
        @keyframes fail-entry { 0% { transform: scale(1.1); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes vertical-rgb-split { 0% { text-shadow: 0 -2px #ff0000, 0 2px #00ffff; } 50% { text-shadow: -2px 0 #ff0000, 2px 0 #00ffff; } 100% { text-shadow: 0 -2px #ff0000, 0 2px #00ffff; } }
        @keyframes pulse-breath-erratic { 0% { opacity: var(--edge-opacity); } 50% { opacity: calc(var(--edge-opacity) * 0.4); } 100% { opacity: var(--edge-opacity); } }
        @keyframes answer-thump { 0% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 100px #fff; } 100% { transform: scale(1); } }
        @keyframes answer-shake { 0% { transform: translateX(0); } 20% { transform: translateX(-10px); } 40% { transform: translateX(10px); } 60% { transform: translateX(-10px); } 80% { transform: translateX(10px); } 100% { transform: translateX(0); } }

        /* Helpers */
        .stress-active { animation: stress-shake 0.4s infinite !important; }
        .temp-pulse-active { animation: intense-pulse 0.5s infinite alternate !important; }
        .label-crit { animation: label-flash 0.3s infinite; }

        .hex-dump { position: absolute; font-family: monospace; font-size: 12px; color: var(--term-color); opacity: 0.4; z-index: -1; white-space: pre; pointer-events: none; text-shadow: 0 0 2px var(--glow-color); }
        .float-text { position: absolute; font-weight: bold; font-size: 1.5rem; pointer-events: none; animation: floatUp 2s forwards; text-shadow: 0 0 10px currentColor; z-index: 2000; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* --- SCREENS --- */
        #start-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background-color: #000; z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        #fail-ui { display: none; text-align: center; position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; z-index: 2000; background: rgba(5, 0, 0, 0.95); flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; padding: 20px; overflow: hidden; }
        .fail-visible { display: flex !important; opacity: 1 !important; pointer-events: auto !important; animation: fail-entry 0.3s ease-out forwards; color: #ccffff; }
        
        /* FAIL TEXT: Retro Font */
        .fail-text { font-size: 1.5rem; font-family: 'Press Start 2P', cursive; word-break: break-word; color:#fff; animation: vertical-rgb-split 0.1s infinite; text-shadow: 3px 0 red, -3px 0 blue; margin-bottom: 20px; }

        .fail-restart-btn { background: rgba(255, 0, 0, 0.3) !important; border-color: red !important; color: #fff !important; position: relative; margin-top:20px; animation: stress-shake 0.8s infinite !important; }

        .hidden { display: none !important; }

    </style>
</head>
<body class="glitch-active">

<div class="pixel-overlay"></div>
<canvas id="matrix-canvas"></canvas>
<div class="retro-grid"></div>
<div id="panic-pulse"></div> 
<div id="scan-container"></div> 

<div id="start-overlay" onclick="bootSystem()">
    <div id="intro-title" class="black-scan" style="margin-bottom: 50px; font-size: 3rem; color: #fff; letter-spacing: 5px; text-shadow: 0 0 10px var(--term-color); font-family: 'VT323'; font-weight: bold;"></div>
    
    <div style="font-size: 1.2rem; color: var(--term-color); text-transform: uppercase; letter-spacing: 3px; animation: blink-cursor 1s infinite;">
        >> TAP_TO_INITIALIZE <<
    </div>
    <div style="margin-top: 100px; font-size: 0.6rem; opacity: 0.5; font-family: 'Press Start 2P', cursive; line-height: 1.5;">
        MOBILE_CORE_V2.0 // SOUL_RESTORED
    </div>
</div>

<div class="terminal-window" id="term-win">
    
    <div class="header">
        <div class="header-top">
          
          <div class="h-left">
                <h1 id="main-header" class="erratic-target"></h1>
                <div id="header-cursor" class="cursor-block"></div>
            </div>
            <div class="donate-group">
                <button class="sys-btn kofi-btn" onclick="AudioEngine.playMenuHover(); window.open('https://ko-fi.com/worldeater888', '_blank')">[DONATE]</button>
                <button class="sys-btn kas-btn" onclick="AudioEngine.playMenuHover(); showCrypto()">[KAS]</button>
          </div>
        </div>
        
        <div class="header-stats-row">
            <div class="bars-group">
                <div class="integrity-wrapper" id="integrity-wrap">
                    <div class="integrity-label">INTEGRITY</div>
                    <div class="integrity-container" id="integrity-cont">
                        <div class="integrity-ghost" id="integrity-ghost"></div>
                        <div class="integrity-fill" id="integrity-bar"></div>
                    </div>
                </div>
                <div class="integrity-wrapper" id="temp-wrap">
                    <div class="integrity-label" id="temp-label" style="color: #fff;">TEMP</div>
                    <div class="integrity-container" style="border: 1px solid #ffffff;">
                        <div class="integrity-fill" id="temp-bar" style="width: 0%; background: #0affba; transition: width 1s linear;"></div>
                    </div>
                </div>
            </div>
            <div style="text-align: right;">
                 <div id="score-ui" style="font-weight: bold; font-size: 1.2rem; margin-bottom: 5px;">SYNC: 0</div>
                 <button id="sound-toggle" class="audio-btn" onclick="AudioEngine.toggleMute()">[NOISE:ON]</button>
            </div>
        </div>
    </div>

    <div id="root-menu">
        <p style="font-size: 1.1rem; border-bottom: 1px dashed var(--term-color); padding-bottom: 5px;">> SELECT_CERTIFICATION:</p>
        <div class="menu-grid">
            <button class="btn" onclick="AudioEngine.playMenuHover(); goToSubMenu('core1', 'A+ CORE 1')">[1] COMPTIA A+ CORE 1</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); goToSubMenu('core2', 'A+ CORE 2')">[2] COMPTIA A+ CORE 2</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); goToSubMenu('net', 'NETWORK+')">[3] NETWORK+</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); goToSubMenu('sec', 'SECURITY+')">[4] SECURITY+</button>
        </div>
    </div>

    <div id="core1-menu" class="hidden">
        <p style="font-size: 1.1rem; border-bottom: 1px dashed var(--term-color);">> CORE_1 // MODULES:</p>
        <div class="menu-grid">
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('CORE1', 'Hardware')">[A] HARDWARE_CORE</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('CORE1', 'Networking')">[B] NETWORKING</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('CORE1', 'Mobile')">[C] MOBILE</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('CORE1', 'Cloud')">[D] CLOUD_OPS</button>
            <button class="btn exam-mode" onclick="AudioEngine.playMenuHover(); startExam('CORE1')"><span>[X] EXAM_SIMULATION</span></button>
            <button class="btn" style="border-color: #666; color: #888;" onclick="AudioEngine.playMenuHover(); goToRoot()"> < BACK TO ROOT </button>
        </div>
    </div>
    
    <div id="core2-menu" class="hidden">
        <div class="menu-grid">
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('CORE2', 'OS')">[A] OS_CONCEPTS</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('CORE2', 'Security')">[B] SECURITY</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('CORE2', 'Software')">[C] SOFTWARE</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('CORE2', 'Ops')">[D] OPS_PROCEDURES</button>
            <button class="btn exam-mode" onclick="AudioEngine.playMenuHover(); startExam('CORE2')"><span>[X] EXAM_SIMULATION</span></button>
            <button class="btn" style="border-color: #666; color: #888;" onclick="AudioEngine.playMenuHover(); goToRoot()"> < BACK </button>
        </div>
    </div>
    <div id="net-menu" class="hidden">
        <div class="menu-grid">
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('NET', 'Fundamentals')">[A] FUNDAMENTALS</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('NET', 'Implement')">[B] IMPLEMENTATION</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('NET', 'Ops')">[C] OPERATIONS</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('NET', 'Security')">[D] SECURITY</button>
            <button class="btn exam-mode" onclick="AudioEngine.playMenuHover(); startExam('NET')"><span>[X] EXAM_SIMULATION</span></button>
            <button class="btn" style="border-color: #666; color: #888;" onclick="AudioEngine.playMenuHover(); goToRoot()"> < BACK </button>
        </div>
    </div>
    <div id="sec-menu" class="hidden">
        <div class="menu-grid">
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('SEC', 'Attacks')">[A] THREATS_ATTACKS</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('SEC', 'Arch')">[B] ARCHITECTURE</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('SEC', 'Implement')">[C] IMPLEMENTATION</button>
            <button class="btn" onclick="AudioEngine.playMenuHover(); transitionToQuiz('SEC', 'Gov')">[D] GOVERNANCE</button>
            <button class="btn exam-mode" onclick="AudioEngine.playMenuHover(); startExam('SEC')"><span>[X] EXAM_SIMULATION</span></button>
            <button class="btn" style="border-color: #666; color: #888;" onclick="AudioEngine.playMenuHover(); goToRoot()"> < BACK </button>
        </div>
    </div>

    <div id="quiz-ui" class="hidden quiz-container">
        <div class="quiz-header-bar">
            <span onclick="shutdownSystem()" style="color:#fff; text-decoration:underline; font-weight:bold;">< ABORT</span>
            <span style="opacity:0.8;">[TIME]: <span id="session-timer" style="color:#fff;">90:00</span></span>
            <span style="opacity:0.8;">[PKT]: <span id="packet-counter" style="color:#fff;">00</span></span>
        </div>
        <div class="question-box"><span id="q-text" class="erratic-target"></span></div>
        <div id="explanation-box"></div>
        <div class="options-list" id="opts-list"></div>
        <div id="pbq-area" class="pbq-wrapper"></div>
        <button id="pbq-submit-btn" class="btn" onclick="submitPBQ()" style="display:none; margin-top:10px;">[ EXECUTE_COMMAND ]</button>
        <button class="nav-btn hidden" id="next-btn" onclick="nextSeq()">>> NEXT_PACKET >></button>
    </div>

    <div id="results-ui" class="hidden" style="text-align: center; padding-top: 10px; overflow-y: auto; height: 100%;">
        <h1 style="font-size: 5rem; margin-bottom: 0px;" id="final-percent">0%</h1>
        <p style="font-size: 2rem; margin-bottom: 10px;">> DIAGNOSTIC COMPLETE</p>
        <div id="breakdown-container" style="text-align:left; margin:20px;"></div>
        <button class="nav-btn" style="position:relative; margin-top:30px;" onclick="AudioEngine.playMenuHover(); location.reload()">>> EXCOMMUNICATE</button>
    </div>

    <div id="fail-ui">
        <h1 class="fail-text">SYSTEM_CORRUPTED</h1>
        <p style="font-size: 1.5rem; color: #ccffff;">> _ALL_IS_LOST</p>
        <button class="nav-btn fail-restart-btn" onclick="AudioEngine.playMenuHover(); location.reload()">>> PURGE_SYSTEM</button>
    </div>
</div>

<script>
    /* AUDIO ENGINE */
    const AudioEngine = {
        ctx: null, masterGain: null, delayNode: null, isPlaying: false, isMuted: false, 
        init: function() {
             try {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.3;
                this.masterGain.connect(this.ctx.destination);
                this.delayNode = this.ctx.createDelay(); this.delayNode.delayTime.value = 0.35; 
                const feedback = this.ctx.createGain(); feedback.gain.value = 0.4;
                this.delayNode.connect(feedback); feedback.connect(this.delayNode); this.delayNode.connect(this.masterGain);
                if (this.ctx.state === 'suspended') this.ctx.resume();
                this.startMusic();
            } catch(e) {}
        },
        startMusic: function() { if(this.isPlaying) return; this.isPlaying = true; this.musicLoop(); },
        musicLoop: function() {
            if (!this.isPlaying) return;
            const now = this.ctx.currentTime;
            const drone = this.ctx.createOscillator(); const droneGain = this.ctx.createGain();
            drone.type = 'sine'; drone.frequency.value = 55; 
            droneGain.gain.setValueAtTime(0.05, now); droneGain.gain.linearRampToValueAtTime(0, now + 6);
            drone.connect(droneGain); droneGain.connect(this.masterGain); drone.start(now); drone.stop(now + 6);
            const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
            osc.type = 'triangle'; osc.frequency.value = [43.65, 55, 65.41][Math.floor(Math.random()*3)];
            g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.1, now + 2); g.gain.linearRampToValueAtTime(0, now + 7); 
            osc.connect(g); g.connect(this.masterGain); g.connect(this.delayNode); osc.start(now); osc.stop(now + 7);
            setTimeout(() => this.musicLoop(), 4500); 
        },
        playSFX: function(type) {
            if (!this.ctx || this.isMuted) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
            osc.connect(g); g.connect(this.masterGain);
            if (type === 'type') { osc.type = 'square'; osc.frequency.setValueAtTime(2000+Math.random()*1000, t); g.gain.setValueAtTime(0.01, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.03); osc.start(t); osc.stop(t+0.03); }
            else if (type === 'click') { osc.type = 'square'; osc.frequency.setValueAtTime(800, t); g.gain.setValueAtTime(0.01, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.05); osc.start(t); osc.stop(t+0.05); } 
            else if (type === 'success') { osc.type = 'sine'; osc.frequency.setValueAtTime(600, t); osc.frequency.exponentialRampToValueAtTime(1200, t+0.1); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.2); g.connect(this.delayNode); osc.start(t); osc.stop(t+0.2); } 
            else if (type === 'error') { osc.type = 'triangle'; osc.frequency.setValueAtTime(150+Math.random()*50, t); osc.frequency.linearRampToValueAtTime(50, t+0.4); g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.4); osc.start(t); osc.stop(t+0.4); } 
        },
        playMenuHover: function() {
            if (!this.ctx || this.isMuted) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator(); const g = this.ctx.createGain();
            osc.type = 'square'; osc.frequency.setValueAtTime(600 + Math.random() * 800, t); g.gain.setValueAtTime(0.02, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.15); 
            osc.connect(g); g.connect(this.masterGain); osc.start(t); osc.stop(t + 0.15);
        },
        toggleMute: function() {
            this.isMuted = !this.isMuted;
            if(this.masterGain) this.masterGain.gain.setTargetAtTime(this.isMuted ? 0 : 0.3, this.ctx.currentTime, 0.1);
            document.getElementById('sound-toggle').innerText = this.isMuted ? "[AUDIO:OFF]" : "[AUDIO:ON]";
        }
    };

    /* VARS */
    let matchState = { selected: null, pairsFound: 0 };
    let qQueue = []; let currentScore = 0; window.integrity = 100;
    let explainTimer = null; let questionsCorrect = 0;
    let questionsAttempted = 0; let isDead = false;
    let hudInterval = null; let sessionTime = 5400; let tempLevel = 0;
    const TEMP_MAX = 60;
    
    /* DATABASE */
    const MASTER_DATABASE = [
        { tags: ["CORE1", "Hardware"], question: "A technician installs 16GB RAM, but Windows reports 4GB usable. Why?", options: ["OS is 32-bit (x86)", "RAM is unseated", "BIOS outdated", "Motherboard limitation"], answer: 0, explanation: "32-bit operating systems have a hard memory address limit of 4GB (2^32 addresses)." },
        { tags: ["CORE1", "Hardware"], question: "Which RAID level provides striping with parity, requiring at least three drives?", options: ["RAID 0", "RAID 1", "RAID 5", "RAID 10"], answer: 2, explanation: "RAID 5 requires a minimum of three drives and provides fault tolerance through distributed parity." },
        { tags: ["CORE1", "Hardware"], question: "A projector's image is flickering. What is the most likely cause?", options: ["Bulb life ending", "Loose cable", "Keystone setting", "Incompatible resolution"], answer: 1, explanation: "Flickering is often caused by a loose VGA or HDMI cable connection. A dying bulb usually dims." },
        { tags: ["CORE1", "Hardware"], type: "match", question: "Match the cable standard to its maximum transfer speed.", pairs: [ { left: "Cat 5e", right: "1 Gbps" }, { left: "Cat 6a", right: "10 Gbps" }, { left: "USB 2.0", right: "480 Mbps" }, { left: "Thunderbolt 3", right: "40 Gbps" } ], explanation: "Cat5e is limited to 1Gbps. Cat6a supports 10Gbps up to 100m. USB 2.0 is 480Mbps. Thunderbolt 3 creates a massive 40Gbps pipe." },
        { tags: ["CORE1", "Hardware"], question: "A technician is applying thermal paste to a CPU during a new build. Which of the following describes the primary function of this material?", options: ["To glue the heatsink to the processor permanently", "To fill microscopic air gaps between the CPU lid and the heatsink", "To provide electrical insulation to the CPU pins", "To cool the CPU using active airflow"], answer: 1, explanation: "The purpose of thermal paste is to fill microscopic air gaps between the CPU lid and the heatsink base. Air is a thermal insulator, while the paste is a thermal conductor, ensuring efficient heat transfer." },
        { tags: ["CORE1", "Hardware"], question: "Which specific DC voltage rail is primarily used to power high-load components such as motors in hard drives, fans, and the CPU?", options: ["3.3 Volts", "5 Volts", "12 Volts", "115 Volts"], answer: 2, explanation: "The 12 Volt (12V) rail is used for high-power components like motors (fans/drives) and the CPU/GPU." },
        { tags: ["CORE1", "Networking"], question: "A user can print to a local printer but cannot access the internet. What is the likely issue?", options: ["DNS Server", "Gateway Address", "DHCP Scope", "Loopback"], answer: 1, explanation: "The Gateway address directs traffic outside the local network. Without it, local traffic works, but internet fails." },
        { tags: ["CORE1", "Networking"], question: "Which port does SSH use by default?", options: ["21", "22", "23", "80"], answer: 1, explanation: "SSH (Secure Shell) uses port 22. Telnet uses 23, FTP uses 21." },
        { tags: ["CORE1", "Networking"], question: "Which 802.11 standard operates strictly at 5GHz?", options: ["802.11a", "802.11b", "802.11g", "802.11n"], answer: 0, explanation: "Legacy 802.11a operates only on 5GHz. 802.11ac also is 5GHz, but 'n' and 'ax' can do both." },
        { tags: ["CORE1", "Networking"], type: "terminal", question: " A user cannot access the internet. You suspect a DNS issue. Enter the command to clear the local DNS resolver cache.", validCommands: ["ipconfig /flushdns", "ipconfig/flushdns"], hint: "The command starts with 'ipconfig' followed by a switch to 'flush' the data.", explanation: "The 'ipconfig /flushdns' command purges the local DNS resolver cache, forcing the computer to request new records from the DNS server." },
        { tags: ["CORE1", "Mobile"], question: "What is the most secure screen lock method?", options: ["Biometric/Passcode", "Pattern", "Swipe", "None"], answer: 0, explanation: "Biometrics backed by a complex alphanumeric passcode provides the highest consumer-level security." },
        { tags: ["CORE1", "Mobile"], question: "Which component in a mobile device is responsible for changing screen orientation?", options: ["Gyroscope/Accelerometer", "Digitizer", "Inverter", "Magnetometer"], answer: 0, explanation: "The gyroscope and accelerometer detect physical movement and orientation changes." },
        { tags: ["CORE1", "Mobile"], question: "A laptop battery is swollen. What should the technician do?", options: ["Puncture it", "Freeze it", "Replace immediately", "Compress it"], answer: 2, explanation: "Swollen batteries are a fire hazard (lithium-ion). They must be replaced and disposed of properly immediately." },
        { tags: ["CORE1", "Cloud"], question: "Which hypervisor runs directly on hardware (Bare Metal)?", options: ["Type 1", "Type 2", "VDI", "Container"], answer: 0, explanation: "Type 1 hypervisors (like ESXi or Hyper-V) run directly on the hardware without an underlying OS." },
        { tags: ["CORE1", "Cloud"], question: "A company rents software hosted by a vendor (e.g., Salesforce). What model is this?", options: ["IaaS", "PaaS", "SaaS", "DaaS"], answer: 2, explanation: "SaaS (Software as a Service) provides fully hosted applications to end users." },
        { tags: ["CORE2", "OS"], question: "Which Windows command line tool is used to manage disk partitions?", options: ["Diskpart", "Format", "Chkdsk", "Defrag"], answer: 0, explanation: "Diskpart is the command-line utility for managing drives, partitions, and volumes." },
        { tags: ["CORE2", "OS"], question: "A user needs to run a program as Administrator. Which option should they use?", options: ["Run as Service", "Run as Administrator", "Compatibility Mode", "Safe Mode"], answer: 1, explanation: "Right-clicking and selecting 'Run as Administrator' elevates privileges for that specific session." },
        { tags: ["CORE2", "Security"], question: "What is the principle of granting only the permissions needed to do a job?", options: ["Least Privilege", "Separation of Duties", "Job Rotation", "Implicit Deny"], answer: 0, explanation: "Least Privilege ensures users have only the bare minimum access rights required for their role." },
        { tags: ["CORE2", "Security"], question: "Which type of malware demands payment to unlock files?", options: ["Worm", "Trojan", "Ransomware", "Spyware"], answer: 2, explanation: "Ransomware encrypts user data and demands payment (crypto) for the decryption key." },
        { tags: ["NET", "Ops"], type: "terminal", question: " You need to trace the route packets take to google.com to identify a failed hop. Enter the command.", validCommands: ["tracert google.com", "traceroute google.com"], hint: "In Windows, the command is 'tracert'. In Linux, it's 'traceroute'.", explanation: "Tracert (Windows) or Traceroute (Linux/Mac) maps the hops packets take to a destination." },
        { tags: ["NET", "Fundamentals"], question: "Which layer of the OSI model handles routing (IP addresses)?", options: ["Layer 2", "Layer 3", "Layer 4", "Layer 7"], answer: 1, explanation: "Layer 3 is the Network Layer, where routers and IP addressing operate." },
        { tags: ["NET", "Fundamentals"], question: "What is the decimal equivalent of the binary number 1010?", options: ["8", "10", "12", "16"], answer: 1, explanation: "8 (1) + 0 + 2 (1) + 0 = 10." },
        { tags: ["SEC", "Attacks"], question: "What type of attack embeds malicious script into a trusted website?", options: ["SQL Injection", "XSS (Cross-Site Scripting)", "Buffer Overflow", "Bluejacking"], answer: 1, explanation: "XSS involves injecting malicious scripts that execute in the victim's browser." },
        { tags: ["SEC", "Attacks"], question: "Which attack relies on guessing passwords using a predefined list of words?", options: ["Brute Force", "Dictionary Attack", "Rainbow Table", "Spraying"], answer: 1, explanation: "A Dictionary Attack uses a list of common words. Brute force tries every combination." },
        { tags: ["CORE1", "Hardware"], question: "Which component of a liquid cooling system is responsible for exchanging heat from the hot liquid to the air using fans?", options: ["Water Block", "Reservoir", "Radiator", "Pump"], answer: 2, explanation: "The Radiator acts as the heat exchanger where fans blow air through fins to cool the liquid down before it returns to the components." },
    ];

    function fetchQuestions(tags) { return MASTER_DATABASE.filter(q => tags.every(t => q.tags.includes(t))); }

    /* --- VISUALS --- */
    function spawnScanline() {
        if(isDead) return;
        const line = document.createElement('div'); line.className = 'scan-line';
        line.style.height = (Math.random() * 3 + 1) + 'px';
        line.style.animation = `scan-drop ${Math.random() * 5 + 4}s linear forwards`;
        document.getElementById('scan-container').appendChild(line);
        setTimeout(() => line.remove(), 10000);
        setTimeout(spawnScanline, Math.random() * 8000 + 6000); 
    }
    spawnScanline();
    
    // NEW: SPAWN RARE DARK SCANLINE
    function spawnDarkScanline() {
        if(isDead) return;
        if(Math.random() > 0.7) { // 30% chance to spawn when called
            const line = document.createElement('div'); line.className = 'dark-scan-line';
            line.style.height = (Math.random() * 10 + 5) + 'px'; // Thicker
            line.style.animation = `dark-scan-drop 0.5s linear forwards`; // Fast drop
            document.getElementById('scan-container').appendChild(line);
            setTimeout(() => line.remove(), 600);
        }
        setTimeout(spawnDarkScanline, Math.random() * 15000 + 10000); // Rare (10-25s)
    }
    spawnDarkScanline();

    function triggerRandomGlitch() {
        if(isDead) return;
        const chaos = 1 - (integrity / 100);
        if(Math.random() < 0.05 + (chaos * 0.5)) {
            const targets = document.querySelectorAll('.btn, .question-box, h1');
            if(targets.length > 0) {
                const target = targets[Math.floor(Math.random()*targets.length)];
                target.classList.add('random-glitch-active');
                setTimeout(() => target.classList.remove('random-glitch-active'), 200);
            }
        }
        setTimeout(triggerRandomGlitch, 200 + (integrity * 5));
    }
    
    function spawnHexDump() {
        if(isDead) return;
        const chars = "0123456789ABCDEF"; let str = "";
        for(let r=0; r<6; r++) { str += "0x";
            for(let i=0; i<4; i++) str += chars[Math.floor(Math.random()*16)]; str += "\n";
        }
        const el = document.createElement('div'); el.className = "hex-dump";
        el.style[Math.random() > 0.5 ? 'left' : 'right'] = Math.random() * 15 + "%"; el.style.top = Math.random() * 90 + "%";
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), 8000);
        setTimeout(spawnHexDump, Math.random() * 3000 + 2000);
    }
    
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const fontSize = 14; 
    const columns = Math.floor(canvas.width / fontSize);
    const drops = Array(columns).fill(1); 
    const baseChars = "01010x<>!@#{}[]ZEUS"; 

    function drawRain() {
        if(Math.random() > 0.6) { requestAnimationFrame(drawRain); return; } 
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--term-color'); 
        ctx.font = fontSize + 'px monospace';
        for(let i=0; i<drops.length; i++) {
            const char = baseChars[Math.floor(Math.random()*baseChars.length)];
            ctx.fillText(char, i*fontSize, drops[i]*fontSize);
            if(drops[i]*fontSize > canvas.height && Math.random() > 0.99) drops[i] = 0; 
            drops[i]++;
        }
        requestAnimationFrame(drawRain);
    }
    drawRain();

    function scrambleText(element, finalString, duration=500) {
        const alphabet = "0101010101XYZ<>";
        let start = Date.now();
        let charCount = 0;
        function update() {
            let prog = (Date.now() - start) / duration;
            if(prog >= 1) { element.innerText = finalString; return; }
            let txt = "";
            for(let i=0; i<finalString.length; i++) {
                if(i < finalString.length * prog) txt += finalString[i];
                else txt += alphabet[Math.floor(Math.random()*alphabet.length)];
            }
            element.innerText = txt;
            charCount++;
            if(charCount % 2 === 0) AudioEngine.playSFX('type'); 
            requestAnimationFrame(update);
        }
        update();
    }

    function typeExplain(element, text) {
        if (explainTimer) { clearTimeout(explainTimer); explainTimer = null; }
        element.style.display = 'block'; element.innerHTML = "";
        let i = 0;
        function type() {
            if (i < text.length) { 
                element.innerHTML += text.charAt(i); i++; 
                if(i % 2 === 0) AudioEngine.playSFX('type');
                explainTimer = setTimeout(type, 20);
            }
        }
        type();
    }

    /* --- HEADER JACKPOT (FIXED) --- */
    let typeWriterTimeouts = [];
    
    function clearTypewriter() {
        typeWriterTimeouts.forEach(id => clearTimeout(id));
        typeWriterTimeouts = [];
    }

    function typewriterJackpot(targetId, text) {
        clearTypewriter();
        const el = document.getElementById(targetId);
        if(!el) return;
        el.innerHTML = "";
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_[]<>";
        let i = 0;
        
        function addChar() {
            if (i >= text.length) return;
            const targetChar = text[i];
            let cycles = 0;
            const maxCycles = 3; 
            
            const span = document.createElement('span');
            span.style.fontFamily = "'VT323', monospace";
            el.appendChild(span);
            
            function cycle() {
                if (cycles < maxCycles) {
                    span.innerText = chars[Math.floor(Math.random() * chars.length)];
                    cycles++;
                    typeWriterTimeouts.push(setTimeout(cycle, 50));
                } else {
                    span.innerText = targetChar;
                    AudioEngine.playSFX('type');
                    i++;
                    typeWriterTimeouts.push(setTimeout(addChar, 50));
                }
            }
            cycle();
        }
        addChar();
    }

    /* HUD */
    function startHUD() {
        if (hudInterval) clearInterval(hudInterval);
        hudInterval = setInterval(() => {
            if(isDead) return;
            if (sessionTime > 0) sessionTime--;
            let mins = Math.floor(sessionTime / 60); let secs = sessionTime % 60;
            document.getElementById('session-timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            // FIXED TEMP LOGIC: 1 SECOND UPDATES (60s total to max)
            if (document.getElementById('next-btn').classList.contains('hidden')) {
                if (tempLevel < TEMP_MAX) tempLevel++;
                updateTempVisuals();
            }
        }, 1000);
    }

    function updateTempVisuals() {
        const bar = document.getElementById('temp-bar');
        const label = document.getElementById('temp-label');
        const pct = tempLevel / TEMP_MAX;
        
        bar.style.width = `${pct * 100}%`;
        bar.classList.remove('strobe-active'); 

        if (tempLevel >= 55) { 
            label.innerText = "!! CRITICAL !!"; label.style.color = "#ff0000"; label.classList.add('label-crit'); bar.classList.add('strobe-active'); 
        } else if (tempLevel >= 45) { 
            label.innerText = "DANGER"; label.style.color = "#ff0000"; label.classList.add('label-crit'); bar.style.backgroundColor = "#ff0000";
        } else if (tempLevel >= 30) { 
            label.innerText = "WARNING"; label.style.color = "#ffaa00"; bar.style.backgroundColor = "#ffaa00";
        } else if (tempLevel >= 15) { 
            label.innerText = "CAUTION"; label.style.color = "#ffff00"; bar.style.backgroundColor = "#ffff00";
        } else { 
            label.innerText = "TEMP"; label.style.color = "#ffffff"; label.classList.remove('label-crit'); bar.style.backgroundColor = "#0affba";
        }
    }

    /* SYSTEM LOGIC */
    function bootSystem() {
        document.getElementById('start-overlay').style.display = 'none';
        AudioEngine.init(); 
        const term = document.getElementById('term-win');
        term.style.display = 'flex'; term.classList.add('power-on');
        
        setTimeout(() => {
            typewriterJackpot('main-header', 'COMPTIA_SIM');
        }, 800);

        const btns = document.querySelectorAll('.btn, .nav-btn, .option-btn, .sys-btn');
        btns.forEach((b, i) => { 
            // RANDOMIZE GLOW PULSE FOR ERRATIC LOOK
            b.classList.add('erratic-target');
            b.style.animationDelay = `${Math.random() * 2}s`;
            
            setTimeout(() => { b.classList.add('visible'); }, 1500 + (i * 150)); 
        });
        spawnHexDump(); triggerRandomGlitch();
    }

    function goToSubMenu(type, titleName) {
        typewriterJackpot('main-header', titleName || 'SIM');
        
        document.getElementById('root-menu').classList.add('hidden');
        document.getElementById(type + '-menu').classList.remove('hidden');
        const target = document.getElementById(type + '-menu');
        const btns = target.querySelectorAll('.btn');
        btns.forEach((b, i) => { b.classList.remove('visible'); setTimeout(() => { b.classList.add('visible'); }, 100 + (i * 100)); });
    }

    function goToRoot() {
        typewriterJackpot('main-header', 'ROOT_ACCESS');
        
        document.querySelectorAll('[id$="-menu"]').forEach(m => m.classList.add('hidden'));
        document.getElementById('root-menu').classList.remove('hidden');
    }
    
    function transitionToQuiz(certTag, moduleTag) {
        qQueue = fetchQuestions([certTag, moduleTag]);
        if(qQueue.length === 0) { alert("NO DATA"); return; }
        for (let i = qQueue.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [qQueue[i], qQueue[j]] = [qQueue[j], qQueue[i]]; }
        startQuiz();
    }
    
    function startExam(certTag) {
        qQueue = fetchQuestions([certTag]).slice(0, 90);
        startQuiz();
    }

    function startQuiz() {
        document.querySelectorAll('[id$="-menu"], #root-menu').forEach(m => m.classList.add('hidden'));
        document.getElementById('quiz-ui').classList.remove('hidden');
        resetGame(); startHUD(); loadSeq();
    }
    
    function resetGame() {
        currentScore = 0; integrity = 100; tempLevel = 0; isDead = false; questionsCorrect = 0; questionsAttempted = 0;
        document.getElementById('fail-ui').classList.remove('fail-visible'); 
        updateSystemState();
    }

    function updateSystemState() {
        if (integrity > 100) integrity = 100; if (integrity < 0) integrity = 0;
        
        // Handle Main Bar
        const bar = document.getElementById('integrity-bar');
        const ghost = document.getElementById('integrity-ghost');
        
        bar.style.width = `${integrity}%`;
        
        // Sync ghost bar with a slight delay for phosphorus effect
        // We set ghost to same width but with a transition lag defined in CSS
        ghost.style.width = `${integrity}%`;
        
        document.getElementById('score-ui').innerText = `SYNC: ${currentScore}`;
        const root = document.documentElement; 
        
        let hue;
        if(integrity > 50) { hue = 140 + ((integrity - 50) * 0.4); } else { hue = integrity * 1.2; }
        const newColor = `hsl(${hue}, 100%, 50%)`;
        const glowColor = `hsla(${hue}, 100%, 50%, 0.6)`;
        
        root.style.setProperty('--term-color', newColor);
        root.style.setProperty('--glow-color', glowColor);
        const panicLevel = (100 - integrity) / 100;
        root.style.setProperty('--edge-opacity', panicLevel * 0.8);
        root.style.setProperty('--shake-amp', (panicLevel * 0.5) + 'px');

        const termWindow = document.getElementById('term-win');
        
        // CRITICAL LOGIC - VISUALS ONLY ON BAR ITSELF
        if(integrity < 30) {
            termWindow.classList.add('stress-active'); 
            document.getElementById('integrity-cont').classList.add('integrity-critical');
            bar.style.backgroundColor = '#ff0000'; // Make bar red
            bar.style.boxShadow = '0 0 15px #ff0000';
        } else {
            termWindow.classList.remove('stress-active'); 
            document.getElementById('integrity-cont').classList.remove('integrity-critical');
            bar.style.backgroundColor = ''; // Reset to default var
            bar.style.boxShadow = '';
        }
        if(integrity <= 0 && !isDead) triggerFailure();
    }

    function triggerFailure() { 
        isDead = true; document.getElementById('fail-ui').classList.add('fail-visible'); AudioEngine.playSFX('error');
    }

    function loadSeq() {
        if (integrity <= 0 || qQueue.length === 0) { if(qQueue.length === 0) finish(); return; }
        tempLevel = 0; updateTempVisuals();
        const q = qQueue.pop(); window.currentQ = q;
        document.getElementById('packet-counter').innerText = qQueue.length;
        scrambleText(document.getElementById('q-text'), q.question, 400);
        document.getElementById('explanation-box').style.display = 'none';
        document.getElementById('next-btn').classList.add('hidden');
        document.getElementById('opts-list').innerHTML = '';
        document.getElementById('pbq-area').style.display = 'none';
        document.getElementById('pbq-submit-btn').style.display = 'none';
        if (q.type === 'terminal' || q.type === 'match') renderPBQ(q); else renderMCQ(q);
    }

    function renderMCQ(q) {
        const optsList = document.getElementById('opts-list');
        q.options.forEach((o, i) => {
            const b = document.createElement('button'); b.className = 'option-btn erratic-target'; b.innerText = `> ${o}`;
            b.style.animationDelay = `${Math.random() * 2}s`;
            b.onclick = () => processResult(i === q.answer, b);
            optsList.appendChild(b);
        });
    }

    function renderPBQ(q) {
        const area = document.getElementById('pbq-area');
        area.innerHTML = ''; area.style.display = 'flex';
        document.getElementById('pbq-submit-btn').style.display = 'block';
        
        if (q.type === 'terminal') {
            area.innerHTML = `<div class="cmd-input-line"><span>C:\\></span><input type="text" id="cmd-input" autocomplete="off"></div>`;
            setTimeout(() => document.getElementById('cmd-input').focus(), 100);
        } else if (q.type === 'match') {
            matchState = { selected: null, pairsFound: 0 };
            area.innerHTML = `<div class="match-container"><div class="match-col" id="col-left"></div><div class="match-col" id="col-right"></div></div>`;
            q.pairs.forEach((p, i) => {
                const l = document.createElement('div'); l.className='match-item erratic-target'; l.innerText=p.left; l.dataset.id=i; l.dataset.side='l'; l.onclick=e=>handleMatch(e.target);
                document.getElementById('col-left').appendChild(l);
                const r = document.createElement('div'); r.className='match-item erratic-target'; r.innerText=p.right; r.dataset.id=i; r.dataset.side='r'; r.onclick=e=>handleMatch(e.target);
                document.getElementById('col-right').appendChild(r);
           });
            const rCol = document.getElementById('col-right');
            for (let i = rCol.children.length; i >= 0; i--) rCol.appendChild(rCol.children[Math.random() * i | 0]);
        }

        if (q.hint) {
            const hintContainer = document.createElement('div');
            hintContainer.style.marginTop = "15px"; hintContainer.style.borderTop = "1px dashed #555"; hintContainer.style.paddingTop = "10px";
            const hintBtn = document.createElement('button'); hintBtn.className = 'sys-btn'; hintBtn.innerText = '[ DECRYPT_HINT ]';
            hintBtn.style.color = "#ffff00"; hintBtn.style.borderColor = "#ffff00"; hintBtn.style.width = "100%";
            const hintMsg = document.createElement('div'); hintMsg.innerText = ">> DATA_MINED: " + q.hint;
            hintMsg.style.display = "none"; hintMsg.style.color = "#ffff00";
            hintMsg.style.fontFamily = "'Press Start 2P', cursive"; hintMsg.style.fontSize = "0.7rem"; hintMsg.style.lineHeight = "1.5"; hintMsg.style.marginTop = "10px";
            hintMsg.style.animation = "text-pulse-glow 3s infinite alternate"; 
            hintBtn.onclick = () => {
                AudioEngine.playSFX('click'); hintBtn.style.display = 'none'; hintMsg.style.display = 'block';
            };
            hintContainer.appendChild(hintBtn); hintContainer.appendChild(hintMsg); area.appendChild(hintContainer);
        }
    }

    function handleMatch(el) {
        if(el.classList.contains('matched')) return;
        if(matchState.selected === el) { el.classList.remove('selected'); matchState.selected=null; return; }
        if(!matchState.selected) { matchState.selected = el; el.classList.add('selected'); }
        else {
            const prev = matchState.selected;
            if(prev.dataset.side === el.dataset.side) { prev.classList.remove('selected'); el.classList.add('selected'); matchState.selected = el; return; }
            if(prev.dataset.id === el.dataset.id) {
                prev.classList.remove('selected'); el.classList.remove('selected'); prev.classList.add('matched'); el.classList.add('matched');
                AudioEngine.playSFX('click'); matchState.pairsFound++; matchState.selected = null;
            } else {
                prev.classList.remove('selected'); el.classList.add('wrong'); setTimeout(()=>el.classList.remove('wrong'), 400);
                AudioEngine.playSFX('error'); matchState.selected = null; integrity-=1; updateSystemState(); 
                
                // FLASH DAMAGE
                const wrap = document.getElementById('integrity-cont'); 
                wrap.classList.add('damage-flash');
                setTimeout(() => wrap.classList.remove('damage-flash'), 1000); 

                const errs = ["SEG_FAULT", "NaN", "0x00DEAD", "NULL_REF", "BIT_FLIP"]; showFloatText(errs[Math.floor(Math.random()*errs.length)], el, 'red');
            }
        }
    }

    function submitPBQ() {
        const q = window.currentQ;
        let correct = false;
        if(q.type === 'terminal') { if(q.validCommands.includes(document.getElementById('cmd-input').value.trim().toLowerCase())) correct = true; }
        else if (q.type === 'match') { if(matchState.pairsFound === q.pairs.length) correct = true; }
        processResult(correct, document.getElementById('pbq-submit-btn'));
    }

    function processResult(isCorrect, btn) {
        questionsAttempted++;
        document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'none');
        document.getElementById('pbq-submit-btn').style.display = 'none';
        if (isCorrect) {
            questionsCorrect++; btn.classList.add('correct'); currentScore++; integrity += 5;
            AudioEngine.playSFX('success'); showFloatText("ACCEPTED", btn, '#0f0');
        } else {
            btn.classList.add('wrong'); integrity -= 15;
            AudioEngine.playSFX('error'); showFloatText("CORRUPT", btn, '#f00');
            
            // FLASH DAMAGE
            const wrap = document.getElementById('integrity-cont'); 
            wrap.classList.add('damage-flash');
            setTimeout(() => wrap.classList.remove('damage-flash'), 1000); 
        }
        typeExplain(document.getElementById('explanation-box'), ">> " + window.currentQ.explanation);
        updateSystemState(); if (integrity > 0) document.getElementById('next-btn').classList.remove('hidden');
    }

    function nextSeq() { AudioEngine.playSFX('click'); loadSeq(); }
    
    function showFloatText(text, element, color) {
        const floatEl = document.createElement('div'); floatEl.className = 'float-text'; floatEl.innerText = text;
        floatEl.style.color = color; floatEl.style.textShadow = `0 0 10px ${color}`;
        document.body.appendChild(floatEl); 
        const rect = element.getBoundingClientRect();
        floatEl.style.left = (rect.left + rect.width/2 - 20) + 'px'; floatEl.style.top = rect.top + 'px';
        setTimeout(() => floatEl.remove(), 2000);
    }
    
    function showCrypto() {
        AudioEngine.playSFX('success');
        const walletAddress = "kaspa:qqy08j0lcaunrga9pdq29sputscc8v5hjjyjlge93qye9aexejhxv43sq7tyq"; 
        const popup = document.createElement('div');
        // Font explicitly set on container to ensure inheritance, text-shadow removed
        popup.style.cssText = "position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; max-width:500px; background:rgba(0,10,10,0.95); border:2px solid #70c7ba; padding:20px; z-index:9000; text-align:center; box-shadow:0 0 50px rgba(112,199,186,0.3); font-family:'VT323';";
        
        popup.innerHTML = `
            <h2 style="color:#70c7ba; margin:0 0 10px 0; text-shadow: none;">>> KASPA WALLET ADDRESS<<</h2>
            <div style="background:#000; padding:10px; color:#70c7ba; margin-bottom:15px; border:1px dashed #555; word-break:break-all; font-size:1.2rem; text-shadow: none;">${walletAddress}</div>
            <button id="copy-btn" class="sys-btn" style="margin-right:10px; color:#70c7ba; border-color:#70c7ba;">[ COPY ]</button>
            <button id="close-crypto" class="sys-btn" style="color:#ff4444; border-color:#ff4444;">[ CLOSE ]</button>
        `;
        document.body.appendChild(popup);

        // Uses querySelector to find the button inside the newly created popup
        popup.querySelector('#copy-btn').onclick = function() {
            navigator.clipboard.writeText(walletAddress); AudioEngine.playSFX('success'); this.innerText = "[ COPIED ]";
        };
        
        popup.querySelector('#close-crypto').onclick = function() {
             AudioEngine.playSFX('click'); popup.remove();
        };
    }

    function finish() {
        document.getElementById('quiz-ui').classList.add('hidden');
        document.getElementById('results-ui').classList.remove('hidden');
        let pct = 0; if(questionsAttempted > 0) pct = Math.floor((questionsCorrect/questionsAttempted)*100);
        let i = 0; const interval = setInterval(() => {
            document.getElementById('final-percent').innerText = `${i}%`;
            if (i >= pct) clearInterval(interval); i++;
        }, 20);
    }
    
    function shutdownSystem() { location.reload(); }
    
    // ON LOAD INIT
    window.onload = function() {
        typewriterJackpot('intro-title', '[ CORE ONLINE ]');
    };
</script>
</body>
</html>



